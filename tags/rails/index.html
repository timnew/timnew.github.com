<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Label: rails | ThoughtWorkshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="timnew programming code software">
<meta property="og:type" content="website">
<meta property="og:title" content="ThoughtWorkshop">
<meta property="og:url" content="http://timnew.me/tags/rails/index.html">
<meta property="og:site_name" content="ThoughtWorkshop">
<meta property="og:description" content="timnew programming code software">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ThoughtWorkshop">
<meta name="twitter:description" content="timnew programming code software">
<meta name="twitter:creator" content="@timnew">
<link rel="publisher" href="108780866821209050000">
  
    <link rel="alternate" href="/atom.xml" title="ThoughtWorkshop" type="application/atom+xml">
  
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
<link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">

  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30567867-1', 'auto');

  ga('require', 'displayfeatures');

ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ThoughtWorkshop</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Digital Bigs in my thought</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/#main">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/photos/500px.html">Photos</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://timnew.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-manage-configuration-in-rails-way-on-node-js-by-using-inheritance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/" class="article-date">
  <time datetime="2013-02-22T00:00:00.000Z" itemprop="datePublished">2013-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/">Manage configuration in Rails way on node.js by using inheritance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Application is usually required to run in different environments. To manage the differences between the environments, we usually introduce the concept of Environment Specific Configuration.<br>In Rails application, by default, Rails have provided 3 different environments, they are the well known, <code>development</code>, <code>test</code> and <code>production</code>.<br>And we can use the environment variable <code>RAILS_ENV</code> to tell Rails which environment to be loaded, if the <code>RAILS_ENV</code> is not provided, Rails will load the app in <code>development</code> env by default.</p>
<p>This approach is very convenient, so we want to apply it to anywhere. But in node.js, Express doesn’t provide any configuration management. So we need to built the feature by ourselves.</p>
<p>The environment management usually provide the following functionalities:</p>
<ul>
<li>Allow us to provide some configuration values as the default, which will be loaded in all environments, usually we call it <code>common</code>.</li>
<li>Specific configuration will be loaded according to the environment variable, and will override some values in the <code>common</code> if necessary.</li>
</ul>
<p>Rails uses <code>YAML</code> to hold these configurations, which is concise but powerful enough for this purpose. And YAML provided inheritance mechanism by default, so you can reduce the duplication by using inheritance.</p>
<figure class="highlight yaml"><figcaption><span>Inheritance in Rails YAML Configuration</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">development:</span> <span class="meta">&amp;defaults</span></span><br><span class="line"><span class="attr">  adapter:</span> mysql</span><br><span class="line"><span class="attr">  encoding:</span> utf8</span><br><span class="line"><span class="attr">  database:</span> sample_app_development</span><br><span class="line"><span class="attr">  username:</span> root</span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  &lt;&lt;: <span class="meta">*defaults</span></span><br><span class="line"><span class="attr">  database:</span> sample_app_test</span><br><span class="line"></span><br><span class="line"><span class="attr">cucumber:</span></span><br><span class="line">  &lt;&lt;: <span class="meta">*defaults</span></span><br><span class="line"><span class="attr">  database:</span> sample_app_cucumber</span><br><span class="line"></span><br><span class="line"><span class="attr">production:</span></span><br><span class="line">  &lt;&lt;: <span class="meta">*defaults</span></span><br><span class="line"><span class="attr">  database:</span> sample_app_production</span><br><span class="line"><span class="attr">  username:</span> sample_app</span><br><span class="line"><span class="attr">  password:</span> secret_word</span><br><span class="line"><span class="attr">  host:</span> ec2<span class="bullet">-10</span><span class="bullet">-18</span><span class="bullet">-1</span><span class="bullet">-115.</span>us-west<span class="bullet">-2.</span>compute.amazonaws.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In <code>express</code> and <code>node.js</code>, if we follow the same approach, comparing to <code>YAML</code>, we prefer <code>JSON</code>, which is supported natively by <code>Javascript</code>.<br>But to me, <code>JSON</code> isn’t the best option, there are some disadvantages of <code>JSON</code>:</p>
<ul>
<li>JSON Syntax is not concise enough</li>
<li>Matching the brackets and appending commas to the line end are distractions</li>
<li>Lack of flexility</li>
</ul>
<p>As an answer to these issues, I chose <code>coffee-script</code> instead of <code>JSON</code>.<br><code>Coffee</code> is concise. And similar to <code>YAML</code>, <code>coffee</code> uses indention to indicate the nested level. And <code>coffee</code> is executable, which provides a lot of flexibilities to the configuration. So we can implement a Domain Specific Language form</p>
<p>To do it, we need to solve 4 problems:</p>
<ol>
<li>Allow dev to declare default configuration.</li>
<li>Load specific configuration besides of default one.</li>
<li>Specific configuration can overrides the values in the default one.</li>
<li>Code is concise, clean and reading-friendly.</li>
</ol>
<p>Inspired by the YAML solution, I work out my first solution:</p>
<figure class="highlight coffeescript"><figcaption><span>Configuration in coffee script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">_ = <span class="built_in">require</span>(<span class="string">'underscore'</span>)</span><br><span class="line"></span><br><span class="line">config = &#123;&#125;</span><br><span class="line"></span><br><span class="line">config[<span class="string">'common'</span>] =</span><br><span class="line">  adapter: <span class="string">"mysql"</span></span><br><span class="line">  encoding: <span class="string">"utf8"</span></span><br><span class="line">  database: <span class="string">"sample_app_development"</span></span><br><span class="line">  username: <span class="string">"root"</span></span><br><span class="line"></span><br><span class="line">config[<span class="string">'development'</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">config[<span class="string">'test] =</span><br><span class="line">  database:"sample_app_test"</span><br><span class="line"></span><br><span class="line">config['</span>cucumber<span class="string">'] =</span><br><span class="line">  database:"sample_app_cucumber"</span><br><span class="line"></span><br><span class="line">config['</span>production<span class="string">'] =</span><br><span class="line">  database:"sample_app_production"</span><br><span class="line">  username:"sample_app"</span><br><span class="line">  password:"secret_word"</span><br><span class="line">  host:"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</span><br><span class="line"></span><br><span class="line">_.extend exports, config.common</span><br><span class="line"></span><br><span class="line">specificConfig = config[process.env.NODE_ENV ?'</span>development<span class="string">']</span><br><span class="line"></span><br><span class="line">if specificConfig?</span><br><span class="line">  _.extend exports, specificConfig</span><br><span class="line"></span></span><br></pre></td></tr></table></figure>
<p><code>YAML</code> is data centric language, so its inheritance is more like “mixin” another piece of data. So I uses <code>underscore</code> to help me to mixin the specific configuration over the default one, which overrides the overlapped values.</p>
<p>But if we jump out of the YAML’s box, let us think about the <code>Javascript</code> itself, Javascript is a prototype language, which means it had already provide an overriding mechanism natively. Each object inherits and overrides the value from its prototype.<br>So I worked out the 2nd solution:</p>
<figure class="highlight coffeescript"><figcaption><span>Prototype based Configuration</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">config = &#123;&#125;</span><br><span class="line"></span><br><span class="line">config[<span class="string">'common'</span>] =</span><br><span class="line">  adapter: <span class="string">"mysql"</span></span><br><span class="line">  encoding: <span class="string">"utf8"</span></span><br><span class="line">  database: <span class="string">"sample_app_development"</span></span><br><span class="line">  username: <span class="string">"root"</span></span><br><span class="line"></span><br><span class="line">config[<span class="string">'development'</span>] = &#123;&#125;</span><br><span class="line">config[<span class="string">'development'</span>].__proto__ = config[<span class="string">'common'</span>]</span><br><span class="line"></span><br><span class="line">config[<span class="string">'test] =</span><br><span class="line">  __proto__: config['</span>common<span class="string">']</span><br><span class="line">  database:"sample_app_test"</span><br><span class="line"></span><br><span class="line">config['</span>cucumber<span class="string">'] =</span><br><span class="line">  __proto__: config['</span>test<span class="string">']</span><br><span class="line">  database:"sample_app_cucumber"</span><br><span class="line"></span><br><span class="line">config['</span>production<span class="string">'] =</span><br><span class="line">  __proto__: config['</span>common<span class="string">']</span><br><span class="line">  database:"sample_app_production"</span><br><span class="line">  username:"sample_app"</span><br><span class="line">  password:"secret_word"</span><br><span class="line">  host:"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</span><br><span class="line"></span><br><span class="line">process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ?'</span>development<span class="string">'</span><br><span class="line"></span><br><span class="line">module.exports = config[process.env.NODE_ENV]</span><br><span class="line"></span></span><br></pre></td></tr></table></figure>
<p>This approach works, but looks kind of ugly. Since we’re using <code>coffee</code>, which provides the syntax sugar for class and class inheritance.<br>So we have the 3rd version:</p>
<figure class="highlight coffeescript"><figcaption><span>Class based configuration</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ? <span class="string">'development'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span></span></span><br><span class="line">  adapter: <span class="string">"mysql"</span></span><br><span class="line">  encoding: <span class="string">"utf8"</span></span><br><span class="line">  database: <span class="string">"sample_app_development"</span></span><br><span class="line">  username: <span class="string">"root"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">development</span> <span class="keyword">extends</span> <span class="title">Config</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">test</span> <span class="keyword">extends</span> <span class="title">Config</span></span></span><br><span class="line">  database: <span class="string">"sample_app_test"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">cucumber</span> <span class="keyword">extends</span> <span class="title">Config</span></span></span><br><span class="line">  database: <span class="string">"sample_app_cucumber"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">common</span> <span class="keyword">extends</span> <span class="title">Config</span></span></span><br><span class="line">  database: <span class="string">"sample_app_production"</span></span><br><span class="line">  username: <span class="string">"sample_app"</span></span><br><span class="line">  password: <span class="string">"secret_word"</span></span><br><span class="line">  host: <span class="string">"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> Config[process.env.NODE_ENV]()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Now the code looks clean, and we can improve it a step further if necessary. We can try to separate the configurations into files, and required by the file name:</p>
<figure class="highlight coffeescript"><figcaption><span>Class based configuration</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># config/config.coffee</span></span><br><span class="line">configName = process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ? <span class="string">'development'</span></span><br><span class="line"></span><br><span class="line">SpecificConfig  = requrie(<span class="string">"./envs/<span class="subst">#&#123;configName&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> SpecificConfig()</span><br><span class="line"></span><br><span class="line"><span class="comment"># config/envs/commmon.coffee</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Common</span></span></span><br><span class="line">  adapter: <span class="string">"mysql"</span></span><br><span class="line">  encoding: <span class="string">"utf8"</span></span><br><span class="line">  database: <span class="string">"sample_app_development"</span></span><br><span class="line">  username: <span class="string">"root"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Common</span><br><span class="line"></span><br><span class="line"><span class="comment"># config/envs/development.coffee</span></span><br><span class="line">Common = <span class="built_in">require</span>(<span class="string">'./common'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Development</span> <span class="keyword">extends</span> <span class="title">Common</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Development</span><br><span class="line"></span><br><span class="line"><span class="comment"># config/envs/test.coffee</span></span><br><span class="line">Common = <span class="built_in">require</span>(<span class="string">'./common'</span>)  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">Common</span></span></span><br><span class="line">  database: <span class="string">"sample_app_test"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Test</span><br><span class="line"></span><br><span class="line"><span class="comment"># config/envs/cucumber.coffee</span></span><br><span class="line">Test = <span class="built_in">require</span>(<span class="string">'./common'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cucumber</span> <span class="keyword">extends</span> <span class="title">Test</span></span></span><br><span class="line">  database: <span class="string">"sample_app_cucumber"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Cucumber</span><br><span class="line"></span><br><span class="line"><span class="comment"># config/envs/production.coffee</span></span><br><span class="line">Common = <span class="built_in">require</span>(<span class="string">'./common'</span>)  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Production</span> <span class="keyword">extends</span> <span class="title">Common</span></span></span><br><span class="line">  database: <span class="string">"sample_app_production"</span></span><br><span class="line">  username: <span class="string">"sample_app"</span></span><br><span class="line">  password: <span class="string">"secret_word"</span></span><br><span class="line">  host: <span class="string">"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Production</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/" data-id="cineg3i94004fy7sijz1jgtpu" class="article-share-link">Delen</a>
      
        <a href="http://timnew.me/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/#disqus_thread" class="article-comment-link">Commentaren</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/configuration/">configuration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/environment/">environment</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inheritance/">inheritance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scheme/">scheme</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pitfall-when-return-string-in-via-json-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/" class="article-date">
  <time datetime="2012-08-15T00:00:00.000Z" itemprop="datePublished">2012-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/">pitfall when return string in via json in rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today we met a weird problem when return a string via json.</p>
<p>Here is the coffee script code:</p>
<figure class="highlight coffeescript"><figcaption><span>Front End</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$.post serverUrl, data, <span class="function"><span class="params">(status)</span> -&gt;</span></span><br><span class="line">	<span class="built_in">console</span>.log status</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>And here is our controller:</p>
<figure class="highlight ruby"><figcaption><span>Backend Action</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span></span></span><br><span class="line">	<span class="comment"># do some complex logic</span></span><br><span class="line"></span><br><span class="line">	render <span class="symbol">json:</span> <span class="string">"success"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Code looks perfect, but we found that the callback is never called! When we check the network traffic, you will found that server does send its response “success”, but the callback is not called!</p>
<p>After spending half an hour to struggle against the jQuery, we finally find the problem!</p>
<p>The reason is that <code>success</code> is not a valid json data! A valid json string should be quoted with “”, or JSON parser will treat it as token, like true or false or nil.</p>
<p>So to fix the problem, we need to change our action code:</p>
<figure class="highlight ruby"><figcaption><span>Fixed Backend Action</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span></span></span><br><span class="line">	<span class="comment"># do some complex logic</span></span><br><span class="line"></span><br><span class="line">	render <span class="symbol">json:</span> <span class="string">'"success"'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This is really a pitfall, since the wrong code looks so nature!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/" data-id="cineg3i8i003fy7sid00b1fwh" class="article-share-link">Delen</a>
      
        <a href="http://timnew.me/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/#disqus_thread" class="article-comment-link">Commentaren</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/json/">json</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pretty-singleton-in-ror-app" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/05/pretty-singleton-in-ror-app/" class="article-date">
  <time datetime="2012-08-05T00:00:00.000Z" itemprop="datePublished">2012-08-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/05/pretty-singleton-in-ror-app/">Pretty Singleton in RoR app</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Thanks to Ruby powerful meta programming capability and Rails <code>delegate</code> syntax, we can easily write graceful singleton class which makes the class works like a instance.</p>
<p>In traditional language such as C#, usually we write singleton code like this:</p>
<figure class="highlight c"><figcaption><span>Singleton in C##</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Foo</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Singleton Declaration</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> readonly Foo instance;</span><br><span class="line">	pubilc <span class="keyword">static</span> Foo Instance</span><br><span class="line">	&#123;</span><br><span class="line">		get</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(instance == null)</span><br><span class="line">			&#123;</span><br><span class="line">				instance = new Foo();</span><br><span class="line">			&#125;</span><br><span class="line">			return instance;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Define instance behaviors</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The previous approach works fine but the code that uses <code>Foo</code> will be kind of ugly. Every time when we want to invoke the method <code>Bar</code> on <code>Foo</code>, we need to write <code>Foo.Instance.Bar()</code> rather than more graceful way <code>Foo.Bar()</code>.<br>To solve this problem we need implement the class in this way:</p>
<figure class="highlight c"><figcaption><span>Class Delegation in C##</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> Foo</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Singleton Declaration</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Define instance behaviors</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Bar</span><span class="params">()</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// Bar behaviors</span></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Bar</span><span class="params">()</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		Instance.Bar();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> Baz</span><br><span class="line">	&#123;</span><br><span class="line">		get &#123; <span class="comment">/* Getter behavior */</span>	&#125;</span><br><span class="line">		<span class="built_in">set</span> &#123; <span class="comment">/* Setter behavior */</span>	&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> Baz</span><br><span class="line">	&#123;</span><br><span class="line">		get &#123; return Instance.Baz;	&#125;</span><br><span class="line">		<span class="built_in">set</span> &#123; Instance.Baz = value;	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This approach simplified the caller code but complicated the declaration. You can use some trick such as Code-Snippet or code generating technology such as Text Template or CodeSmith to generate the dull delegation code. But it is still not graceful at all.</p>
<p>If we write same code in ruby, things become much easier, great thanks to Ruby’s powerful meta programming capability.</p>
<figure class="highlight ruby"><figcaption><span>Singleton in Ruby</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># foo.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line">	extend ActiveSupport::Autoload</span><br><span class="line"></span><br><span class="line">	autoload <span class="symbol">:Base</span></span><br><span class="line">	<span class="keyword">include</span> Base</span><br><span class="line"></span><br><span class="line">	autoload <span class="symbol">:ClassMethods</span></span><br><span class="line">	extend ClassMethods</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo/base.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo::Base</span></span></span><br><span class="line">	<span class="comment"># Define instance behaviors</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo/class_methods.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo::ClassMethods</span></span></span><br><span class="line">	<span class="comment"># Singleton Declaration</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">instance</span></span></span><br><span class="line">		@instance <span class="params">||</span>= new</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	delegate *Foo::Base.instance_methods, <span class="symbol">:to</span> =&gt; <span class="symbol">:instance</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>So in ruby solution we just use one statement <code>delegate *Foo::Base.instance_methods, :to =&gt; :instance</code> then delegate all methods defined in base to instance.</p>
<p>Besides this solution, there is also another kind of cheaper but working solution:<br><figure class="highlight ruby"><figcaption><span>Singleton in Ruby</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># foo.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"></span><br><span class="line">	autoload <span class="symbol">:Base</span></span><br><span class="line">	<span class="keyword">include</span> Base</span><br><span class="line">	extend Base</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo/base.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo::Base</span></span></span><br><span class="line">	<span class="comment"># Define instance behaviors</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>Two different approaches make the code behaves slightly different, but anyway they both works.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/05/pretty-singleton-in-ror-app/" data-id="cineg3i8e003dy7sis6c8k1xl" class="article-share-link">Delen</a>
      
        <a href="http://timnew.me/blog/2012/08/05/pretty-singleton-in-ror-app/#disqus_thread" class="article-comment-link">Commentaren</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pattern/">pattern</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sigleton/">sigleton</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-postgres-multiple-schema-database-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/" class="article-date">
  <time datetime="2012-07-17T00:00:00.000Z" itemprop="datePublished">2012-07-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/">Use Postgres Multiple Schema Database in Rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Postgres provided a very interesting feature called “Schema” in addition to other “normal” database features, which provide a extra layer between database and tables. So with schema, you can have tables with same name in one database, if they are in different schemas.<br>To me schema is not a good idea! I assume “table-space” or even “namespace” could be a better name. In fact, there are a number of people agree that schema is not a good name:<br><blockquote><p>“Schema” is such a terrible name for this feature. When most people hear the term “schema” they think of a data definition of some sort. This is not what PostgreSQL schemas are. I’m sure the PostgreSQL devs had their reasons, but I really wish they would have named it more appropriately. “Namespaces” would have been apropos.</p>
<p>Anywho, the easiest way for me to describe PostgreSQL schemas (besides telling you that they are, indeed, namespaces for tables) is to relate them to the UNIX execution path. When you run a UNIX command without specifying its absolute path, your shell will work its way down the $PATH until it finds an executable of the same name.</p>
<footer><strong>Jerod Santo</strong><cite><a href="http://blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas/" target="_blank" rel="external">blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas</a></cite></footer></blockquote><br>And you can find more <a href="http://goo.gl/ghj4e" target="_blank" rel="external">here</a></p>
<p>And there is a popular routine is to use the postgres schema for sub-domains. For example, you’re a BSS provider, you rend your BBS apps to different organizations. To the organizations. they want to have its own BBS app instance running independently, the most important is that data should be stored into separated spaces, and could be accessed from its own domain name. But to you, for administration, you want they share the same backend management console.<br>In this case the best way to solve the problem is to store the data owned by different subsystem into different schemas. But store all the administration data into a single schema or even in public schema.<br>The same guy Jerod has a <a href="http://blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas/" target="_blank" rel="external">post</a> described how to build this kind of system in details. There are a bunch of posts described how to build the system like this, which could be found by <a href="http://goo.gl/HaByF" target="_blank" rel="external">googling</a> easily.<br>And there is even a <a href="https://github.com/bradrobertson/apartment" target="_blank" rel="external">ruby gem called apartment</a> from Brad Robertson to support this kind of system</p>
<p>This idea looks fancy, but unless you 10000% certain that the sub-systems will keep its independent status and without any collaboration forever.<br>Or it sooner or later, you will find the “fancy idea” become a horrible idea.<br>When time goes by, there could be more and more and more features that required to add collaboration between sub-systems. Such as provide a unified authentication mechanism, so user can logged in once and switch between different systems easily. Or administrator might ask for a unified statistics graph for all sub-systems.<br>All these requirements are related to cross-schema query! To be honest, cross query in some cases could be painful!<br>And it brings trouble to all aspects in your system, such as data migration, test data generation, etc.</p>
<p>That’s what exactly happens in my current project!<br>My current project is Rails 3 project, the codebase is brand new but built on a legacy multiple schema postgres database. And for some reason,<br>we must keep the multiple schema design unchanged. But our goal is to unify the separated subsystem into a more closed-collaborated system.</p>
<p>Since ActiveRecord in Rails doesn’t include the native support to this fancy feature. Which means you will met problem during migration, or even preparing test data with factory-girl.</p>
<p>Postgres allows to locate the table in different schemas with full qualified name like this <code>&lt;schema name&gt;.&lt;table name&gt;.&lt;column name&gt;</code>. The schema name is optional, when you omitted the schema name, Postgres will search the table in a file-system-path-like order called “<a href="http://www.postgresql.org/docs/8.1/static/ddl-schemas.html#DDL-SCHEMAS-PUBLIC" target="_blank" rel="external">search-path</a>“.</p>
<p>And you can set and query current search path with Postgres SQL statements:</p>
<figure class="highlight sql"><figcaption><span>Query and Set search_path</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> search_path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> search_path <span class="keyword">TO</span> &lt;new_search_path&gt;;</span><br></pre></td></tr></table></figure>
<p>Since ActiveRecord won’t add the full qualified schema name in front of the table name when it translate the ARel into SQL statements. So we can only support the multiple schema database with the search_path.</p>
<p>Basically, it is a very natural idea that you can use the following ruby code to make ActiveRecord make query on different schemas:</p>
<figure class="highlight ruby"><figcaption><span>Select Schema</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_schema_to_search_path</span><span class="params">(schema)</span></span></span><br><span class="line">  ActiveRecord::Base.connection.execute <span class="string">"SET search_path TO <span class="subst">#&#123;schema&#125;</span>, public;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restore_search_path</span></span></span><br><span class="line">  ActiveRecord::Base.connection.execute <span class="string">"SET search_path TO public;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This two methods work perfect when querying things from the database. But sooner or later, you will run into big trouble when you try to write data into database.</p>
<p>In db migration or use factory_girl to generate test fixtures, you might found that the data you insert in different schemas finally goes into <strong>the first non-public schema</strong>. But all the query still works perfect!</p>
<p>We found this problem occurs when the following conditions are satisfied:</p>
<ol>
<li>Query are happened in a Transaction.</li>
<li>You insert data into multiple non-public schemas.</li>
<li>You user <code>SET search_path TO</code> SQL statement to switch between schema rather than explicitly using full-qualified table name.</li>
</ol>
<p>And the most interesting thing is that:</p>
<ol>
<li>All the <code>SELECT</code> queries are executed on schemas correctly</li>
<li>If you use <code>SHOW search_path;</code> to query current search path, you will got correct search path value.</li>
<li>All data are inserted into first <code>non-public</code> schema that you actually wrote data into. So which means it you try to insert data into public schema, it won’t go wrong. Or you switched to a non-public schema, but actually you doesn’t insert any rows, it also won’t be impacted.</li>
</ol>
<p>To solve this problem, I spent 2 nights and 2 days to digged into the source code of ActiveRecord gem and pg gem (the Postgres database adapter).<br>And finally I solved the problem by using the attribute on PostgreSQLAdapter.</p>
<p>Basically, instead of using the SQL query, you should use the <code>PostgreSQLAdapter#schema_search_path</code> and <code>PostgreSQLAdapter#schema_search_path=</code> to get and set the search path.<br>And if you dig into the source code, you will find the two methods does the exact same thing as we did except it assigned one more instance variable <code>@schema_search_path</code>.</p>
<figure class="highlight ruby"><figcaption><span>methods on PostgreSQLAdapter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Sets the schema search path to a string of comma-separated schema names.</span></span><br><span class="line"><span class="comment"># Names beginning with $ have to be quoted (e.g. $user =&gt; '$user').</span></span><br><span class="line"><span class="comment"># See: http://www.postgresql.org/docs/current/static/ddl-schemas.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This should be not be called manually but set in database.yml.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schema_search_path=</span><span class="params">(schema_csv)</span></span></span><br><span class="line">  <span class="keyword">if</span> schema_csv</span><br><span class="line">    execute(<span class="string">"SET search_path TO <span class="subst">#&#123;schema_csv&#125;</span>"</span>, <span class="string">'SCHEMA'</span>)</span><br><span class="line">    @schema_search_path = schema_csv</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Returns the active schema search path.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schema_search_path</span></span></span><br><span class="line">  @schema_search_path <span class="params">||</span>= query(<span class="string">'SHOW search_path'</span>, <span class="string">'SCHEMA'</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The most interesting thing is if you search the reference to <code>@schema_search_path</code>, you will find it is only used as a local cache of current search_path in the adapter, and it is initialized with the value from the query <code>SHOW search_path;</code> if it is nil, and then keep the value as the cache!<br>This implementation is buggy and caused the problems described before!</p>
<p>If we use the SQL query to set the search path rather than calling <code>schema_search_path=</code>, we won’t set the <code>@schema_search_path</code> at sametime, ideally this value will remain nil by default. Then transaction or other object in ActiveRecord call <code>schema_search_path</code> to get current search path. The first time, the variable <code>@@schema_search_path</code> is nil, and will be initialized by the value from query <code>SHOW search_path;</code> and then won’t changed any more, since in the future this query won’t be executed any longer.<br>As a result, the schema will be switched successfully for the first time, but failed in the following.</p>
<p>Which means at current stage, if you want to change search_path, the only correct way is to use <code>PostgreSQLAdapter#schema_search_path=</code>, and PLEASE PLEASE ignore the warning <code>&quot;This should be not be called manually but set in database.yml.&quot;</code> in the source code! It is really a misleading message!</p>
<p>I understand current implementation is for performance consideration, but caching the value is absolutely not a good idea when you cannot keep things in sync and the sync is critical in some cases.<br>I’m planning to fix this issue in rails codebase and create a pull request to rails maintainer. Wish they could accept this fix. Or at least they should change the warning message.</p>
<p>And besides of using the out-dated and mysterious PgTools mentioned in a lot of posts (I saw a lot of people mentioned this class, but I cannot find it anywhere even I from google or github. It is really a mystery). I create a new utility module called MultiSchema.</p>
<script src="//gist.github.com/3129392.js"></script>
<p>You can use it as the utility class in the old-fashioned way:</p>
<figure class="highlight ruby"><figcaption><span>Procedure usage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MultiSchema.with_in_schemas <span class="symbol">:except</span> =&gt; <span class="symbol">:public</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Play around the data in one schema</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Or you can use it in a DSL-like way:</p>
<figure class="highlight ruby"><figcaption><span>DSL usage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeMigration</span> &lt; ActiveRecord::Migration</span></span><br><span class="line"><span class="keyword">include</span> MultiSchema</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    with_in_schemas <span class="symbol">:except</span> =&gt; <span class="symbol">:public</span> <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># Play around the data in one schema</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>with_in_schemas</code> method accept both <code>symbol</code> and <code>string</code>, and you can pass single value, array or hash to it.</p>
<ul>
<li><code>with_in_schemas</code> yield all user schemas in the database</li>
<li><code>with_in_schemas :only =&gt; %w(schema1 schema2)</code> populates all given schemas.</li>
<li><code>with_in_schemas :except =&gt; %w(schema1 schema2)</code> populates all except given schemas.</li>
<li><code>with_in_schemas :except =&gt; [:public]</code> is equivalent to <code>with_in_schemas :except =&gt; [&#39;public&#39;]</code></li>
<li><code>with_in_schemas :only =&gt; [:public]</code> is equivalent to <code>with_in_schemas :only =&gt; :public</code> and equivalent to <code>with_in_schemas :public</code></li>
<li><code>with_in_schemas :except =&gt; [:public]</code> is equivalent to <code>with_in_schemas :except =&gt; :public</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/" data-id="cineg3i870031y7si9wio1if9" class="article-share-link">Delen</a>
      
        <a href="http://timnew.me/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/#disqus_thread" class="article-comment-link">Commentaren</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/active-record/">active record</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multischema/">multischema</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgres/">postgres</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/schema/">schema</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-name-trap-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/06/02/name-trap-in-rails/" class="article-date">
  <time datetime="2012-06-02T00:00:00.000Z" itemprop="datePublished">2012-06-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/06/02/name-trap-in-rails/">Name trap in Rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m a newbie to Rails, and my past few projects are all rails based, including MetaPaas, Recruiting On Rails and current SFP.<br>I was amazed by the convenience of Rails, and also hurt by its “smartness”.<br>The power of Rails was described in quite a lot of posts, so I wanna to share some failure experiences.<br>Actually I have felt into quite a number of pitfalls in Rails, and here is one of the most painful ones.</p>
<p>To explain the problem easier, I just simplify the scenario:<br>I have a model called “Candidate”, which holds a “Status” to store the status of the candidate, so I have the code like this:</p>
<figure class="highlight ruby"><figcaption><span>Candidate and Status</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Candidate</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	has_one status</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Status</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	belongs_to candidate</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>For some reason, I change the relationship between Candidate and Status. It is changed from one-to-one to one-to-many.<br>So I changed the <code>has_one</code> to <code>has_many</code>:</p>
<figure class="highlight ruby"><figcaption><span>Candidate and Status</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Candidate</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	has_many status</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Status</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	belongs_to candidate</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>I thought it is an easy modification, but the app fails to run, even I have done the database migration.<br>It said rails cannot find a constant named “Statu”!</p>
<p>After my first sight on this error message, I believed it is caused by a typo, I must mistyped “Status” as “Statu”.<br>So I full-text search the whole project for “Statu”, but I cannot find any.</p>
<p>This error message is quite weird to me, since I have no idea about where the word “Statu” come from!<br>After spent half an hour on pointless trying, I suddenly noticed that the word “status” is end with “s”, and according to Rails’ convention, rails must think “status” is the plural form of “statu”. So according to the convention again, it try to find a class named “Statu”.<br>And we should use the plural form noun as name for one-to-many field, since that holds an array rather than a single object.</p>
<p>So after changing <code>status</code> to <code>statuses</code>, the problem solved.</p>
<p>Convention based system is powerful, a lot magic just happened there. But also the magic things are hard to debug when some special case breaks the convention presumption.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/06/02/name-trap-in-rails/" data-id="cineg3i7y002oy7sin4jg9s0q" class="article-share-link">Delen</a>
      
        <a href="http://timnew.me/blog/2012/06/02/name-trap-in-rails/#disqus_thread" class="article-comment-link">Commentaren</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/active-model/">active model</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/convention/">convention</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/error/">error</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/name/">name</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trap/">trap</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap"><h3 class="widget-title">About Me</h3><div class="widget self-intro"><img src="/images/avatar.png"/><p>Tim is</p><ul class="description"><li>a<span>geek</span></li><li>an spare-time<span>web developer</span></li><li>a part-time<span>mobile developer</span></li><li>a night-time<span>photographer</span></li><li>an early-time<span>pcb solderer</span></li></ul><ul class="social-links"><li><a href="https://linkedin.com/in/timwen" target="_blank" class="linked-in"></a></li><li><a href="https://twitter.com/timnew" target="_blank" class="twitter"></a></li><li><a href="https://github.com/timnew" target="_blank" class="github"></a></li></ul></div></div>
  
    
  <div class="widget-wrap">
    <a href="/posts">
      <h3 class="widget-title">Recente berichten</h3>
    </a>
    <div class="widget recent-posts">
      <ul>
        
          <li>
            <a href="/blog/2016/04/23/collection-filtering-algorithm-with-bit-operation-part-1/">Collection Filtering Algorithm with Bit Operation - Part.1</a>
          </li>
        
          <li>
            <a href="/blog/2015/08/14/a-clean-way-to-test-rejected-promise/">A clean way to test rejected promise</a>
          </li>
        
          <li>
            <a href="/blog/2014/12/06/typical-eventbus-design-patterns/">Typical EventBus Design Patterns</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/09/understand-styles-in-android-part-1-what-it-is-for-and-how-to-used-it/">Understand Styles in Android - Part 1. What it is for and how to used it</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/07/walkthrough-untrusted-the-continuing-adventures-of-dr-eval/">Walkthrough: Untrusted - the Continuing Adventures of Dr. Eval</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/tags">
      <h3 class="widget-title">Tag Cloud</h3>
    </a>
    <div class="widget tagcloud">
      <a href="/tags/net/" style="font-size: 10px;">.net</a> <a href="/tags/alfred/" style="font-size: 10px;">Alfred</a> <a href="/tags/algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/android-studio/" style="font-size: 10px;">Android Studio</a> <a href="/tags/automation/" style="font-size: 10px;">Automation</a> <a href="/tags/binary/" style="font-size: 10px;">Binary</a> <a href="/tags/bit-operation/" style="font-size: 10px;">Bit Operation</a> <a href="/tags/bit-slicer/" style="font-size: 10px;">Bit Slicer</a> <a href="/tags/bloom-filter/" style="font-size: 10px;">Bloom Filter</a> <a href="/tags/boilerplate/" style="font-size: 10px;">Boilerplate</a> <a href="/tags/c/" style="font-size: 20px;">C#</a> <a href="/tags/ci/" style="font-size: 15px;">CI</a> <a href="/tags/css/" style="font-size: 10px;">CSS</a> <a href="/tags/cheat/" style="font-size: 10px;">Cheat</a> <a href="/tags/cheat-engine/" style="font-size: 10px;">Cheat Engine</a> <a href="/tags/class/" style="font-size: 10px;">Class</a> <a href="/tags/cocoa/" style="font-size: 10px;">Cocoa</a> <a href="/tags/collection/" style="font-size: 10px;">Collection</a> <a href="/tags/command/" style="font-size: 10px;">Command</a> <a href="/tags/continues-delivery/" style="font-size: 10px;">Continues Delivery</a> <a href="/tags/continues-integration/" style="font-size: 10px;">Continues Integration</a> <a href="/tags/crack/" style="font-size: 10px;">Crack</a> <a href="/tags/d/" style="font-size: 10px;">D</a> <a href="/tags/debugger/" style="font-size: 10px;">Debugger</a> <a href="/tags/deploy/" style="font-size: 10px;">Deploy</a> <a href="/tags/deployment/" style="font-size: 10px;">Deployment</a> <a href="/tags/design/" style="font-size: 10px;">Design</a> <a href="/tags/design-pattern/" style="font-size: 10px;">Design Pattern</a> <a href="/tags/event/" style="font-size: 10px;">Event</a>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/categories">
      <h3 class="widget-title">Categorieën</h3>
    </a>
    <div class="widget category-list">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/">Cracking</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/game/">Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/">Design</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/design/visual/">Visual</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/web/">Web</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/game/">Game</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/game/programming-game/">Programming Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/geek-toy/">Geek Toy</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/">Package</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/package/chrome-extension/">Chrome Extension</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/hexo/">Hexo</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/">Practice</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/practice/atom/">Atom</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/continues-integration/">Continues Integration</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/devops/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/mac/">Mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/textmate/">TextMate</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/windows/">Windows</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/git/">git</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">Programming</a><span class="category-list-count">73</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/algorithm/">Algorithm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/android/">Android</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/arduino/">Arduino</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/c/">C#</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/design-patterns/">Design Patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/">JavaScript</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/coffeescript/">CoffeeScript</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/postgressql/">PostgresSql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/powershell/">PowerShell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/regular-expression/">Regular Expression</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/ruby/">Ruby</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/shell/">Shell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/wpf/">WPF</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/web/">Web</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/node-js/">node.js</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/thinking/">Thinking</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/archives">
      <h3 class="widget-title">Archieven</h3>
    </a>
    <div class="widget archive-list">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 TimNew<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/#main" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/photos/500px.html" class="mobile-nav-link">Photos</a>
  
</nav>
    
<script>
  var disqus_shortname = 'timnew-github';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>