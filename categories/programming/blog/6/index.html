<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Catégorie: Programming | ThoughtWorkshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="timnew programming code software">
<meta property="og:type" content="website">
<meta property="og:title" content="ThoughtWorkshop">
<meta property="og:url" content="http://timnew.me/categories/programming/blog/6/index.html">
<meta property="og:site_name" content="ThoughtWorkshop">
<meta property="og:description" content="timnew programming code software">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ThoughtWorkshop">
<meta name="twitter:description" content="timnew programming code software">
<meta name="twitter:creator" content="@timnew">
<link rel="publisher" href="108780866821209050000">
  
    <link rel="alternate" href="/atom.xml" title="ThoughtWorkshop" type="application/atom+xml">
  
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
<link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">

  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30567867-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ThoughtWorkshop</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Digital Bigs in my thought</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/#main">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/photos/500px.html">Photos</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://timnew.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-use-postgres-multiple-schema-database-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/" class="article-date">
  <time datetime="2012-07-17T00:00:00.000Z" itemprop="datePublished">2012-07-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/">Use Postgres Multiple Schema Database in Rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Postgres provided a very interesting feature called “Schema” in addition to other “normal” database features, which provide a extra layer between database and tables. So with schema, you can have tables with same name in one database, if they are in different schemas.<br>To me schema is not a good idea! I assume “table-space” or even “namespace” could be a better name. In fact, there are a number of people agree that schema is not a good name:<br><blockquote><p>“Schema” is such a terrible name for this feature. When most people hear the term “schema” they think of a data definition of some sort. This is not what PostgreSQL schemas are. I’m sure the PostgreSQL devs had their reasons, but I really wish they would have named it more appropriately. “Namespaces” would have been apropos.</p>
<p>Anywho, the easiest way for me to describe PostgreSQL schemas (besides telling you that they are, indeed, namespaces for tables) is to relate them to the UNIX execution path. When you run a UNIX command without specifying its absolute path, your shell will work its way down the $PATH until it finds an executable of the same name.</p>
<footer><strong>Jerod Santo</strong><cite><a href="http://blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas/" target="_blank" rel="external">blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas</a></cite></footer></blockquote><br>And you can find more <a href="http://goo.gl/ghj4e" target="_blank" rel="external">here</a></p>
<p>And there is a popular routine is to use the postgres schema for sub-domains. For example, you’re a BSS provider, you rend your BBS apps to different organizations. To the organizations. they want to have its own BBS app instance running independently, the most important is that data should be stored into separated spaces, and could be accessed from its own domain name. But to you, for administration, you want they share the same backend management console.<br>In this case the best way to solve the problem is to store the data owned by different subsystem into different schemas. But store all the administration data into a single schema or even in public schema.<br>The same guy Jerod has a <a href="http://blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas/" target="_blank" rel="external">post</a> described how to build this kind of system in details. There are a bunch of posts described how to build the system like this, which could be found by <a href="http://goo.gl/HaByF" target="_blank" rel="external">googling</a> easily.<br>And there is even a <a href="https://github.com/bradrobertson/apartment" target="_blank" rel="external">ruby gem called apartment</a> from Brad Robertson to support this kind of system</p>
<p>This idea looks fancy, but unless you 10000% certain that the sub-systems will keep its independent status and without any collaboration forever.<br>Or it sooner or later, you will find the “fancy idea” become a horrible idea.<br>When time goes by, there could be more and more and more features that required to add collaboration between sub-systems. Such as provide a unified authentication mechanism, so user can logged in once and switch between different systems easily. Or administrator might ask for a unified statistics graph for all sub-systems.<br>All these requirements are related to cross-schema query! To be honest, cross query in some cases could be painful!<br>And it brings trouble to all aspects in your system, such as data migration, test data generation, etc.</p>
<p>That’s what exactly happens in my current project!<br>My current project is Rails 3 project, the codebase is brand new but built on a legacy multiple schema postgres database. And for some reason,<br>we must keep the multiple schema design unchanged. But our goal is to unify the separated subsystem into a more closed-collaborated system.</p>
<p>Since ActiveRecord in Rails doesn’t include the native support to this fancy feature. Which means you will met problem during migration, or even preparing test data with factory-girl.</p>
<p>Postgres allows to locate the table in different schemas with full qualified name like this <code>&lt;schema name&gt;.&lt;table name&gt;.&lt;column name&gt;</code>. The schema name is optional, when you omitted the schema name, Postgres will search the table in a file-system-path-like order called “<a href="http://www.postgresql.org/docs/8.1/static/ddl-schemas.html#DDL-SCHEMAS-PUBLIC" target="_blank" rel="external">search-path</a>“.</p>
<p>And you can set and query current search path with Postgres SQL statements:</p>
<figure class="highlight sql"><figcaption><span>Query and Set search_path</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> search_path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> search_path <span class="keyword">TO</span> &lt;new_search_path&gt;;</span><br></pre></td></tr></table></figure>
<p>Since ActiveRecord won’t add the full qualified schema name in front of the table name when it translate the ARel into SQL statements. So we can only support the multiple schema database with the search_path.</p>
<p>Basically, it is a very natural idea that you can use the following ruby code to make ActiveRecord make query on different schemas:</p>
<figure class="highlight ruby"><figcaption><span>Select Schema</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_schema_to_search_path</span><span class="params">(schema)</span></span></span><br><span class="line">  ActiveRecord::Base.connection.execute <span class="string">"SET search_path TO <span class="subst">#&#123;schema&#125;</span>, public;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restore_search_path</span></span></span><br><span class="line">  ActiveRecord::Base.connection.execute <span class="string">"SET search_path TO public;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This two methods work perfect when querying things from the database. But sooner or later, you will run into big trouble when you try to write data into database.</p>
<p>In db migration or use factory_girl to generate test fixtures, you might found that the data you insert in different schemas finally goes into <strong>the first non-public schema</strong>. But all the query still works perfect!</p>
<p>We found this problem occurs when the following conditions are satisfied:</p>
<ol>
<li>Query are happened in a Transaction.</li>
<li>You insert data into multiple non-public schemas.</li>
<li>You user <code>SET search_path TO</code> SQL statement to switch between schema rather than explicitly using full-qualified table name.</li>
</ol>
<p>And the most interesting thing is that:</p>
<ol>
<li>All the <code>SELECT</code> queries are executed on schemas correctly</li>
<li>If you use <code>SHOW search_path;</code> to query current search path, you will got correct search path value.</li>
<li>All data are inserted into first <code>non-public</code> schema that you actually wrote data into. So which means it you try to insert data into public schema, it won’t go wrong. Or you switched to a non-public schema, but actually you doesn’t insert any rows, it also won’t be impacted.</li>
</ol>
<p>To solve this problem, I spent 2 nights and 2 days to digged into the source code of ActiveRecord gem and pg gem (the Postgres database adapter).<br>And finally I solved the problem by using the attribute on PostgreSQLAdapter.</p>
<p>Basically, instead of using the SQL query, you should use the <code>PostgreSQLAdapter#schema_search_path</code> and <code>PostgreSQLAdapter#schema_search_path=</code> to get and set the search path.<br>And if you dig into the source code, you will find the two methods does the exact same thing as we did except it assigned one more instance variable <code>@schema_search_path</code>.</p>
<figure class="highlight ruby"><figcaption><span>methods on PostgreSQLAdapter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Sets the schema search path to a string of comma-separated schema names.</span></span><br><span class="line"><span class="comment"># Names beginning with $ have to be quoted (e.g. $user =&gt; '$user').</span></span><br><span class="line"><span class="comment"># See: http://www.postgresql.org/docs/current/static/ddl-schemas.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This should be not be called manually but set in database.yml.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schema_search_path=</span><span class="params">(schema_csv)</span></span></span><br><span class="line">  <span class="keyword">if</span> schema_csv</span><br><span class="line">    execute(<span class="string">"SET search_path TO <span class="subst">#&#123;schema_csv&#125;</span>"</span>, <span class="string">'SCHEMA'</span>)</span><br><span class="line">    @schema_search_path = schema_csv</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Returns the active schema search path.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schema_search_path</span></span></span><br><span class="line">  @schema_search_path <span class="params">||</span>= query(<span class="string">'SHOW search_path'</span>, <span class="string">'SCHEMA'</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The most interesting thing is if you search the reference to <code>@schema_search_path</code>, you will find it is only used as a local cache of current search_path in the adapter, and it is initialized with the value from the query <code>SHOW search_path;</code> if it is nil, and then keep the value as the cache!<br>This implementation is buggy and caused the problems described before!</p>
<p>If we use the SQL query to set the search path rather than calling <code>schema_search_path=</code>, we won’t set the <code>@schema_search_path</code> at sametime, ideally this value will remain nil by default. Then transaction or other object in ActiveRecord call <code>schema_search_path</code> to get current search path. The first time, the variable <code>@@schema_search_path</code> is nil, and will be initialized by the value from query <code>SHOW search_path;</code> and then won’t changed any more, since in the future this query won’t be executed any longer.<br>As a result, the schema will be switched successfully for the first time, but failed in the following.</p>
<p>Which means at current stage, if you want to change search_path, the only correct way is to use <code>PostgreSQLAdapter#schema_search_path=</code>, and PLEASE PLEASE ignore the warning <code>&quot;This should be not be called manually but set in database.yml.&quot;</code> in the source code! It is really a misleading message!</p>
<p>I understand current implementation is for performance consideration, but caching the value is absolutely not a good idea when you cannot keep things in sync and the sync is critical in some cases.<br>I’m planning to fix this issue in rails codebase and create a pull request to rails maintainer. Wish they could accept this fix. Or at least they should change the warning message.</p>
<p>And besides of using the out-dated and mysterious PgTools mentioned in a lot of posts (I saw a lot of people mentioned this class, but I cannot find it anywhere even I from google or github. It is really a mystery). I create a new utility module called MultiSchema.</p>
<script src="//gist.github.com/3129392.js"></script>
<p>You can use it as the utility class in the old-fashioned way:</p>
<figure class="highlight ruby"><figcaption><span>Procedure usage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MultiSchema.with_in_schemas <span class="symbol">:except</span> =&gt; <span class="symbol">:public</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Play around the data in one schema</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Or you can use it in a DSL-like way:</p>
<figure class="highlight ruby"><figcaption><span>DSL usage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeMigration</span> &lt; ActiveRecord::Migration</span></span><br><span class="line"><span class="keyword">include</span> MultiSchema</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    with_in_schemas <span class="symbol">:except</span> =&gt; <span class="symbol">:public</span> <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># Play around the data in one schema</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>with_in_schemas</code> method accept both <code>symbol</code> and <code>string</code>, and you can pass single value, array or hash to it.</p>
<ul>
<li><code>with_in_schemas</code> yield all user schemas in the database</li>
<li><code>with_in_schemas :only =&gt; %w(schema1 schema2)</code> populates all given schemas.</li>
<li><code>with_in_schemas :except =&gt; %w(schema1 schema2)</code> populates all except given schemas.</li>
<li><code>with_in_schemas :except =&gt; [:public]</code> is equivalent to <code>with_in_schemas :except =&gt; [&#39;public&#39;]</code></li>
<li><code>with_in_schemas :only =&gt; [:public]</code> is equivalent to <code>with_in_schemas :only =&gt; :public</code> and equivalent to <code>with_in_schemas :public</code></li>
<li><code>with_in_schemas :except =&gt; [:public]</code> is equivalent to <code>with_in_schemas :except =&gt; :public</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/" data-id="cinedk71s0031chsil6so3cbk" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/active-record/">active record</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multischema/">multischema</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgres/">postgres</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/schema/">schema</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-handle-dynamic-argument-in-dynamic-language" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/06/28/handle-dynamic-argument-in-dynamic-language/" class="article-date">
  <time datetime="2012-06-28T00:00:00.000Z" itemprop="datePublished">2012-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/06/28/handle-dynamic-argument-in-dynamic-language/">Handle dynamic argument in dynamic language</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In dynamic language, most language doesn’t provide the function overload mechanism like static language does, which means you cannot define functions with same name but different arguments, and the language itself won’t help you to dispatch the call according to the arguments.<br>So you have to deal with the overload by yourself in dynamic languages.</p>
<p>In dynamic language, since you have to dispatch the call by yourself, so you can play some tricks during process the arguments. The most common trick is grammar sugar, which can help you simplify the code and increase the readability. And it is a very important feature when you’re building DSL.</p>
<p>Syntax sugar in argument means you can omit something unnecessary or unimportant parameters in specific context, then the function will try to infer and complete the parameters. For example, developer should be able to omit the password parameter if the system enable authentication mechanism. These kind of tricks are very common in dynamic language frameworks, such as jQuery.</p>
<p>Here is a list of some common grammar sugar cases:</p>
<ul>
<li>Set default value for omit parameter, such as for jQuery animation function <code>jQuery.fadeIn([duration] [, callback] )</code>, you can omit the parameter <em>duration</em>, which is equivalent to provide <em>duration</em> as 400</li>
<li>Provide different type of value for a same parameter, still the jQuery animation function <code>jQuery.fadeIn([duration] [, callback] )</code>, you can provide number for <em>duration</em>, or you can provide string “fast” and “slow” as the value of <em>duration</em>.</li>
<li>Provide a single value rather than a complex hash, such as function jQuery ajax function <code>jQuery.ajax(settings)</code>, you can provide a url string, which is equivalent to provide a hash<code>{url: &lt;url string&gt;}</code></li>
<li>Pass a single element instead of a array of the element.</li>
</ul>
<p>After we analyze the cases, we will find that all the grammar sugar is to allow user to provide exactly same information but in different formats. Since all the data are same piece of information, so it should be possible to unify all the information into one format! Which means to support grammar sugar, the major problem is to unify the type of parameter.<br>Besides unify the type, another important problem is to handle the null values, such as<code>null</code> and <code>undefined</code> in javascript, <code>nil</code> in ruby, etc.</p>
<p>Here is a piece of ruby code that I parse the argument by unifying the parameter type:</p>
<figure class="highlight ruby"><figcaption><span>code</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply_to_items</span><span class="params">(options = <span class="literal">nil</span>)</span></span></span><br><span class="line">    options = unify_type(options, Hash) &#123; <span class="params">|items|</span> &#123;<span class="symbol">:only</span> =&gt; items&#125; &#125;</span><br><span class="line">    options[<span class="symbol">:only</span>] = unify_type(options[<span class="symbol">:only</span>], Array) &#123; <span class="params">|item|</span> item.<span class="literal">nil</span>? ? list_all_items : [item]  &#125;</span><br><span class="line">    options[<span class="symbol">:except</span>] = unify_type(options[<span class="symbol">:except</span>], Array) &#123; <span class="params">|item|</span> item.<span class="literal">nil</span>? ? [] : [item] &#125;</span><br><span class="line"></span><br><span class="line">    options[<span class="symbol">:only</span>] = unify_array_item_type(options[<span class="symbol">:only</span>], String) &#123; <span class="params">|symbol|</span> symbol.to_s &#125;</span><br><span class="line">    options[<span class="symbol">:except</span>] = unify_array_item_type(options[<span class="symbol">:except</span>], String) &#123; <span class="params">|symbol|</span> symbol.to_s &#125;</span><br><span class="line"></span><br><span class="line">    target_items = options[<span class="symbol">:only</span>].select &#123; <span class="params">|item|</span> options[<span class="symbol">:except</span>].exclude? item &#125;</span><br><span class="line"></span><br><span class="line">    target_items.each <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">      <span class="keyword">yield</span> item</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">list_all_items</span></span></span><br><span class="line">	<span class="comment"># return all items fetched from database or API</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">unify_type</span><span class="params">(input, type)</span></span></span><br><span class="line">    <span class="keyword">if</span> input.is_a?(type)</span><br><span class="line">      input</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">yield</span> input</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>And here is the test for the code:</p>
<figure class="highlight ruby"><figcaption><span>title</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'spec_helper'</span></span><br><span class="line"></span><br><span class="line">describe Module  <span class="keyword">do</span></span><br><span class="line">  before <span class="keyword">do</span></span><br><span class="line">    extend Moudle</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  it <span class="string">"should populate all items"</span> <span class="keyword">do</span></span><br><span class="line">    visited = []</span><br><span class="line">    apply_to_items <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">      visited &lt;&lt; item</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    visited.should =~ <span class="string">%w(public another_item)</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">"should populate the provided items"</span> <span class="keyword">do</span></span><br><span class="line">    it <span class="string">"provide as string array"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="string">%w(another_item)</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as symbol array"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items([<span class="symbol">:another_item</span>]) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as string item"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="string">'another_item'</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as symbol item"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:another_item</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as string array in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:only</span> =&gt; <span class="string">%w(another_item)</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as symbol array in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:only</span> =&gt; [<span class="symbol">:another_item</span>]) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as string item in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:only</span> =&gt; <span class="string">'public'</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(public)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"provide as symbol item in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:only</span> =&gt; <span class="symbol">:public</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(public)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  describe <span class="string">"should except the not used items"</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"except as string item in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:except</span> =&gt; <span class="string">'public'</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"except as symbol item in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:except</span> =&gt; <span class="symbol">:public</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"except as string array in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:except</span> =&gt; <span class="string">%w(public)</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    it <span class="string">"except as symbol array in hash"</span> <span class="keyword">do</span></span><br><span class="line">      visited = []</span><br><span class="line">      apply_to_items(<span class="symbol">:except</span> =&gt; <span class="symbol">:public</span>) <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">        visited &lt;&lt; item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      visited.should =~ <span class="string">%w(another_item)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The algorithm in previous code is language independent, so ideally, it could be reused in any language, such as java script or python.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/06/28/handle-dynamic-argument-in-dynamic-language/" data-id="cinedk71r002zchsi8ldayixa" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/06/28/handle-dynamic-argument-in-dynamic-language/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic/">dynamic</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/programming/">programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/static/">static</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/syntax-sugar/">syntax sugar</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-the-cursed-null-in-postgres" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/06/27/the-cursed-null-in-postgres/" class="article-date">
  <time datetime="2012-06-27T00:00:00.000Z" itemprop="datePublished">2012-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/postgressql/">PostgresSql</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/06/27/the-cursed-null-in-postgres/">The &quot;Cursed&quot; NULL in postgres</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Comparison-to-NULL"><a href="#Comparison-to-NULL" class="headerlink" title="Comparison to NULL"></a>Comparison to NULL</h2><p>In postgres, NULL is treat as a speical value, that which is not equal to any other value, which means the expression <code>NULL = NULL</code> yields false.<br>It can be verified by using the following query</p>
<figure class="highlight sql"><figcaption><span>SELECT NULL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> n</span><br><span class="line"><span class="keyword">FROM</span> unnest(<span class="built_in">ARRAY</span>(<span class="literal">NULL</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)) n</span><br><span class="line"><span class="keyword">WHERE</span> n = <span class="literal">NULL</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The query returns empty set, because no element equals to NULL even NULL itself.<br>If you think this experiment is not convincing enough, then you can try this:</p>
<figure class="highlight sql"><figcaption><span>CASE NULL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	n,</span><br><span class="line">	<span class="keyword">CASE</span> <span class="keyword">WHEN</span> n = <span class="literal">NULL</span> <span class="keyword">THEN</span> <span class="string">'NULL'</span> <span class="keyword">ELSE</span> <span class="string">'NOT NULL'</span> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">FROM</span> unnest(<span class="built_in">ARRAY</span>(<span class="literal">NULL</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)) n</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This query should yield “ , NOT NULL” which means NULL does not equal to NULL.</p>
<p>To test whether or whether not a value equals to NULL, you should use IS NULL or IS NOT NULL</p>
<p>So if you replace the <code>n = NULL</code> with <code>n IS NULL</code> in previous 2 statements, you will get expected result:</p>
<figure class="highlight sql"><figcaption><span>SELECT NULL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	n,</span><br><span class="line">	<span class="keyword">CASE</span> <span class="keyword">WHEN</span> n <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">THEN</span> <span class="string">'NULL'</span> <span class="keyword">ELSE</span> <span class="string">'NOT NULL'</span> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">FROM</span> unnest(<span class="built_in">ARRAY</span>(<span class="literal">NULL</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)) n</span><br><span class="line"><span class="keyword">WHERE</span> n <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="NULL-in-Crosstab"><a href="#NULL-in-Crosstab" class="headerlink" title="NULL in Crosstab"></a>NULL in Crosstab</h2><p>In most cases, the NULL special character doesn’t hurt much, since we always can alter our expression to fix the problem. But if you’re using table functions to create pivot, and there is NULL in your columns, then you will find <code>NULL</code> is a cursed value, which brought a lot of trouble to you.</p>
<p>Postgres provide <code>tablefunc</code> extension, which can provide a series functions called “crosstab#”. And with these functions, you can convert a set of rows into a pivot table.</p>
<p>Function <code>crosstab</code> accept 2 sql queries. First query should yield 3 columns: row in pivot table, column in pivot table and value in pivot table.<br>Second query should yield a series of value which defines the columns of the pivot table.<br><code>crosstab</code> function will group the rows yield by 1st query by 1st column. Then map each row in the group to a column by comparing the 2nd column in the row yield by 1st query with the value generated by 2nd query, if the value is equal then the 3rd column of the row yield by 1st query will be placed in the column defined by value of the 2nd query.<br>It if a very convenient feature provided by postgres, and it works perfect in most cases.</p>
<p>But in our case, we met a problem that we have <code>NULL</code> value in the 2nd column of 1st query, which means we have <code>NULL</code> value in pivot table columns!  </p>
<p>And the crosstab decide which column the value should be placed to by comparing the whether the value is equal!  </p>
<p>And <code>NULL</code> never equals to <code>NULL</code>!  </p>
<p>BAM!!!  </p>
<p>As a result, the column of <code>NULL</code> in the pivot table is always empty!  </p>
<h2 id="CASE-WHEN"><a href="#CASE-WHEN" class="headerlink" title="CASE WHEN"></a>CASE WHEN</h2><p>To solve the problem, we should play a little trick in the first query, we should translate all the <code>NULL</code> into a “normal” value.<br>Here is our 1st query, and we want to get a pivot table with period as row axis, rating as column axis and volume of the order as content.</p>
<figure class="highlight sql"><figcaption><span>Original 1st query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating,</span><br><span class="line">	<span class="keyword">SUM</span>(Orders.volume)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders</span><br><span class="line">		<span class="keyword">LEFT</span> OUTTER <span class="keyword">JOIN</span> Periods <span class="keyword">ON</span> (Periods.id = Orders.period_id)</span><br><span class="line">		<span class="keyword">LEFT</span> OUTTER <span class="keyword">JOIN</span> <span class="keyword">Profiles</span> <span class="keyword">ON</span> (Profiles.id = Orders.profile_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>And we will get <code>NULL</code> in <code>Profiles.rating</code>, so we can translate <code>NULL</code> as 0 in rating. To achieve this we can use <code>CASE WHEN</code> statement.</p>
<figure class="highlight sql"><figcaption><span>Original 1st query with CASE WHEN</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	<span class="keyword">CASE</span> <span class="keyword">WHEN</span> Profiles.rating <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">THEN</span> <span class="number">0</span> <span class="keyword">ELSE</span> Profiles.rating,</span><br><span class="line">	<span class="keyword">SUM</span>(Orders.volume)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders</span><br><span class="line">		<span class="keyword">LEFT</span> OUTTER <span class="keyword">JOIN</span> Periods <span class="keyword">ON</span> (Periods.id = Orders.period_id)</span><br><span class="line">		<span class="keyword">LEFT</span> OUTTER <span class="keyword">JOIN</span> <span class="keyword">Profiles</span> <span class="keyword">ON</span> (Profiles.id = Orders.profile_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="COALESCE"><a href="#COALESCE" class="headerlink" title="COALESCE"></a>COALESCE</h2><p>The solution works fine. But in personal perspective, I don’t like it, because it repeat the statement and is not concise. But luckily, the value we should deal with the the special value <code>NULL</code> and postgres has provided a group of functions to deal with <code>NULL</code>.</p>
<p>What we want is the function <code>COALESCE</code>, which accept a group of value as arguments, and returns the first not null value.<br>So we can simplify our statement with this super function:</p>
<figure class="highlight sql"><figcaption><span>Original 1st query with COALESCE</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	<span class="keyword">COALESCE</span>(Profiles.rating, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SUM</span>(Orders.volume)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders</span><br><span class="line">		<span class="keyword">LEFT</span> OUTTER <span class="keyword">JOIN</span> Periods <span class="keyword">ON</span> (Periods.id = Orders.period_id)</span><br><span class="line">		<span class="keyword">LEFT</span> OUTTER <span class="keyword">JOIN</span> <span class="keyword">Profiles</span> <span class="keyword">ON</span> (Profiles.id = Orders.profile_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	Periods.period,</span><br><span class="line">	Profiles.rating</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In the statement, if the rating is not null, the <code>COALESCE</code> function will return the actual value if the rating is <code>NULL</code>, then the <code>COALESCE</code> will find the next not null value, which must be 0.</p>
<p>Besides <code>COALESCE</code> function, there is another function called <code>NULLIF</code>, which might mislead you to a totally wrong way just as what I had.<br>According to postgres document, the function might behave in a totally opposite way than you expected.</p>
<blockquote><p>The NULLIF function returns a null value if value1 equals value2; otherwise it returns value1. This can be used to perform the inverse operation of the COALESCE</p>
<footer><strong>postgres</strong><cite><a href="http://www.postgresql.org/docs/9.2/static/functions-conditional.html#FUNCTIONS-NULLIF[Postgres" target="_blank" rel="external">9.2 Doc]</a></cite></footer></blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/06/27/the-cursed-null-in-postgres/" data-id="cinedk71p002vchsippjp5v9l" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/06/27/the-cursed-null-in-postgres/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/null/">NULL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/equality-comparison/">equality comparison</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pivot/">pivot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pivot-table/">pivot table</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgres/">postgres</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/">postgresql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/">sql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-pitfall-in-jquery-form-serialization" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/06/21/a-pitfall-in-jquery-form-serialization/" class="article-date">
  <time datetime="2012-06-21T00:00:00.000Z" itemprop="datePublished">2012-06-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/06/21/a-pitfall-in-jquery-form-serialization/">A pitfall in jQuery form serialization</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today, I was so surprised that I got an empty string when I call the serialize method on a jQuery wrapped form.<br>The html is written in Haml:</p>
<figure class="highlight haml"><figcaption><span>Html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">%<span class="selector-tag">form</span><span class="selector-id">#graph-option</span><span class="selector-class">.horizontal-form</span></span></span><br><span class="line"><span class="tag">	%<span class="selector-tag">fieldset</span></span></span><br><span class="line"><span class="tag">		%<span class="selector-tag">label</span>&#123; <span class="attr">:for</span>=&gt;<span class="string">'start-date'</span>&#125;</span> Start Date</span><br><span class="line"><span class="tag">		%<span class="selector-tag">select</span><span class="selector-id">#start-date</span></span></span><br><span class="line"><span class="tag">		%<span class="selector-tag">label</span>&#123; <span class="attr">:for</span>=&gt;<span class="string">'end-date'</span>&#125;</span> End Date</span><br><span class="line"><span class="tag">		%<span class="selector-tag">select</span><span class="selector-id">#end-date</span></span></span><br><span class="line"><span class="tag">		%<span class="selector-tag">button</span><span class="selector-id">#submit-option</span><span class="selector-class">.btn</span><span class="selector-class">.large-btn</span></span></span><br></pre></td></tr></table></figure>
<p>And the script is written in coffee-script:</p>
<figure class="highlight coffeescript"><figcaption><span>Script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ -&gt;</span><br><span class="line">	$(<span class="string">'#submit-option'</span>).click -&gt;</span><br><span class="line">		option = $(<span class="string">'#graph-option'</span>).serialize()</span><br><span class="line">		$.post <span class="string">'/dashboard/graph'</span>, option, <span class="function"><span class="params">(data)</span> -&gt;</span></span><br><span class="line">			renderCharts data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>When I execute the script, I got 500 error. And the reason is that the option is empty.<br>I believe this must be caused by a super silly mistake, so I try to call serialize methods on Twitter Bootstrap website, and I still got empty string!!!!</p>
<p>After half an hour debugging, I just realize that I forgot to assign the name to all the input elements. And according to html specification, the browser uses the name of the elements to identify whom the value belongs to.<br>So when the name is omitted, the serailizeArray method in jQuery returns an empty array, as a result, the serialize method returns empty string.</p>
<p>According to my experience, it is easy to identify this problem, if the html is in html-like format, such as erb. But it is really hard to identify this issue if the page is written in haml, because in haml, id is used much more often.<br>To fix this problem, we need to specify the name explicitly for each form element.</p>
<p>Here is the fixed haml code:</p>
<figure class="highlight haml"><figcaption><span>Html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">%<span class="selector-tag">form</span><span class="selector-id">#graph-option</span><span class="selector-class">.horizontal-form</span></span></span><br><span class="line"><span class="tag">	%<span class="selector-tag">fieldset</span></span></span><br><span class="line"><span class="tag">		%<span class="selector-tag">label</span>&#123; <span class="attr">:for</span>=&gt;<span class="string">'start-date'</span>&#125;</span> Start Date</span><br><span class="line"><span class="tag">		%<span class="selector-tag">select</span><span class="selector-id">#start-date</span>&#123; <span class="attr">:name</span>=&gt;<span class="string">'start-date'</span> &#125;</span></span><br><span class="line"><span class="tag">		%<span class="selector-tag">label</span>&#123; <span class="attr">:for</span>=&gt;<span class="string">'end-date'</span>&#125;</span> End Date</span><br><span class="line"><span class="tag">		%<span class="selector-tag">select</span><span class="selector-id">#end-date</span>&#123; <span class="attr">:name</span>=&gt;<span class="string">'end-date'</span> &#125;</span></span><br><span class="line"><span class="tag">		%<span class="selector-tag">button</span><span class="selector-id">#submit-option</span><span class="selector-class">.btn</span><span class="selector-class">.large-btn</span></span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/06/21/a-pitfall-in-jquery-form-serialization/" data-id="cinedk71o002schsia83oa5p0" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/06/21/a-pitfall-in-jquery-form-serialization/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/form/">form</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/id/">id</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jquery/">jquery</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/name/">name</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/serialization/">serialization</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-name-trap-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/06/02/name-trap-in-rails/" class="article-date">
  <time datetime="2012-06-02T00:00:00.000Z" itemprop="datePublished">2012-06-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/06/02/name-trap-in-rails/">Name trap in Rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m a newbie to Rails, and my past few projects are all rails based, including MetaPaas, Recruiting On Rails and current SFP.<br>I was amazed by the convenience of Rails, and also hurt by its “smartness”.<br>The power of Rails was described in quite a lot of posts, so I wanna to share some failure experiences.<br>Actually I have felt into quite a number of pitfalls in Rails, and here is one of the most painful ones.</p>
<p>To explain the problem easier, I just simplify the scenario:<br>I have a model called “Candidate”, which holds a “Status” to store the status of the candidate, so I have the code like this:</p>
<figure class="highlight ruby"><figcaption><span>Candidate and Status</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Candidate</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	has_one status</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Status</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	belongs_to candidate</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>For some reason, I change the relationship between Candidate and Status. It is changed from one-to-one to one-to-many.<br>So I changed the <code>has_one</code> to <code>has_many</code>:</p>
<figure class="highlight ruby"><figcaption><span>Candidate and Status</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Candidate</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	has_many status</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Status</span> &lt; ActiveRecord::Base</span></span><br><span class="line">	belongs_to candidate</span><br><span class="line"></span><br><span class="line">	<span class="comment"># other definition</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>I thought it is an easy modification, but the app fails to run, even I have done the database migration.<br>It said rails cannot find a constant named “Statu”!</p>
<p>After my first sight on this error message, I believed it is caused by a typo, I must mistyped “Status” as “Statu”.<br>So I full-text search the whole project for “Statu”, but I cannot find any.</p>
<p>This error message is quite weird to me, since I have no idea about where the word “Statu” come from!<br>After spent half an hour on pointless trying, I suddenly noticed that the word “status” is end with “s”, and according to Rails’ convention, rails must think “status” is the plural form of “statu”. So according to the convention again, it try to find a class named “Statu”.<br>And we should use the plural form noun as name for one-to-many field, since that holds an array rather than a single object.</p>
<p>So after changing <code>status</code> to <code>statuses</code>, the problem solved.</p>
<p>Convention based system is powerful, a lot magic just happened there. But also the magic things are hard to debug when some special case breaks the convention presumption.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/06/02/name-trap-in-rails/" data-id="cinedk71m002ochsifh28wzh1" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/06/02/name-trap-in-rails/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/active-model/">active model</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/convention/">convention</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/error/">error</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/name/">name</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trap/">trap</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-negative-index-in-coffee-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/05/29/negative-index-in-coffee-script/" class="article-date">
  <time datetime="2012-05-29T00:00:00.000Z" itemprop="datePublished">2012-05-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/javascript/">JavaScript</a>►<a class="article-category-link" href="/categories/programming/javascript/coffeescript/">CoffeeScript</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/05/29/negative-index-in-coffee-script/">Negative Index in Coffee-Script</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Coffee Script borrowed quite a lot syntax patterns from both Ruby and Python, especially from Ruby.<br>So people, like me, usually tends to write coffee-script in ruby way.</p>
<p>In ruby, we can retrieve the element in an array in reversed order by using a negative index, which means <code>array[-1]</code> returns the last element in the array. This grammar sugar is really convenient and powerful, so we can omit the code like this <code>array[array.length - 1]</code>.</p>
<p>But for some reason, coffee-script doesn’t inherit this syntax. To me, it is weird. But after analyze this problem in detail, I found the reason.<br>Coffee script announce it has a golden rule: “coffee-script is just javascript”. So all the coffee script must be able to compiled into javascript.</p>
<p>Let’s try to analyze how the coffee script is compiled into javascript:</p>
<figure class="highlight coffeescript"><figcaption><span>Coffee Script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array = [<span class="number">1.</span><span class="number">.10</span>]</span><br><span class="line">second = array[<span class="number">1</span>]</span><br><span class="line">last = array[<span class="number">-1</span>] <span class="regexp">//</span> Psudocode</span><br></pre></td></tr></table></figure>
<p>Obviously, the previous code should be compiled as following:</p>
<figure class="highlight js"><figcaption><span>JavaScript</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array, last, second;</span><br><span class="line">array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>];</span><br><span class="line">second = array[<span class="number">1</span>];</span><br><span class="line">last = array[array.length - <span class="number">1</span>];</span><br></pre></td></tr></table></figure>
<p>The negative index should be processed specially, so we should check the index is negative or not while compiling. This translation seems easy but actually not, since we can and usually use variable as the index.</p>
<figure class="highlight coffeescript"><figcaption><span>Variable as index</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">array = [<span class="number">1.</span><span class="number">.10</span>]</span><br><span class="line">index = <span class="number">1</span></span><br><span class="line">second = array[index]</span><br><span class="line">index = -index</span><br><span class="line">last = array[index]</span><br></pre></td></tr></table></figure>
<p>In the previous code, because we use the variable as index, which cannot be verified in compile-time, which means we need to compile the array reference code as following:</p>
<figure class="highlight js"><figcaption><span>Compile Result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array, index, last, second;</span><br><span class="line">array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>];</span><br><span class="line">index = <span class="number">1</span>;</span><br><span class="line">second = index &gt;=<span class="number">0</span> ? array[index] : array[array.length + index];</span><br><span class="line">index = -index;</span><br><span class="line">last = index &gt;=<span class="number">0</span> ? array[index] : array[array.length + index];</span><br></pre></td></tr></table></figure>
<p>So every time we reference the array, we need to check whether the index is negative or not. This approach absolutely hurts the performance a lot, which in basically unacceptable.<br>So that’s why coffee-script doesn’t support the negative index.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/05/29/negative-index-in-coffee-script/" data-id="cinedk71g002gchsipigam9bx" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/05/29/negative-index-in-coffee-script/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/array/">array</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/coffeescript/">coffeescript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/index/">index</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/negative/">negative</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/slice/">slice</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-eigenclass-in-ruby" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/05/25/eigenclass-in-ruby/" class="article-date">
  <time datetime="2012-05-25T00:00:00.000Z" itemprop="datePublished">2012-05-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/05/25/eigenclass-in-ruby/">Eigenclass in ruby</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>To me, “Eigenclass” is a weird name. Here is the definition of “Eigenclass” from <a href="https://en.wiktionary.org/wiki/eigenclass" target="_blank" rel="external">wikipedia</a>:</p>
<blockquote><p>A hidden class associated with each specific instance of another class.</p>
<footer><strong> 松本行弘 (Yukihiro Matsumoto)</strong><cite><a href="https://en.wiktionary.org/wiki/eigenclass" target="_blank" rel="external">[Wikipedia]</a></cite></footer></blockquote>
<p>“Eigen” is a Dutch word, which means “own” or “one’s own”. So “Eigenclass” means the class that class owned by the instance itself.</p>
<p>To open the eigenclass of the object, Ruby provide the following way:</p>
<figure class="highlight ruby"><figcaption><span>Open Eigenclass</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo = Foo.new</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; foo</span></span><br><span class="line">	<span class="comment"># do something with the eigenclass of foo</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Since the in most cases, the purpose that we open a eigenclass is to define singleton methods on specific object. So Ruby provide an easy way to define the singleton method on specific instance:</p>
<figure class="highlight ruby"><figcaption><span>Shorten saying</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo = Foo.new</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>.<span class="title">some_method</span></span></span><br><span class="line">	<span class="comment"># do something</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Since “static method” or “class method” is actually the singleton method of a specific class. So this statement is usually used to declare the “class method”.</p>
<p>Besides this simpler statment, we also can open the eigenclass of the class to achieve the same result.<br>We can write this:</p>
<figure class="highlight ruby"><figcaption><span>Open eigenclass of the class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">		<span class="comment"># define class methods</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># define instance methods</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Since we’re in the class block, so the “self” indicates the Foo class instance. So we can use <code>class &lt;&lt; self; end</code> to open the eigenclass of the class.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/05/25/eigenclass-in-ruby/" data-id="cinedk71e002dchsiz28b8taf" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/05/25/eigenclass-in-ruby/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/eigen/">eigen</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/eigenclass/">eigenclass</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/meta-class/">meta class</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/meta-programming/">meta programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/singleton-class/">singleton class</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-space-pitfall-in-coffee-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/05/14/space-pitfall-in-coffee-script/" class="article-date">
  <time datetime="2012-05-14T00:00:00.000Z" itemprop="datePublished">2012-05-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/javascript/">JavaScript</a>►<a class="article-category-link" href="/categories/programming/javascript/coffeescript/">CoffeeScript</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/05/14/space-pitfall-in-coffee-script/">Space Pitfall in coffee-script</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Coffee Script had fixed quite a lot of pitfalls in Javascript. But on another hand it also introduced some other pitfalls, the most common one is the space.</p>
<h3 id="Space-in-function-declaration"><a href="#Space-in-function-declaration" class="headerlink" title="Space in function declaration"></a>Space in function declaration</h3><p>Read the following code:</p>
<figure class="highlight coffeescript"><figcaption><span>Show Message:Coffee</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show = message -&gt;</span><br><span class="line">	<span class="built_in">console</span>.log message</span><br><span class="line"></span><br><span class="line">show <span class="string">"space pitfall"</span></span><br></pre></td></tr></table></figure>
<p>This is a quite simple script, but it failed to run. And if you might also feel confused about the error message: “message is not defined”</p>
<p>What happened to the code? We indeed had declared the message as argument of function show. To reveal the answer, we should analyze the compiled javascript.<br>Here is the compiled code:</p>
<figure class="highlight js"><figcaption><span>Show Message:JS</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generated by CoffeeScript 1.3.1</span></span><br><span class="line"><span class="keyword">var</span> show;</span><br><span class="line"></span><br><span class="line">show = message(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">console</span>.log(message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">showe(<span class="string">"space pitfall"</span>);</span><br></pre></td></tr></table></figure>
<p>Look the fun declaration, you will see it is not a function declaration as we want but a function call.<br>The reason is that we omitted the parentheses around the argument and we add a new space between <code>message</code> and <code>-&gt;</code>. So the coffee-script compiler interpret message as a function call with a function as parameter.</p>
<p><strong>Soltuion</strong><br>To fix this problem, we can remove the space between <code>message</code> and <code>-&gt;</code> to enforce coffee-script compiler interpret them as a whole.</p>
<figure class="highlight coffeescript"><figcaption><span>Show Message:Fix</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show = message-&gt;</span><br><span class="line">	<span class="built_in">console</span>.log message</span><br><span class="line"></span><br><span class="line">show <span class="string">"space pitfall"</span></span><br></pre></td></tr></table></figure>
<p><strong>Best Practise</strong><br>To avoid this pitfall, my suggestion is never omit the parentheses around the arguments, even there is only one argument.<br>And also including the function call, even coffee-script allow to omit the parentheses. Since you won’t able to chain the method call if you omit the parentheses.<br>So never omit parentheses, unless you are very certain that there is no any ambiguity and you won’t use method chain.</p>
<h3 id="The-space-in-array-index"><a href="#The-space-in-array-index" class="headerlink" title="The space in array index"></a>The space in array index</h3><p>Since coffee script doesn’t support the <a href="#">negative index</a>. So we should use following code as negative index:</p>
<figure class="highlight coffeescript"><figcaption><span>Last Hero:Coffee</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">heros = [<span class="string">"Egeal Eye"</span>, <span class="string">"XMen"</span>, <span class="string">"American Captain"</span>, <span class="string">"IronMan"</span>]</span><br><span class="line">lastHero = heros[heros <span class="number">-1</span>]</span><br><span class="line"><span class="built_in">console</span>.log lastHero</span><br></pre></td></tr></table></figure>
<p>This piece of code is also failed to run, and the error message is “property of object is not a function”.<br>Quite wield right?<br>Let’s see what is behind the scene, here is the compiled code:</p>
<figure class="highlight js"><figcaption><span>Last Hero:JS</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generated by CoffeeScript 1.3.1</span></span><br><span class="line"><span class="keyword">var</span> heros, lastHero;</span><br><span class="line"></span><br><span class="line">heros = [<span class="string">"Egeal Eyr"</span>, <span class="string">"XMen"</span>, <span class="string">"American Captain"</span>, <span class="string">"IronMan"</span>];</span><br><span class="line"></span><br><span class="line">lastHero = heros[heros.length(<span class="number">-1</span>)];</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(lastHero);</span><br></pre></td></tr></table></figure>
<p>Same problem, <code>heros.length -1</code> is interpreted as <code>heros.length(-1)</code> instead of <code>heros.length -1</code>.<br>To fix this problem, we should write the code in following way:</p>
<figure class="highlight coffeescript"><figcaption><span>Last Hero:Fix1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">heros = [<span class="string">"Egeal Eye"</span>, <span class="string">"XMen"</span>, <span class="string">"American Captain"</span>, <span class="string">"IronMan"</span>]</span><br><span class="line">lastHero = heros[heros - <span class="number">1</span>]</span><br><span class="line"><span class="built_in">console</span>.log lastHero</span><br></pre></td></tr></table></figure>
<p>Or</p>
<figure class="highlight coffeescript"><figcaption><span>Last Hero:Fix2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">heros = [<span class="string">"Egeal Eye"</span>, <span class="string">"XMen"</span>, <span class="string">"American Captain"</span>, <span class="string">"IronMan"</span>]</span><br><span class="line">lastHero = heros[heros<span class="number">-1</span>]</span><br><span class="line"><span class="built_in">console</span>.log lastHero</span><br></pre></td></tr></table></figure>
<p>Both solution is try to enforce the compiler divid the component in correct way.</p>
<p>And unfortunately, there is no way to avoid this problem, the only thing you can do is always be aware the spaces in expression.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/05/14/space-pitfall-in-coffee-script/" data-id="cinedk71c002achsih4gycs1q" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/05/14/space-pitfall-in-coffee-script/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/best-practice/">best-practice</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/coffee-script/">coffee-script</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/compile/">compile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/space/">space</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-print-multiple-line-string-on-bash" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/05/14/how-to-print-multiple-line-string-on-bash/" class="article-date">
  <time datetime="2012-05-14T00:00:00.000Z" itemprop="datePublished">2012-05-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/05/14/how-to-print-multiple-line-string-on-bash/">How to print multiple line string on bash</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>To display some pre-formatted text onto screen, we need the following 2 capabilities:</p>
<h3 id="Construct-Multiple-Text"><a href="#Construct-Multiple-Text" class="headerlink" title="Construct Multiple Text"></a>Construct Multiple Text</h3><p>There are 2 ways to construct multiple line strings:</p>
<ul>
<li><p>String literal</p>
<figure class="highlight bash"><figcaption><span>String Literal</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">"</span><br><span class="line">First Line</span><br><span class="line">Second Line</span><br><span class="line">Third Line</span><br><span class="line">"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Use cat</p>
<figure class="highlight bash"><figcaption><span>cat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">text = $(cat &lt;&lt; EOF</span><br><span class="line">First Line</span><br><span class="line">Second Line</span><br><span class="line">Third Line</span><br><span class="line">EOF</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Print-Multiple-Text-to-Screen"><a href="#Print-Multiple-Text-to-Screen" class="headerlink" title="Print Multiple Text to Screen"></a>Print Multiple Text to Screen</h3><p>For some reason, <code>echo</code> command will eat all the line break in the text, so we should use printf instead of echo.<br>And printf supports back-slash-escape, so we can use <code>\n</code> to print a new-line on screen.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/05/14/how-to-print-multiple-line-string-on-bash/" data-id="cinedk7190024chsi047fidbb" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/05/14/how-to-print-multiple-line-string-on-bash/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bash/">bash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multiline/">multiline</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/output/">output</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/">shell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-dynamic-singleton-methods-in-ruby" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/05/08/dynamic-singleton-methods-in-ruby/" class="article-date">
  <time datetime="2012-05-08T00:00:00.000Z" itemprop="datePublished">2012-05-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/05/08/dynamic-singleton-methods-in-ruby/">Dynamic Singleton Methods in Ruby</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today, I pair with Ma Wei to refactor a piece of pre-existed code. We try to eliminate some “static methods” (in fact, there is no real static method in ruby, I use this term to describe the methods that only depends on its parameters other than any instance variables).</p>
<p>The code is like this:</p>
<figure class="highlight ruby"><figcaption><span>Recruiter.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recruiter</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">approve!</span> <span class="title">candidates</span></span></span><br><span class="line">    Candidate.transaction <span class="keyword">do</span></span><br><span class="line">      candidates.each <span class="keyword">do</span> <span class="params">|candidate|</span></span><br><span class="line">        candidate.status.approve!</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">reject!</span> <span class="title">candidates</span></span></span><br><span class="line">    Candidate.transaction <span class="keyword">do</span></span><br><span class="line">      candidates.each <span class="keyword">do</span> <span class="params">|candidate|</span></span><br><span class="line">        candidate.status.reject!</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">revoke!</span> <span class="title">candidates</span></span></span><br><span class="line">    Candidate.transaction <span class="keyword">do</span></span><br><span class="line">      candidates.each <span class="keyword">do</span> <span class="params">|candidate|</span></span><br><span class="line">        candidate.status.revoke!</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># Some other methods similar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>As you can see the class Recruiter is used as a host for the methods that manipulate the array of candidates, which is a strong bad smell . So we decide to move these methods to their context class.</p>
<p>In Java or C#, the solution to this smell is quite obvious, which could be announced as “Standard Answers”:</p>
<ol>
<li>Mark all methods static.</li>
<li>Create a new class named CandiateCollection.</li>
<li>Change the type of candidates to CandidateCollection.</li>
<li>Mark all methods non-static, and move it to CandidateCollection class.<br>If you use Resharper or IntelliJ enterprise version, then the tool can even do this for you.</li>
</ol>
<p>But in ruby world, or even in dynamic language world, we don’t like to create so many classes, especially these “strong-typed collection”. I wish I could inject these domain related methods to the array instance when necessary, which is known as “singleton methods” in ruby.<br>To achieve this, I might need the code like this:</p>
<figure class="highlight ruby"><figcaption><span>Singleton Methods</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap_array</span> <span class="title">array</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">array</span>.<span class="title">approve!</span></span></span><br><span class="line">		<span class="comment"># ...</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">array</span>.<span class="title">reject!</span></span></span><br><span class="line">		<span class="comment"># ...</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"> 	<span class="comment"># ...</span></span><br><span class="line">  	<span class="comment"># Some other methods similar</span></span><br><span class="line"></span><br><span class="line">	array</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>With the help of this <code>wrap_array</code> method, we can dynamic inject the method into the array like this:</p>
<figure class="highlight ruby"><figcaption><span>call wrap_array</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrap_array(Candidate.scoped_by_id(candidate_ids)).approve!</span><br></pre></td></tr></table></figure>
<p>This is cool, but still not cool enough. We still have problems:</p>
<ol>
<li>All the business logic is included in the wrap method. It is hard to maintain.</li>
<li>Where should we declare this wrap method? In class Array or another “static class”?</li>
</ol>
<p>The answer to the 1st question is easy, our solution is encapsulate these logics into a module:</p>
<figure class="highlight ruby"><figcaption><span>Module CandidateCollection</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">CandidateCollection</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">approve!</span></span></span><br><span class="line">   <span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">reject!</span></span></span><br><span class="line">   <span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">revoke!</span></span></span><br><span class="line">   <span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># Some other methods similar</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>By encapsulate the logic into a module, then we can extract it into a single file, so the logic could be organized in the way as we want.<br>Now we need to solve the second problem and reuse the module we just created.</p>
<p>To achieve this, we wrote the following code:</p>
<figure class="highlight ruby"><figcaption><span>Array.to_candidate_collection</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Array</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">to_candidate_collection</span></span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">	  <span class="keyword">include</span> CandidateCollection</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>In the code, we re-opened the class Array, and define a new method called <code>to_candidate_collection</code>, which is used to inject domain methods into a generic array.<br>So we can have the following code:</p>
<figure class="highlight ruby"><figcaption><span>Call to_candidate_collection</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Candidate.scoped_by_id(candidate_ids).to_candidate_collection.approve!</span><br></pre></td></tr></table></figure>
<p>Now our refactoring is basically completed.</p>
<p>But soon, we realize that is pattern is really powerful and should be able to be reused easily. So we decide to move on.<br>We want <code>to_candiate_collection</code> be more generic, so we can dynamically inject any module, not just CandidateCollection.<br>So we wrote the following code:</p>
<figure class="highlight ruby"><figcaption><span>dynamic_inject</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Array</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">dynamic_inject</span> <span class="title">module</span></span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">	  <span class="keyword">include</span> <span class="class"><span class="keyword">module</span></span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><del>So we can have the code like this:</del></p>
<figure class="highlight ruby"><figcaption><span>call dynamic_inject</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Candidate.scoped_by_id(candidate_ids).dynamic_inject(CandidateCollection).approve!</span><br></pre></td></tr></table></figure>
<p><del>The code looks cool, but failed to run.<br>The reason is that we opened the meta class of the instance, which means we enter another level of context, so the parameter module is no longer visible.<br>To solve this problem, we need to flatten the context by using closure. So we modified the code as following:</del></p>
<figure class="highlight ruby"><figcaption><span>dynamic_inject version 2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Array</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">dynamic_inject</span> <span class="title">module</span></span></span><br><span class="line">	metaclass = <span class="class"><span class="keyword">class</span> &lt;&lt; self;</span> <span class="keyword">self</span>; <span class="keyword">end</span></span><br><span class="line">	metaclass.class_eval <span class="keyword">do</span></span><br><span class="line">	  <span class="keyword">include</span> <span class="class"><span class="keyword">module</span></span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><del>The code <code>metaclass = class &lt;&lt; self; self; end</code> is very tricky, we use this statement to get the meta class of the array instance.<br>Then we call class_eval on meta class, which then mixed-in the module we want.</del></p>
<p><del>Now the code is looked nice. We can dynamically inject any module into “Array” instance.<br>Wait a minute, why only “Array”? We’d like to have this capability on any object!<br>Ok, that’s easy, let’s move the method to Kernel module, which is mixed-in by Object class.</del></p>
<figure class="highlight ruby"><figcaption><span>dynamic_inject version 3</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Kernel</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">dynamic_inject</span> <span class="title">module</span></span></span><br><span class="line">	metaclass = <span class="class"><span class="keyword">class</span> &lt;&lt; self;</span> <span class="keyword">self</span>; <span class="keyword">end</span></span><br><span class="line">	metaclass.class_eval <span class="keyword">do</span></span><br><span class="line">	  <span class="keyword">include</span> <span class="class"><span class="keyword">module</span></span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><del>Now we can say the code looks beautiful.</del></p>
<p><strong>NOTICE:</strong><br><del>Have you noticed that we have a <code>self</code> expression at the end of the <code>dynamic_inject</code> method as return value.<br>This statement is quite important!<br>Since we will get “undefined method error” when calling <code>Candidate.scoped_by_id(candidate_ids).dynamic_inject(CandidateCollection).approve!</code> if we missed this statement.<br>We spent almost 1 hour to figure out this stupid mistake. It is really a stupid but expensive mistake!</del></p>
<p><ins><br>Instead of these tricky ways, for Ruby 1.9+, it is okay to use <code>extend</code> method to replace the tricky code.<br>The <code>extend</code> method is the official way to do “dyanamic inject” as described before.<br></ins></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/05/08/dynamic-singleton-methods-in-ruby/" data-id="cinedk7170021chsid75mb3p7" class="article-share-link">Partager</a>
      
        <a href="http://timnew.me/blog/2012/05/08/dynamic-singleton-methods-in-ruby/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/meta-programming/">meta programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mixin/">mixin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/module/">module</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/singleton-method/">singleton method</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/categories/programming/blog/5/">&laquo; __('prev')</a><a class="page-number" href="/categories/programming/">1</a><span class="space">&hellip;</span><a class="page-number" href="/categories/programming/blog/4/">4</a><a class="page-number" href="/categories/programming/blog/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/categories/programming/blog/7/">7</a><a class="page-number" href="/categories/programming/blog/8/">8</a><a class="extend next" rel="next" href="/categories/programming/blog/7/">__('next') &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap"><h3 class="widget-title">About Me</h3><div class="widget self-intro"><img src="/images/avatar.png"/><p>Tim is</p><ul class="description"><li>a<span>geek</span></li><li>an spare-time<span>web developer</span></li><li>a part-time<span>mobile developer</span></li><li>a night-time<span>photographer</span></li><li>an early-time<span>pcb solderer</span></li></ul><ul class="social-links"><li><a href="https://linkedin.com/in/timwen" target="_blank" class="linked-in"></a></li><li><a href="https://twitter.com/timnew" target="_blank" class="twitter"></a></li><li><a href="https://github.com/timnew" target="_blank" class="github"></a></li></ul></div></div>
  
    
  <div class="widget-wrap">
    <a href="/posts">
      <h3 class="widget-title">Articles récents</h3>
    </a>
    <div class="widget recent-posts">
      <ul>
        
          <li>
            <a href="/blog/2016/04/23/collection-filtering-algorithm-with-bit-operation-part-1/">Collection Filtering Algorithm with Bit Operation - Part.1</a>
          </li>
        
          <li>
            <a href="/blog/2015/08/14/a-clean-way-to-test-rejected-promise/">A clean way to test rejected promise</a>
          </li>
        
          <li>
            <a href="/blog/2014/12/06/typical-eventbus-design-patterns/">Typical EventBus Design Patterns</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/09/understand-styles-in-android-part-1-what-it-is-for-and-how-to-used-it/">Understand Styles in Android - Part 1. What it is for and how to used it</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/07/walkthrough-untrusted-the-continuing-adventures-of-dr-eval/">Walkthrough: Untrusted - the Continuing Adventures of Dr. Eval</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/tags">
      <h3 class="widget-title">Nuage de mot-clés</h3>
    </a>
    <div class="widget tagcloud">
      <a href="/tags/net/" style="font-size: 10px;">.net</a> <a href="/tags/alfred/" style="font-size: 10px;">Alfred</a> <a href="/tags/algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/android-studio/" style="font-size: 10px;">Android Studio</a> <a href="/tags/automation/" style="font-size: 10px;">Automation</a> <a href="/tags/binary/" style="font-size: 10px;">Binary</a> <a href="/tags/bit-operation/" style="font-size: 10px;">Bit Operation</a> <a href="/tags/bit-slicer/" style="font-size: 10px;">Bit Slicer</a> <a href="/tags/bloom-filter/" style="font-size: 10px;">Bloom Filter</a> <a href="/tags/boilerplate/" style="font-size: 10px;">Boilerplate</a> <a href="/tags/c/" style="font-size: 20px;">C#</a> <a href="/tags/ci/" style="font-size: 15px;">CI</a> <a href="/tags/css/" style="font-size: 10px;">CSS</a> <a href="/tags/cheat/" style="font-size: 10px;">Cheat</a> <a href="/tags/cheat-engine/" style="font-size: 10px;">Cheat Engine</a> <a href="/tags/class/" style="font-size: 10px;">Class</a> <a href="/tags/cocoa/" style="font-size: 10px;">Cocoa</a> <a href="/tags/collection/" style="font-size: 10px;">Collection</a> <a href="/tags/command/" style="font-size: 10px;">Command</a> <a href="/tags/continues-delivery/" style="font-size: 10px;">Continues Delivery</a> <a href="/tags/continues-integration/" style="font-size: 10px;">Continues Integration</a> <a href="/tags/crack/" style="font-size: 10px;">Crack</a> <a href="/tags/d/" style="font-size: 10px;">D</a> <a href="/tags/debugger/" style="font-size: 10px;">Debugger</a> <a href="/tags/deploy/" style="font-size: 10px;">Deploy</a> <a href="/tags/deployment/" style="font-size: 10px;">Deployment</a> <a href="/tags/design/" style="font-size: 10px;">Design</a> <a href="/tags/design-pattern/" style="font-size: 10px;">Design Pattern</a> <a href="/tags/event/" style="font-size: 10px;">Event</a>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/categories">
      <h3 class="widget-title">Catégories</h3>
    </a>
    <div class="widget category-list">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/">Cracking</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/game/">Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/">Design</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/design/visual/">Visual</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/web/">Web</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/game/">Game</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/game/programming-game/">Programming Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/geek-toy/">Geek Toy</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/">Package</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/package/chrome-extension/">Chrome Extension</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/hexo/">Hexo</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/">Practice</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/practice/atom/">Atom</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/continues-integration/">Continues Integration</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/devops/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/mac/">Mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/textmate/">TextMate</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/windows/">Windows</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/git/">git</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">Programming</a><span class="category-list-count">73</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/algorithm/">Algorithm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/android/">Android</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/arduino/">Arduino</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/c/">C#</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/design-patterns/">Design Patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/">JavaScript</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/coffeescript/">CoffeeScript</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/postgressql/">PostgresSql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/powershell/">PowerShell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/regular-expression/">Regular Expression</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/ruby/">Ruby</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/shell/">Shell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/wpf/">WPF</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/web/">Web</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/node-js/">node.js</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/thinking/">Thinking</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/archives">
      <h3 class="widget-title">Archives</h3>
    </a>
    <div class="widget archive-list">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 TimNew<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/#main" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/photos/500px.html" class="mobile-nav-link">Photos</a>
  
</nav>
    
<script>
  var disqus_shortname = 'timnew-github';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>