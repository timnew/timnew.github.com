<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: Programming | ThoughtWorkshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="timnew programming code software">
<meta property="og:type" content="website">
<meta property="og:title" content="ThoughtWorkshop">
<meta property="og:url" content="http://timnew.me/categories/programming/blog/5/index.html">
<meta property="og:site_name" content="ThoughtWorkshop">
<meta property="og:description" content="timnew programming code software">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ThoughtWorkshop">
<meta name="twitter:description" content="timnew programming code software">
<meta name="twitter:creator" content="@timnew">
<link rel="publisher" href="108780866821209050000">
  
    <link rel="alternate" href="/atom.xml" title="ThoughtWorkshop" type="application/atom+xml">
  
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
<link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">

  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '[object Object]', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ThoughtWorkshop</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Digital Bigs in my thought</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/#main">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/photos/500px.html">Photos</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://timnew.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/" class="article-date">
  <time datetime="2012-11-15T00:00:00.000Z" itemprop="datePublished">2012-11-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/">Pitfall in fs.watch: fs.watch fails when switch from TextMate to RubyMine</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m writing a cake script that helps me to build the growlStyle bundle.<br>And I wish to my script can watch the change of the source file, and rebuild when file changed.<br>So I wrote the code as following:</p>
<figure class="highlight coffeescript"><figcaption><span>Watching code change</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">files = fs.readdirSync getLocalPath(<span class="string">'source'</span>)</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files</span><br><span class="line">  fs.watch file, <span class="function">-&gt;</span></span><br><span class="line">    <span class="built_in">console</span>.log <span class="string">"File changed, rebuilding..."</span></span><br><span class="line">    build()</span><br></pre></td></tr></table></figure>
<p>The code works when I edits the code with TextMate, but fails when I uses RubyMine!</p>
<p>Super weird!</p>
<p>After half an hour debugging, I found the following interesting phenomena:</p>
<ul>
<li><p>Given I’m using TextMate<br>When I changed the file 1st time<br>Then a ‘change’ event is captured<br>When I changed the file 2nd time<br>Then a ‘change’ event is captured<br>When I changed the file 3rd time<br>Then a ‘change’ event is captured</p>
</li>
<li><p>Given I’m using RubyMine<br>When I change the file 1st time<br>Then a ‘rename’ event is captured<br>When I changed the file 2nd time<br>Then no event is captured<br>When I changed the file 3rd time<br>Then no event is captured</p>
</li>
</ul>
<p>From the result, we can easily find out that the script fails is because “change” event is not triggered as expected when using RubyMine.<br>And the reason of RubyMine’s “wried” behavior might be that RubyMine what to keep the file integrity so they “write” the file in an atomic way as following:</p>
<ol>
<li>RubyMine write the file content to a temp file</li>
<li>RubyMine remove the original file</li>
<li>RubyMine rename the temp file to original file</li>
</ol>
<p>This workflow ensures that the content is fully written or not written. So in a word, RubyMine does not actually write the file, it actually replace the original file with another one, and the original one is removed or stored to some special location.</p>
<p>And on the other hand, according to Node.js document of <code>fs.watch</code>, node uses <code>kqueue</code> on Mac to implement this behavior.<br>And according to <code>kqueue</code> document, it uses <code>file descriptor</code> as identifier, and <code>file descriptor</code> is bound to the file itself rather than its path. So when the file is renamed, we will keep to track the file with new name. That’s why we lost the status of the file after the first ‘rename’ event.<br>And in our case, we actually wish to identify the file by file path rather than by ‘file descriptor’.</p>
<p>To solve this issue, we have 2 potential solutions:</p>
<ol>
<li><p>Also apply <code>fs.watch</code> to the directory that holds the source file besides of the source file itself.<br>When the file is directly updated as TextMate does, the watcher on the file will raise the “change” event.<br>When the file is atomically updated as RubyMine does, the watcher on the directory will raise 2 “rename” events.<br>So theoretically, we could track the change of the file no matter how it is updated.</p>
</li>
<li><p>Use the old fashioned <code>fs.watchFile</code> function, which tracks the change the with <code>fs.stat</code>.<br>Comparing to <code>fs.watch</code>, <code>fs.watchFile</code> is less efficient because its polling mechanism, but it does track the file with file name rather than <code>file descriptor</code>. So it won’t be charmed by the fancy atomic writing.</p>
</li>
</ol>
<p>Obviously, the 1st solution looks better than the 2nd one, because its uses the <code>event</code> rather than old-fashioned <code>polling</code>. Even document of <code>fs.watchFile</code> also says that try to use <code>fs.watch</code> instead of <code>fs.watchFile</code> when possible.</p>
<p>But actually it is kind of painful to write such code, since ‘rename’ event on the directory is not only triggered by the file update, it also can be triggered by adding file and removing file.</p>
<p>And the ‘rename’ event will be triggered twice when updating the file. Obviously we cannot rebuild the code when the first ‘rename’ event fired, or the build might fail because of the absence of the file. And we will trigger the build twice in a really short period of time.</p>
<p>So in fact, to solve our problem, the polling <code>fs.watchFile</code> is more useful, its old-fashion protected itself being charmed by the ‘fancy’ atomic file writing.</p>
<p>So finally, we got the following code:<br><figure class="highlight coffeescript"><figcaption><span>fs.watchFile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">runInWatch</span> = <span class="params">(options, task)</span> -&gt;</span></span><br><span class="line">  action(options) <span class="keyword">unless</span> options.watch</span><br><span class="line">  <span class="built_in">console</span>.info <span class="string">"INFO: Watching..."</span></span><br><span class="line">  files = fs.readdirSync getLocalPath(<span class="string">'source'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log <span class="string">'"Tracking files:'</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> files</span><br><span class="line">    <span class="built_in">console</span>.log <span class="string">"<span class="subst">#&#123;file&#125;</span>"</span></span><br><span class="line">    fs.watchFile getLocalPath(<span class="string">'source'</span>, file), <span class="function"><span class="params">(current, previous)</span> -&gt;</span></span><br><span class="line">      <span class="keyword">unless</span> current.mtime == previous.mtime</span><br><span class="line">        <span class="built_in">console</span>.log <span class="string">"<span class="subst">#&#123;file&#125;</span> Changed..."</span></span><br><span class="line">        task(options)</span><br></pre></td></tr></table></figure></p>
<p><strong>HINT:</strong> Be careful about the differens of fs.watch and fs.watchFile:</p>
<ul>
<li>The meaning of <code>filename</code> parameter<br><strong> The <code>filename</code> parameter of <code>fs.watch</code> is path sensitive, which accept ‘source.jade’ or ‘/path/to/source.jade’
</strong> The <code>filename</code> parameter of <code>fs.watchFile</code> isn’t path sensitive, which only accept ‘/path/to/source.jade’</li>
<li>Callback is invocation condition<br><strong> <code>fs.watch</code> invokes callback when the file is renamed or changed
</strong> <code>fs.watchFile</code> invokes callback when the file is accessed, including write and read.<br>So you need to compare the mtime of the <code>fstat</code>, file is changed when mtime changed.</li>
<li>Response time<br><strong> <code>fs.watch</code> uses <code>event</code>, which captures the “change” almost in realtime.
</strong> <code>fs.watchFile</code> uses ‘polling’, which might differed for a period of time. By default, the maximum could be 5s.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/" data-id="cimz2njhz003vvksi037gmc95" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fswatcher/">FSWatcher</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/change/">change</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/editor/">editor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fs-watch/">fs.watch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby-mine/">ruby mine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/watch/">watch</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-css-trick-place-scrollbar-outside-of-the-client-area" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/" class="article-date">
  <time datetime="2012-10-26T00:00:00.000Z" itemprop="datePublished">2012-10-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/">CSS trick: Place Scrollbar outside of the client area</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today, I found a interesting difference between padding and margin when I’m working on Metrics 2.0 Introduction page. There are several <code>VideoThumbnail</code> widget on the page, which contains a video snapshot and a paragraph text description.<br>Here is the Html DOM of the widget, written in Haml:</p>
<figure class="highlight haml"><figcaption><span>VideoThumbnail Widget Html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">%<span class="selector-tag">li</span><span class="selector-class">.span4</span></span></span><br><span class="line"><span class="tag">  %<span class="selector-tag">a</span><span class="selector-class">.thumbnail</span><span class="selector-class">.new</span>(data-<span class="attr">widget</span>=<span class="string">"IntroductionPage.VideoThumbnail"</span>)</span></span><br><span class="line">    .snapshot-container</span><br><span class="line"><span class="tag">      %<span class="selector-tag">img</span><span class="selector-class">.snapshot</span>&#123; src: snapshot &#125;</span></span><br><span class="line"><span class="tag">      %<span class="selector-tag">img</span><span class="selector-class">.status</span>(<span class="attr">src</span>=<span class="string">"/assets/new.png"</span> )</span></span><br><span class="line">    .caption</span><br><span class="line">      .title</span><br><span class="line"><span class="tag">        %<span class="selector-tag">h3</span></span> #&#123;<span class="ruby">index&#125;</span>. #&#123;<span class="ruby">title&#125;</span></span><br><span class="line"><span class="tag">      %<span class="selector-tag">p</span><span class="selector-class">.description</span></span> #&#123;<span class="ruby">description&#125;</span></span><br></pre></td></tr></table></figure>
<p>Since the description could be very short or very long, so I make the div that contains the description scrollable, so I wrote the following stylesheet for caption div:</p>
<figure class="highlight scss"><figcaption><span>VideoThumbnail Widget Stylesheet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.caption</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">9px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">150px</span>;</span><br><span class="line">  <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The style looks fine, and here is how it looks:</p>
<img src="/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/widget.png" alt="Wiget" title="Wiget">
<p>But very soon, I found the widget with scrollbar is taller than the one without it, it is because padding on 2 elements next to each other will not be merged: <strong>Red rect in following snapshot</strong></p>
<img src="/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/padding.png" alt="Padding" title="Padding">
<p>It is caused because padding will not merged together as margin does, To solve the issue, I changed the padding to margin in the stylesheet:</p>
<figure class="highlight scss"><figcaption><span>VideoThumbnail Widget Stylesheet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.caption</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">9px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">150px</span>;</span><br><span class="line">  <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But bottom margin is corrected, but I found the scrollbar begin to occupy the space of content, which is not good! <strong>The center widget uses padding(Blue) and the right one uses margin(Red)</strong></p>
<img src="/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/margin.png" alt="Margin" title="Margin">
<p>And I remember if I uses padding, the scrollbar takes the space of right padding; but if I use margin, it takes the space of the content. So I update the stylesheet in this way:</p>
<figure class="highlight scss"><figcaption><span>VideoThumbnail Widget Stylesheet</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.caption</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">9px</span> <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">9px</span> <span class="number">0</span> <span class="number">9px</span> <span class="number">9px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">150px</span>;</span><br><span class="line">  <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/padding_margin_mixing.png" alt="Padding Margin Mixing" title="Padding Margin Mixing">
<p>I use padding on the right but uses margin on other side, so vertical scrollbar will take the right padding when necessary. It is a very interesting CSS trick, and it works fine under webkit based browser.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/" data-id="cimz2njhx003svksihsg56he8" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/10/26/css-trick-place-scrollbar-outside-of-the-client-area/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/css/">css</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/margin/">margin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/overflow/">overflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/padding/">padding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scroll/">scroll</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pitfall-in-nokogiri-xpath-and-namespace" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/10/25/pitfall-in-nokogiri-xpath-and-namespace/" class="article-date">
  <time datetime="2012-10-25T00:00:00.000Z" itemprop="datePublished">2012-10-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/10/25/pitfall-in-nokogiri-xpath-and-namespace/">Pitfall in Nokogiri XPath and Namespace</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>Nokogiri</code> is a really popular Xml and Html library for Ruby. People loves <code>Nokogiri</code> is not just because it is powerful and fast, the most important is its flexible and convenient.<br><code>Nokogiri</code> works perfect in most aspects, but there is a big pitfall when handling the xml namespace!</p>
<p>I met a super weird issue when processing xml returned by Google Data API, and the API returns the following xml document:<br><figure class="highlight xml"><figcaption><span>API response</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">feed</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2005/Atom"</span> <span class="attr">xmlns:media</span>=<span class="string">"http://search.yahoo.com/mrss/"</span> <span class="attr">xmlns:yt</span>=<span class="string">"http://gdata.youtube.com/schemas/2007"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">media:group</span>&gt;</span>(...)<span class="tag">&lt;/<span class="name">media:group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">yt:position</span>&gt;</span>1<span class="tag">&lt;/<span class="name">yt:position</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">media:group</span>&gt;</span>(...)<span class="tag">&lt;/<span class="name">media:group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">yt:position</span>&gt;</span>2<span class="tag">&lt;/<span class="name">yt:position</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">media:group</span>&gt;</span>(...)<span class="tag">&lt;/<span class="name">media:group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">yt:position</span>&gt;</span>3<span class="tag">&lt;/<span class="name">yt:position</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">media:group</span>&gt;</span>(...)<span class="tag">&lt;/<span class="name">media:group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">yt:position</span>&gt;</span>4<span class="tag">&lt;/<span class="name">yt:position</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">feed</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>I instantiated a <code>Nokogiri::XML</code> DOM with the xml document, and then I try to query the DOM with XPath: <code>xml_dom.xpath &#39;//entry&#39;</code>:</p>
<figure class="highlight ruby"><figcaption><span>Query DOM</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xml_dom = Nokogiri::XML Faraday.get api_url</span><br><span class="line">entries = xml_dom.xpath <span class="string">'//entry'</span></span><br></pre></td></tr></table></figure>
<p>I’m expecting <code>entries</code> is an array with 4 elements, but actually it is empty array. After a few tries, I found the query yields empty array when I introduce the element name in the query.</p>
<figure class="highlight ruby"><figcaption><span>Try Xpath Queries</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml_dom.xpath <span class="string">'.'</span> <span class="comment"># returns document</span></span><br><span class="line">xml_dom.xapth <span class="string">'//.'</span> <span class="comment"># returns all element nodes</span></span><br><span class="line">xml_dom.xpath <span class="string">'/feed'</span> <span class="comment"># returns empty array</span></span><br><span class="line">xml_dom.xpath <span class="string">'//entry'</span> <span class="comment"># returns empty array</span></span><br><span class="line">xml_dom.xpath <span class="string">'//media:group'</span>, <span class="string">'media'</span> =&gt; <span class="string">'http://search.yahoo.com/mrss/'</span> <span class="comment"># returns 4 the media:group nodes</span></span><br></pre></td></tr></table></figure>
<p>It is super weird.</p>
<p>After half an hour fighting against the Nokogiri, I begin to realize that it must be related to the namespace.<br>And I found that there is an attribute applied to the root element of the document: <code>xmlns=&quot;http://www.w3.org/2005/Atom&quot;</code>, which means all the elements without explicit namespace declaration in the xml dom are under the namespace <code>http://www.w3.org/2005/Atom</code> by default.</p>
<p>And for some reason, the XPath query is namespace sensitive! It requires the <strong>full name</strong> rather than the <strong>local name</strong>, which means we should query the DOM with the code: <code>xml_dom.xpath &#39;//atom:entry&#39;, &#39;atom&#39; =&gt; &#39;http://www.w3.org/2005/Atom&#39;</code>.</p>
<figure class="highlight ruby"><figcaption><span>Fixed XPath Queries</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml_dom.xpath <span class="string">'.'</span> <span class="comment"># returns document</span></span><br><span class="line">xml_dom.xapth <span class="string">'//.'</span> <span class="comment"># returns all element nodes</span></span><br><span class="line">xml_dom.xpath <span class="string">'/atom:feed'</span>, <span class="string">'atom'</span> =&gt; <span class="string">'http://www.w3.org/2005/Atom'</span> <span class="comment"># returns root node</span></span><br><span class="line">xml_dom.xpath <span class="string">'//atom:entry'</span>, <span class="string">'atom'</span> =&gt; <span class="string">'http://www.w3.org/2005/Atom'</span> <span class="comment"># returns 4 entry nodes</span></span><br><span class="line">xml_dom.xpath <span class="string">'//media:group'</span>, <span class="string">'media'</span> =&gt; <span class="string">'http://search.yahoo.com/mrss/'</span> <span class="comment"># returns 4 the media:group nodes</span></span><br></pre></td></tr></table></figure>
<p>So in a sentence: XPath in <code>Nokogiri</code> doesn’t inherit the default namespace, so when query the DOM with default namespace, we need to explicitly specify the namespace in XPath query. It is really a hidden requirement and is very likely to be ignored by the developers!</p>
<p>So if there is no naming collision issue, it is recommeded to avoid this kind of “silly” issues by removing the namespaces in the DOM. <code>Nokogiri::XML::Document</code> class provides <code>Nokogiri::XML::Document#remove_namespaces!</code> method to achieve this goal.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/10/25/pitfall-in-nokogiri-xpath-and-namespace/" data-id="cimz2njhv003pvksimw9fdb9g" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/10/25/pitfall-in-nokogiri-xpath-and-namespace/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/namespace/">namespace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nokogiri/">nokogiri</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xpath/">xpath</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-weird-def-behaves-different-in-class-eval-and-instance-eval" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/31/weird-def-behaves-different-in-class-eval-and-instance-eval/" class="article-date">
  <time datetime="2012-08-31T00:00:00.000Z" itemprop="datePublished">2012-08-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/31/weird-def-behaves-different-in-class-eval-and-instance-eval/">Weird! &quot;def&quot; behaves different in class_eval and instance_eval</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I found the behavior of keyword <code>def</code> in ruby is really confusing! At least, really confusing to me!<br>In most case, we use <code>def</code> in <code>class</code> context, then it defines a instance method on specific class.</p>
<figure class="highlight ruby"><figcaption><span>Use def in class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span></span><br><span class="line">    <span class="symbol">:foo</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  $context = <span class="keyword">self</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Foo.new.foo.should == <span class="symbol">:foo</span></span><br><span class="line">$context.should == Foo</span><br></pre></td></tr></table></figure>
<p>Besides the typical usage, we can also use <code>def</code> in block.</p>
<figure class="highlight ruby"><figcaption><span>Use def in class_eval block</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Foo.class_eval <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span></span><br><span class="line">    <span class="symbol">:foo</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  $context = <span class="keyword">self</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Foo.new.foo.should == <span class="symbol">:foo</span></span><br><span class="line">$context.should == Foo</span><br></pre></td></tr></table></figure>
<p>This previous piece of code works as we reopened the class <code>Foo</code>, and add a new method to it. It is also not hard to understand.</p>
<p>The fact that really surprised me is in the following code:</p>
<figure class="highlight ruby"><figcaption><span>Use def in instance_eval block</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Foo.instance_eval <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span></span><br><span class="line">    <span class="symbol">:foo</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  $context = <span class="keyword">self</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Foo.foo.should == <span class="symbol">:foo</span> <span class="comment"># Method foo goes into the Foo class itself rather than Foo's instance!</span></span><br><span class="line">$context.should == Foo</span><br></pre></td></tr></table></figure>
<p>Here we can found that method foo goes into the <code>Foo</code> class itself, rather than <code>Foo</code>‘s instance! But the $context is still <code>Foo</code> class!</p>
<p>So in a word, calling <code>def foo</code> in <code>instance_eval</code> block is equivalent to calling ‘def self.foo’ in <code>class_eval</code> block, even though the context of both block are the class itself.<br>So we can figure out that keyword <code>def</code> works different than method <code>define_method</code> and <code>define_singleton_method</code>, since it doesn’t depend on self, but the two methods does!</p>
<p>To me it is kind of hard to understand. and confusing. And I think it is not a good design!<br>Ruby is different to other Java or C#, ruby uses methods on class to take place of the keywords in other languages, such as public, protected and private. In most of the language, they are keywords. But in ruby they are actually the class methods of Class.<br>This design is good, because it is kind of enabled the developer to extend the “keyword” they can use! But at the same time, this design melted the boundary between customizable methods and predefined keywords, so people won’t pay much attention to the difference of the two. So it is important to keep the consistency between methods and keyword behaviors. But <code>def</code> breaks the consistency, so it is confusing!</p>
<p>Look the following code:</p>
<figure class="highlight ruby"><figcaption><span>def vs define_method</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">definition_block = Proc.new <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span></span><br><span class="line">    <span class="symbol">:foo</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  define_method <span class="symbol">:bar</span> <span class="keyword">do</span></span><br><span class="line">    <span class="symbol">:bar</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">A.class_eval &amp;definition_block</span><br><span class="line">B.instance_eval &amp;definition_block</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Comparing class <code>A</code> and class <code>B</code>, we can find that they are different, even they are defined with exactly same block!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/31/weird-def-behaves-different-in-class-eval-and-instance-eval/" data-id="cimz2njht003mvksiqmhxnjxj" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/08/31/weird-def-behaves-different-in-class-eval-and-instance-eval/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/class-eval/">class_eval</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/comparison/">comparison</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/define-method/">define method</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/instance-eval/">instance_eval</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/meta-programming/">meta programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-introduce-prototype-style-oo-inheritance-in-ruby" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/26/introduce-prototype-style-oo-inheritance-in-ruby/" class="article-date">
  <time datetime="2012-08-26T00:00:00.000Z" itemprop="datePublished">2012-08-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/26/introduce-prototype-style-oo-inheritance-in-ruby/">Introduce Prototype Style OO inheritance in Ruby</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Days ago, I post a blog about the ruby inheritance hierarchy. When discuss the topic with Yang Lin, he mentioned a crazy but interesting idea that introducing the prototype based OO into ruby.<br>To introducing the prototype OO into ruby, Lin mentioned a possible approach is by using clone. But I’m not familiar with clone mechanism in ruby. So I tried another approach.<br>Thanks to Ruby’s super powerful meta-programming mechanism, so I can forward the unknown message to prototype by using method_missing. And I encapsulate the code in a module, so every instance extended that module will obtain such capability.</p>
<figure class="highlight ruby"><figcaption><span>Prototype Module</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Prototype</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">inherit_from</span><span class="params">(prototype)</span></span></span><br><span class="line">    @prototype = prototype</span><br><span class="line">    <span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create_child</span></span></span><br><span class="line">    Object.new.extend(Prototype).inherit_from(<span class="keyword">self</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">respond_to?</span><span class="params">(msg_id, priv = <span class="literal">false</span>)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">if</span> <span class="keyword">super</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> @prototype</span><br><span class="line">      @prototype.respond_to?(msg_id, priv)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(symbol, *args, &amp;block)</span></span></span><br><span class="line">    <span class="keyword">if</span> @prototype</span><br><span class="line">      @prototype.send(symbol, *args, &amp;block)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">super</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">new</span></span></span><br><span class="line">    Object.new.extend(Prototype)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>If I have the following code:</p>
<figure class="highlight ruby"><figcaption><span>Prototype Inheritance</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = Object.new</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span>.<span class="title">foo</span></span></span><br><span class="line">  <span class="string">'foo'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">b = Object.new</span><br><span class="line">b.extend(Prototype).inherit_from(a)</span><br><span class="line"></span><br><span class="line">c = b.create_child</span><br><span class="line"></span><br><span class="line">p b.foo <span class="comment"># =&gt; 'foo'</span></span><br><span class="line">p c.foo <span class="comment"># =&gt; 'foo'</span></span><br></pre></td></tr></table></figure>
<p>So <code>b.foo</code> and <code>c.foo</code> will yield ‘foo’.</p>
<p>And I can override the parent implementation by refine a method with the same name:<br><figure class="highlight ruby"><figcaption><span>Prototype Overrides</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span>.<span class="title">bar</span></span></span><br><span class="line">  <span class="string">'bar'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c</span>.<span class="title">bar</span></span></span><br><span class="line">  <span class="string">'c.bar'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">p a.bar <span class="comment"># =&gt; 'bar'</span></span><br><span class="line">p b.bar <span class="comment"># =&gt; 'bar'</span></span><br><span class="line">p c.bar <span class="comment"># =&gt; 'c.bar'</span></span><br></pre></td></tr></table></figure></p>
<p>So I add a new singleton method <code>bar</code> in <code>a</code>, and <code>b</code> automatically inherits the method, and I override the <code>bar</code> on object <code>c</code>.</p>
<p>As a conclusion that we’re able to introduce the prototype based inheritance in ruby by using ruby’s powerful meta-programming mechanism. This implementation is only for concept-proof, so its performance is not quite good. But we can try to improve the performance by consolidating process by defining the method dynamically. The child object will query the parent for the first time, if invoking succeeded then it can consolidate the behavior into a method to avoid calling method_missing every time.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/26/introduce-prototype-style-oo-inheritance-in-ruby/" data-id="cimz2njhs003kvksi5gozgjp3" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/08/26/introduce-prototype-style-oo-inheritance-in-ruby/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/object-oriented/">object oriented</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/prototype/">prototype</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ruby-class-inheritance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/23/ruby-class-inheritance/" class="article-date">
  <time datetime="2012-08-23T00:00:00.000Z" itemprop="datePublished">2012-08-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/23/ruby-class-inheritance/">Ruby Class Inheritance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I just realize I have misunderstood the ruby “class methods” for quite a long time!</p>
<p>Here is a piece of code:<br><figure class="highlight ruby"><figcaption><span>Instance Methods Inheritance</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">foo</span></span></span><br><span class="line">    <span class="string">'foo'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a = A.new</span><br><span class="line">b = B.new</span><br><span class="line"></span><br><span class="line">a.foo.should == <span class="string">'foo'</span></span><br><span class="line">b.foo.should == <span class="string">'foo'</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>The previous piece of code demonstrated the typical inheritance mechanism in almost every Class-Object style OO language (There are a few exceptions, which are Prototype inheritance. Such as JavaScript, but it is also a miracle that whether Javascript is OO language XD).<br>In most common OO languages, this is what inheritance about! But in Ruby, things is not that easy! Great thanks to Ruby’s eigen-class (aka Singleton class or Metaclass)</p>
<p>In ruby, I just found that derived class not just inherits the instance methods but also the class methods! It is kind of surprise to me!<br><figure class="highlight ruby"><figcaption><span>Class Methods Inheritance</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">bar</span></span></span><br><span class="line">    <span class="string">'bar'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">A.bar.should == <span class="string">'bar'</span></span><br><span class="line">B.bar.should == <span class="string">'bar'</span></span><br></pre></td></tr></table></figure></p>
<p>For most people who knows Java or C# or even C++, who won’t be surprised about <code>A.bar.should == &#39;bar&#39;</code>, but you might feel surprised about <code>B.bar.should == &#39;bar&#39;</code> like I do.</p>
<p>To me, bar is declared on class A, B inherits A, than I can even call method declared on class A on class B! It is amazing!</p>
<p>Since in ruby, “class method” is actually the instance method of the eigen-class of the class. And <code>def self.foo</code> is just a syntax sugar. So we can rewrite the code as:</p>
<figure class="highlight ruby"><figcaption><span>Rewriten Class Methods Inheritance</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; A</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bar</span></span></span><br><span class="line">    <span class="string">'bar'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">A.bar.should == <span class="string">'bar'</span></span><br><span class="line">B.bar.should == <span class="string">'bar'</span></span><br></pre></td></tr></table></figure>
<p>If we call A’s eigen-class AA, and B’s eigen-class BB. Then we will found that <code>BB.superclass == AA</code></p>
<figure class="highlight ruby"><figcaption><span>BB and AA</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">AA = <span class="class"><span class="keyword">class</span> &lt;&lt; A;</span> <span class="keyword">self</span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">BB = <span class="class"><span class="keyword">class</span> &lt;&lt; B;</span> <span class="keyword">self</span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">B.superclass.should == A</span><br><span class="line">BB.superclass.should == AA</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>And we know <code>A</code> is actually an instance of <code>AA</code>, and <code>B</code> is an instance of <code>BB</code>, so obviously  on <code>B</code> we can call the instance methods defined on <code>AA</code>.<br>That’s the reason why class method in Ruby can be inherited!</p>
<p>But there are so inconsistency in Ruby, that <code>AA</code> is the superclass of <code>BB</code>, but you won’t be able to found <code>AA</code> in <code>BB</code>‘s ancestors! In fact, <code>BB.ancestors</code> might yield something similar to <code>[Class, Module, Object, BasicObject, Kernel]</code> if not any module is injected to Class, Module, Object</p>
<figure class="highlight ruby"><figcaption><span>Inconsistency</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">AA = <span class="class"><span class="keyword">class</span> &lt;&lt; A;</span> <span class="keyword">self</span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">BB = <span class="class"><span class="keyword">class</span> &lt;&lt; B;</span> <span class="keyword">self</span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">BB.superclass.should == AA</span><br><span class="line">BB.ancestors.should_not includes AA</span><br><span class="line"></span><br><span class="line"><span class="comment"># BB.ancestors == [Class, Module, Object, BasicObject, Kernel]</span></span><br></pre></td></tr></table></figure>
<p>This design is wield to me, and kind of hard to understand, so for quite a long time, I don’t even know class methods in ruby can be inherited!<br>I drew a graph to show the relationship about the classes, in graph I use <code>&lt;class:A&gt;</code> to indicate the class is the eigen class of <code>A</code>. And the line with a empty triangle to represents the inheritance, and arrow line to represents the instantiation.<br>And this graph is not a complete one, I omitted some unimportant classes, and I uses the dot line to indicate that something is missing on the line.</p>
<img src="/blog/2012/08/23/ruby-class-inheritance/Inheritance-Hierarchy.png" alt="Inheritance Hierarchy" title="Inheritance Hierarchy">

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/23/ruby-class-inheritance/" data-id="cimz2njhq003hvksibs3xbqgl" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/08/23/ruby-class-inheritance/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/class/">class</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/class-methods/">class methods</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/eigenclass/">eigenclass</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inheritance/">inheritance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inheritance-hierarchy/">inheritance hierarchy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pitfall-when-return-string-in-via-json-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/" class="article-date">
  <time datetime="2012-08-15T00:00:00.000Z" itemprop="datePublished">2012-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/">pitfall when return string in via json in rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today we met a weird problem when return a string via json.</p>
<p>Here is the coffee script code:</p>
<figure class="highlight coffeescript"><figcaption><span>Front End</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$.post serverUrl, data, <span class="function"><span class="params">(status)</span> -&gt;</span></span><br><span class="line">	<span class="built_in">console</span>.log status</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>And here is our controller:</p>
<figure class="highlight ruby"><figcaption><span>Backend Action</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span></span></span><br><span class="line">	<span class="comment"># do some complex logic</span></span><br><span class="line"></span><br><span class="line">	render <span class="symbol">json:</span> <span class="string">"success"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Code looks perfect, but we found that the callback is never called! When we check the network traffic, you will found that server does send its response “success”, but the callback is not called!</p>
<p>After spending half an hour to struggle against the jQuery, we finally find the problem!</p>
<p>The reason is that <code>success</code> is not a valid json data! A valid json string should be quoted with “”, or JSON parser will treat it as token, like true or false or nil.</p>
<p>So to fix the problem, we need to change our action code:</p>
<figure class="highlight ruby"><figcaption><span>Fixed Backend Action</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span></span></span><br><span class="line">	<span class="comment"># do some complex logic</span></span><br><span class="line"></span><br><span class="line">	render <span class="symbol">json:</span> <span class="string">'"success"'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This is really a pitfall, since the wrong code looks so nature!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/" data-id="cimz2njhn003evksiyp42q039" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/08/15/pitfall-when-return-string-in-via-json-in-rails/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/json/">json</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pretty-singleton-in-ror-app" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/05/pretty-singleton-in-ror-app/" class="article-date">
  <time datetime="2012-08-05T00:00:00.000Z" itemprop="datePublished">2012-08-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/05/pretty-singleton-in-ror-app/">Pretty Singleton in RoR app</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Thanks to Ruby powerful meta programming capability and Rails <code>delegate</code> syntax, we can easily write graceful singleton class which makes the class works like a instance.</p>
<p>In traditional language such as C#, usually we write singleton code like this:</p>
<figure class="highlight c"><figcaption><span>Singleton in C##</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Foo</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Singleton Declaration</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> readonly Foo instance;</span><br><span class="line">	pubilc <span class="keyword">static</span> Foo Instance</span><br><span class="line">	&#123;</span><br><span class="line">		get</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(instance == null)</span><br><span class="line">			&#123;</span><br><span class="line">				instance = new Foo();</span><br><span class="line">			&#125;</span><br><span class="line">			return instance;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Define instance behaviors</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The previous approach works fine but the code that uses <code>Foo</code> will be kind of ugly. Every time when we want to invoke the method <code>Bar</code> on <code>Foo</code>, we need to write <code>Foo.Instance.Bar()</code> rather than more graceful way <code>Foo.Bar()</code>.<br>To solve this problem we need implement the class in this way:</p>
<figure class="highlight c"><figcaption><span>Class Delegation in C##</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> Foo</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Singleton Declaration</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Define instance behaviors</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Bar</span><span class="params">()</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		<span class="comment">// Bar behaviors</span></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Bar</span><span class="params">()</span></span><br><span class="line">	</span>&#123;</span><br><span class="line">		Instance.Bar();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> Baz</span><br><span class="line">	&#123;</span><br><span class="line">		get &#123; <span class="comment">/* Getter behavior */</span>	&#125;</span><br><span class="line">		<span class="built_in">set</span> &#123; <span class="comment">/* Setter behavior */</span>	&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> Baz</span><br><span class="line">	&#123;</span><br><span class="line">		get &#123; return Instance.Baz;	&#125;</span><br><span class="line">		<span class="built_in">set</span> &#123; Instance.Baz = value;	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This approach simplified the caller code but complicated the declaration. You can use some trick such as Code-Snippet or code generating technology such as Text Template or CodeSmith to generate the dull delegation code. But it is still not graceful at all.</p>
<p>If we write same code in ruby, things become much easier, great thanks to Ruby’s powerful meta programming capability.</p>
<figure class="highlight ruby"><figcaption><span>Singleton in Ruby</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># foo.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line">	extend ActiveSupport::Autoload</span><br><span class="line"></span><br><span class="line">	autoload <span class="symbol">:Base</span></span><br><span class="line">	<span class="keyword">include</span> Base</span><br><span class="line"></span><br><span class="line">	autoload <span class="symbol">:ClassMethods</span></span><br><span class="line">	extend ClassMethods</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo/base.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo::Base</span></span></span><br><span class="line">	<span class="comment"># Define instance behaviors</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo/class_methods.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo::ClassMethods</span></span></span><br><span class="line">	<span class="comment"># Singleton Declaration</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">instance</span></span></span><br><span class="line">		@instance <span class="params">||</span>= new</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	delegate *Foo::Base.instance_methods, <span class="symbol">:to</span> =&gt; <span class="symbol">:instance</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>So in ruby solution we just use one statement <code>delegate *Foo::Base.instance_methods, :to =&gt; :instance</code> then delegate all methods defined in base to instance.</p>
<p>Besides this solution, there is also another kind of cheaper but working solution:<br><figure class="highlight ruby"><figcaption><span>Singleton in Ruby</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># foo.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"></span><br><span class="line">	autoload <span class="symbol">:Base</span></span><br><span class="line">	<span class="keyword">include</span> Base</span><br><span class="line">	extend Base</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># foo/base.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo::Base</span></span></span><br><span class="line">	<span class="comment"># Define instance behaviors</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>Two different approaches make the code behaves slightly different, but anyway they both works.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/05/pretty-singleton-in-ror-app/" data-id="cimz2njhl003bvksiwwxtsmfw" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/08/05/pretty-singleton-in-ror-app/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pattern/">pattern</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sigleton/">sigleton</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-extend-rspec-dsl" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/08/05/extend-rspec-dsl/" class="article-date">
  <time datetime="2012-08-05T00:00:00.000Z" itemprop="datePublished">2012-08-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/08/05/extend-rspec-dsl/">Extend RSpec DSL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m working on a project that need some complicated html snippets for test, which cannot be easily generated with factory. So I put these snippets into fixture files.</p>
<p>RSpec provides a very convenient DSL keyword <code>let</code>, which allow us to define something for test and cached it in the same test. And I want I could have some similar keyword for my html fixtures. To achieve this goal I decide to extend DSL.</p>
<p>So I created module which contains the new DSL I want to have:</p>
<figure class="highlight ruby"><figcaption><span>DSL module</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># spec/support/html_pages.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">HtmlPages</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">load_html</span><span class="params">(name)</span></span></span><br><span class="line">    let name <span class="keyword">do</span></span><br><span class="line">      file = Rails.root.join(<span class="string">'spec/html_pages'</span>, <span class="string">"<span class="subst">#&#123;name&#125;</span>.html"</span>)</span><br><span class="line">      Nokogiri::Html File.read(file)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Put this file into the path <code>spec/support</code>, by default, <code>spec_helper.rb</code> would require this file for you.<br>Then we should tell rspec to load the DSL into test cases.</p>
<figure class="highlight rb"><figcaption><span>Load DSL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RSpec.configure <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	config.extend HtmlPages</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>By telling <code>config</code> to extend the module, our DSL will be loaded as the class methods of <code>RSpec::Core::ExampleGroup</code>, where <code>let</code> is being defined.</p>
<p>HINT: Rspec config has another way to extend DSL by calling <code>config.include</code>. Then the DSL methods will be injected into the test example group instance, then these methods can be used in the test cases. That’s how runtime DSLs like FactoryGirl work.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/08/05/extend-rspec-dsl/" data-id="cimz2njhh0034vksig2ft7b21" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/08/05/extend-rspec-dsl/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dsl/">dsl</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/extend/">extend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rspec/">rspec</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spec/">spec</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/test/">test</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unit-test/">unit test</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-postgres-multiple-schema-database-in-rails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/" class="article-date">
  <time datetime="2012-07-17T00:00:00.000Z" itemprop="datePublished">2012-07-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/ruby/">Ruby</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/">Use Postgres Multiple Schema Database in Rails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Postgres provided a very interesting feature called “Schema” in addition to other “normal” database features, which provide a extra layer between database and tables. So with schema, you can have tables with same name in one database, if they are in different schemas.<br>To me schema is not a good idea! I assume “table-space” or even “namespace” could be a better name. In fact, there are a number of people agree that schema is not a good name:<br><blockquote><p>“Schema” is such a terrible name for this feature. When most people hear the term “schema” they think of a data definition of some sort. This is not what PostgreSQL schemas are. I’m sure the PostgreSQL devs had their reasons, but I really wish they would have named it more appropriately. “Namespaces” would have been apropos.</p>
<p>Anywho, the easiest way for me to describe PostgreSQL schemas (besides telling you that they are, indeed, namespaces for tables) is to relate them to the UNIX execution path. When you run a UNIX command without specifying its absolute path, your shell will work its way down the $PATH until it finds an executable of the same name.</p>
<footer><strong>Jerod Santo</strong><cite><a href="http://blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas/" target="_blank" rel="external">blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas</a></cite></footer></blockquote><br>And you can find more <a href="http://goo.gl/ghj4e" target="_blank" rel="external">here</a></p>
<p>And there is a popular routine is to use the postgres schema for sub-domains. For example, you’re a BSS provider, you rend your BBS apps to different organizations. To the organizations. they want to have its own BBS app instance running independently, the most important is that data should be stored into separated spaces, and could be accessed from its own domain name. But to you, for administration, you want they share the same backend management console.<br>In this case the best way to solve the problem is to store the data owned by different subsystem into different schemas. But store all the administration data into a single schema or even in public schema.<br>The same guy Jerod has a <a href="http://blog.jerodsanto.net/2011/07/building-multi-tenant-rails-apps-with-postgresql-schemas/" target="_blank" rel="external">post</a> described how to build this kind of system in details. There are a bunch of posts described how to build the system like this, which could be found by <a href="http://goo.gl/HaByF" target="_blank" rel="external">googling</a> easily.<br>And there is even a <a href="https://github.com/bradrobertson/apartment" target="_blank" rel="external">ruby gem called apartment</a> from Brad Robertson to support this kind of system</p>
<p>This idea looks fancy, but unless you 10000% certain that the sub-systems will keep its independent status and without any collaboration forever.<br>Or it sooner or later, you will find the “fancy idea” become a horrible idea.<br>When time goes by, there could be more and more and more features that required to add collaboration between sub-systems. Such as provide a unified authentication mechanism, so user can logged in once and switch between different systems easily. Or administrator might ask for a unified statistics graph for all sub-systems.<br>All these requirements are related to cross-schema query! To be honest, cross query in some cases could be painful!<br>And it brings trouble to all aspects in your system, such as data migration, test data generation, etc.</p>
<p>That’s what exactly happens in my current project!<br>My current project is Rails 3 project, the codebase is brand new but built on a legacy multiple schema postgres database. And for some reason,<br>we must keep the multiple schema design unchanged. But our goal is to unify the separated subsystem into a more closed-collaborated system.</p>
<p>Since ActiveRecord in Rails doesn’t include the native support to this fancy feature. Which means you will met problem during migration, or even preparing test data with factory-girl.</p>
<p>Postgres allows to locate the table in different schemas with full qualified name like this <code>&lt;schema name&gt;.&lt;table name&gt;.&lt;column name&gt;</code>. The schema name is optional, when you omitted the schema name, Postgres will search the table in a file-system-path-like order called “<a href="http://www.postgresql.org/docs/8.1/static/ddl-schemas.html#DDL-SCHEMAS-PUBLIC" target="_blank" rel="external">search-path</a>“.</p>
<p>And you can set and query current search path with Postgres SQL statements:</p>
<figure class="highlight sql"><figcaption><span>Query and Set search_path</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> search_path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> search_path <span class="keyword">TO</span> &lt;new_search_path&gt;;</span><br></pre></td></tr></table></figure>
<p>Since ActiveRecord won’t add the full qualified schema name in front of the table name when it translate the ARel into SQL statements. So we can only support the multiple schema database with the search_path.</p>
<p>Basically, it is a very natural idea that you can use the following ruby code to make ActiveRecord make query on different schemas:</p>
<figure class="highlight ruby"><figcaption><span>Select Schema</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_schema_to_search_path</span><span class="params">(schema)</span></span></span><br><span class="line">  ActiveRecord::Base.connection.execute <span class="string">"SET search_path TO <span class="subst">#&#123;schema&#125;</span>, public;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restore_search_path</span></span></span><br><span class="line">  ActiveRecord::Base.connection.execute <span class="string">"SET search_path TO public;"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This two methods work perfect when querying things from the database. But sooner or later, you will run into big trouble when you try to write data into database.</p>
<p>In db migration or use factory_girl to generate test fixtures, you might found that the data you insert in different schemas finally goes into <strong>the first non-public schema</strong>. But all the query still works perfect!</p>
<p>We found this problem occurs when the following conditions are satisfied:</p>
<ol>
<li>Query are happened in a Transaction.</li>
<li>You insert data into multiple non-public schemas.</li>
<li>You user <code>SET search_path TO</code> SQL statement to switch between schema rather than explicitly using full-qualified table name.</li>
</ol>
<p>And the most interesting thing is that:</p>
<ol>
<li>All the <code>SELECT</code> queries are executed on schemas correctly</li>
<li>If you use <code>SHOW search_path;</code> to query current search path, you will got correct search path value.</li>
<li>All data are inserted into first <code>non-public</code> schema that you actually wrote data into. So which means it you try to insert data into public schema, it won’t go wrong. Or you switched to a non-public schema, but actually you doesn’t insert any rows, it also won’t be impacted.</li>
</ol>
<p>To solve this problem, I spent 2 nights and 2 days to digged into the source code of ActiveRecord gem and pg gem (the Postgres database adapter).<br>And finally I solved the problem by using the attribute on PostgreSQLAdapter.</p>
<p>Basically, instead of using the SQL query, you should use the <code>PostgreSQLAdapter#schema_search_path</code> and <code>PostgreSQLAdapter#schema_search_path=</code> to get and set the search path.<br>And if you dig into the source code, you will find the two methods does the exact same thing as we did except it assigned one more instance variable <code>@schema_search_path</code>.</p>
<figure class="highlight ruby"><figcaption><span>methods on PostgreSQLAdapter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Sets the schema search path to a string of comma-separated schema names.</span></span><br><span class="line"><span class="comment"># Names beginning with $ have to be quoted (e.g. $user =&gt; '$user').</span></span><br><span class="line"><span class="comment"># See: http://www.postgresql.org/docs/current/static/ddl-schemas.html</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This should be not be called manually but set in database.yml.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schema_search_path=</span><span class="params">(schema_csv)</span></span></span><br><span class="line">  <span class="keyword">if</span> schema_csv</span><br><span class="line">    execute(<span class="string">"SET search_path TO <span class="subst">#&#123;schema_csv&#125;</span>"</span>, <span class="string">'SCHEMA'</span>)</span><br><span class="line">    @schema_search_path = schema_csv</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Returns the active schema search path.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schema_search_path</span></span></span><br><span class="line">  @schema_search_path <span class="params">||</span>= query(<span class="string">'SHOW search_path'</span>, <span class="string">'SCHEMA'</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The most interesting thing is if you search the reference to <code>@schema_search_path</code>, you will find it is only used as a local cache of current search_path in the adapter, and it is initialized with the value from the query <code>SHOW search_path;</code> if it is nil, and then keep the value as the cache!<br>This implementation is buggy and caused the problems described before!</p>
<p>If we use the SQL query to set the search path rather than calling <code>schema_search_path=</code>, we won’t set the <code>@schema_search_path</code> at sametime, ideally this value will remain nil by default. Then transaction or other object in ActiveRecord call <code>schema_search_path</code> to get current search path. The first time, the variable <code>@@schema_search_path</code> is nil, and will be initialized by the value from query <code>SHOW search_path;</code> and then won’t changed any more, since in the future this query won’t be executed any longer.<br>As a result, the schema will be switched successfully for the first time, but failed in the following.</p>
<p>Which means at current stage, if you want to change search_path, the only correct way is to use <code>PostgreSQLAdapter#schema_search_path=</code>, and PLEASE PLEASE ignore the warning <code>&quot;This should be not be called manually but set in database.yml.&quot;</code> in the source code! It is really a misleading message!</p>
<p>I understand current implementation is for performance consideration, but caching the value is absolutely not a good idea when you cannot keep things in sync and the sync is critical in some cases.<br>I’m planning to fix this issue in rails codebase and create a pull request to rails maintainer. Wish they could accept this fix. Or at least they should change the warning message.</p>
<p>And besides of using the out-dated and mysterious PgTools mentioned in a lot of posts (I saw a lot of people mentioned this class, but I cannot find it anywhere even I from google or github. It is really a mystery). I create a new utility module called MultiSchema.</p>
<script src="//gist.github.com/3129392.js"></script>
<p>You can use it as the utility class in the old-fashioned way:</p>
<figure class="highlight ruby"><figcaption><span>Procedure usage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MultiSchema.with_in_schemas <span class="symbol">:except</span> =&gt; <span class="symbol">:public</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Play around the data in one schema</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Or you can use it in a DSL-like way:</p>
<figure class="highlight ruby"><figcaption><span>DSL usage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeMigration</span> &lt; ActiveRecord::Migration</span></span><br><span class="line"><span class="keyword">include</span> MultiSchema</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    with_in_schemas <span class="symbol">:except</span> =&gt; <span class="symbol">:public</span> <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># Play around the data in one schema</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>with_in_schemas</code> method accept both <code>symbol</code> and <code>string</code>, and you can pass single value, array or hash to it.</p>
<ul>
<li><code>with_in_schemas</code> yield all user schemas in the database</li>
<li><code>with_in_schemas :only =&gt; %w(schema1 schema2)</code> populates all given schemas.</li>
<li><code>with_in_schemas :except =&gt; %w(schema1 schema2)</code> populates all except given schemas.</li>
<li><code>with_in_schemas :except =&gt; [:public]</code> is equivalent to <code>with_in_schemas :except =&gt; [&#39;public&#39;]</code></li>
<li><code>with_in_schemas :only =&gt; [:public]</code> is equivalent to <code>with_in_schemas :only =&gt; :public</code> and equivalent to <code>with_in_schemas :public</code></li>
<li><code>with_in_schemas :except =&gt; [:public]</code> is equivalent to <code>with_in_schemas :except =&gt; :public</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/" data-id="cimz2njhf0030vksisz8djuro" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/07/17/use-postgres-multiple-schema-database-in-rails/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/active-record/">active record</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multischema/">multischema</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgres/">postgres</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/schema/">schema</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/categories/programming/blog/4/">&laquo; __('prev')</a><a class="page-number" href="/categories/programming/">1</a><span class="space">&hellip;</span><a class="page-number" href="/categories/programming/blog/3/">3</a><a class="page-number" href="/categories/programming/blog/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/categories/programming/blog/6/">6</a><a class="page-number" href="/categories/programming/blog/7/">7</a><a class="page-number" href="/categories/programming/blog/8/">8</a><a class="extend next" rel="next" href="/categories/programming/blog/6/">__('next') &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap"><h3 class="widget-title">About Me</h3><div class="widget self-intro"><img src="/images/avatar.png"/><p>Tim is</p><ul class="description"><li>a<span>geek</span></li><li>an spare-time<span>web developer</span></li><li>a part-time<span>mobile developer</span></li><li>a night-time<span>photographer</span></li><li>an early-time<span>pcb solderer</span></li></ul><ul class="social-links"><li><a href="https://linkedin.com/in/timwen" target="_blank" class="linked-in"></a></li><li><a href="https://twitter.com/timnew" target="_blank" class="twitter"></a></li><li><a href="https://github.com/timnew" target="_blank" class="github"></a></li></ul></div></div>
  
    
  <div class="widget-wrap">
    <a href="/posts">
      <h3 class="widget-title">Recent Posts</h3>
    </a>
    <div class="widget recent-posts">
      <ul>
        
          <li>
            <a href="/blog/2015/08/14/a-clean-way-to-test-rejected-promise/">A clean way to test rejected promise</a>
          </li>
        
          <li>
            <a href="/blog/2014/12/06/typical-eventbus-design-patterns/">Typical EventBus Design Patterns</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/09/understand-styles-in-android-part-1-what-it-is-for-and-how-to-used-it/">Understand Styles in Android - Part 1. What it is for and how to used it</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/07/walkthrough-untrusted-the-continuing-adventures-of-dr-eval/">Walkthrough: Untrusted - the Continuing Adventures of Dr. Eval</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/05/awesome-geek-game-untrusted-the-continuing-adventures-of-dr-eval/">Awesome geek game Untrusted - the Continuing Adventures of Dr. Eval</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/tags">
      <h3 class="widget-title">Tag Cloud</h3>
    </a>
    <div class="widget tagcloud">
      <a href="/tags/net/" style="font-size: 10px;">.net</a> <a href="/tags/alfred/" style="font-size: 10px;">Alfred</a> <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/android-studio/" style="font-size: 10px;">Android Studio</a> <a href="/tags/automation/" style="font-size: 10px;">Automation</a> <a href="/tags/bit-slicer/" style="font-size: 10px;">Bit Slicer</a> <a href="/tags/boilerplate/" style="font-size: 10px;">Boilerplate</a> <a href="/tags/c/" style="font-size: 20px;">C#</a> <a href="/tags/ci/" style="font-size: 15px;">CI</a> <a href="/tags/css/" style="font-size: 10px;">CSS</a> <a href="/tags/cheat/" style="font-size: 10px;">Cheat</a> <a href="/tags/cheat-engine/" style="font-size: 10px;">Cheat Engine</a> <a href="/tags/class/" style="font-size: 10px;">Class</a> <a href="/tags/cocoa/" style="font-size: 10px;">Cocoa</a> <a href="/tags/command/" style="font-size: 10px;">Command</a> <a href="/tags/continues-delivery/" style="font-size: 10px;">Continues Delivery</a> <a href="/tags/continues-integration/" style="font-size: 10px;">Continues Integration</a> <a href="/tags/crack/" style="font-size: 10px;">Crack</a> <a href="/tags/d/" style="font-size: 10px;">D</a> <a href="/tags/debugger/" style="font-size: 10px;">Debugger</a> <a href="/tags/deploy/" style="font-size: 10px;">Deploy</a> <a href="/tags/deployment/" style="font-size: 10px;">Deployment</a> <a href="/tags/design/" style="font-size: 10px;">Design</a> <a href="/tags/design-pattern/" style="font-size: 10px;">Design Pattern</a> <a href="/tags/event/" style="font-size: 10px;">Event</a> <a href="/tags/eventbus/" style="font-size: 10px;">EventBus</a> <a href="/tags/fp/" style="font-size: 10px;">FP</a> <a href="/tags/fswatcher/" style="font-size: 10px;">FSWatcher</a> <a href="/tags/gb2312/" style="font-size: 10px;">GB2312</a> <a href="/tags/gbk/" style="font-size: 10px;">GBK</a>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/tags">
      <h3 class="widget-title">Tags</h3>
    </a>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/net/">.net</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alfred/">Alfred</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">Android</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-studio/">Android Studio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automation/">Automation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bit-slicer/">Bit Slicer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boilerplate/">Boilerplate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">C#</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ci/">CI</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">CSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cheat/">Cheat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cheat-engine/">Cheat Engine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/class/">Class</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cocoa/">Cocoa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/command/">Command</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/continues-delivery/">Continues Delivery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/continues-integration/">Continues Integration</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crack/">Crack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/d/">D</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debugger/">Debugger</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/">Deploy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deployment/">Deployment</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/">Design</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-pattern/">Design Pattern</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event/">Event</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eventbus/">EventBus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fp/">FP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fswatcher/">FSWatcher</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gb2312/">GB2312</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gbk/">GBK</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/categories">
      <h3 class="widget-title">Categories</h3>
    </a>
    <div class="widget category-list">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/">Cracking</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/game/">Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/">Design</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/design/visual/">Visual</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/web/">Web</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/game/">Game</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/game/programming-game/">Programming Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/geek-toy/">Geek Toy</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/">Package</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/package/chrome-extension/">Chrome Extension</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/hexo/">Hexo</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/">Practice</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/practice/atom/">Atom</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/continues-integration/">Continues Integration</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/devops/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/mac/">Mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/textmate/">TextMate</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/windows/">Windows</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/git/">git</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">Programming</a><span class="category-list-count">72</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/algorithm/">Algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/android/">Android</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/arduino/">Arduino</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/c/">C#</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/design-patterns/">Design Patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/">JavaScript</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/coffeescript/">CoffeeScript</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/postgressql/">PostgresSql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/powershell/">PowerShell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/regular-expression/">Regular Expression</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/ruby/">Ruby</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/shell/">Shell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/wpf/">WPF</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/web/">Web</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/node-js/">node.js</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/thinking/">Thinking</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/archives">
      <h3 class="widget-title">Archives</h3>
    </a>
    <div class="widget archive-list">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 TimNew<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/#main" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/photos/500px.html" class="mobile-nav-link">Photos</a>
  
</nav>
    
<script>
  var disqus_shortname = 'timnew-github';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>