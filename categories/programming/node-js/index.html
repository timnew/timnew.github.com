<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: node.js | ThoughtWorkshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="timnew programming code software">
<meta property="og:type" content="website">
<meta property="og:title" content="ThoughtWorkshop">
<meta property="og:url" content="http://timnew.me/categories/programming/node-js/index.html">
<meta property="og:site_name" content="ThoughtWorkshop">
<meta property="og:description" content="timnew programming code software">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ThoughtWorkshop">
<meta name="twitter:description" content="timnew programming code software">
<meta name="twitter:creator" content="@timnew">
<link rel="publisher" href="108780866821209050000">
  
    <link rel="alternate" href="/atom.xml" title="ThoughtWorkshop" type="application/atom+xml">
  
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
<link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">

  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30567867-1', 'auto');

  ga('require', 'displayfeatures');

ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ThoughtWorkshop</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Digital Bigs in my thought</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/#main">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/photos/500px.html">Photos</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://timnew.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-trick-to-use-coffeescript-in-hexo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2014/08/18/trick-to-use-coffeescript-in-hexo/" class="article-date">
  <time datetime="2014-08-18T10:19:44.000Z" itemprop="datePublished">2014-08-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2014/08/18/trick-to-use-coffeescript-in-hexo/">Trick to use CoffeeScript in Hexo</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://hexo.io/" target="_blank" rel="external">Hexo</a> has a <code>scripts</code> folder, and the files under which are loaded by <code>Hexo</code> when start. I usually uses this folder as the development folder for my plug-in scripts. And extract them into independent package after polished it into package-ready quality.</p>
<p>Usually, the files under scripts should be <code>javascripts</code>. But as I’m a fan of <a href="http://coffeescript.org/" target="_blank" rel="external">Coffee Script</a>, so I wish to use <code>coffee-script</code> to write the plug-ins. For the formal package, I compile the <code>coffee scripts</code> into <code>javascripts</code> before release. But for development, I wish to use <code>coffee script</code> directly.</p>
<p>In <code>node.js</code>, it is possible to require <code>coffee-script</code> directly, if you registered the <code>coffee-script</code> runtime compiler:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(<span class="string">'coffee-script/register'</span>);</div></pre></td></tr></table></figure>
<p>And as how node.js <code>require</code> function is implemented, you cannot register <code>coffee-script</code> runtime compiler in <code>.coffee</code> file. Or the compiler will complain:</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[error] <span class="symbol">HexoError:</span> Script load <span class="symbol">failed:</span> plugin.coffee</div><div class="line"><span class="symbol">SyntaxError:</span> Unexpected string</div><div class="line">  at Module._compile (<span class="class"><span class="keyword">module</span>.<span class="title">js</span>:439:25)</span></div><div class="line">  at Object.Module._extensions..js (<span class="class"><span class="keyword">module</span>.<span class="title">js</span>:474:10)</span></div><div class="line">  at Module.load (<span class="class"><span class="keyword">module</span>.<span class="title">js</span>:356:32)</span></div><div class="line">  at Function.Module._load (<span class="class"><span class="keyword">module</span>.<span class="title">js</span>:312:12)</span></div><div class="line">  at Module.<span class="keyword">require</span> (<span class="class"><span class="keyword">module</span>.<span class="title">js</span>:364:17)</span></div><div class="line">  at <span class="keyword">require</span> (<span class="class"><span class="keyword">module</span>.<span class="title">js</span>:380:17)</span></div><div class="line">  at /usr/local/<span class="class"><span class="keyword">lib</span>/<span class="title">node_modules</span>/<span class="title">hexo</span>/<span class="title">lib</span>/<span class="title">loaders</span>/<span class="title">scripts</span>.<span class="title">js</span>:17:11</span></div><div class="line">  at Array.forEach (native)</div><div class="line">  at /usr/local/<span class="class"><span class="keyword">lib</span>/<span class="title">node_modules</span>/<span class="title">hexo</span>/<span class="title">lib</span>/<span class="title">loaders</span>/<span class="title">scripts</span>.<span class="title">js</span>:15:13</span></div><div class="line">  at /usr/local/<span class="class"><span class="keyword">lib</span>/<span class="title">node_modules</span>/<span class="title">hexo</span>/<span class="title">lib</span>/<span class="title">util</span>/<span class="title">file2</span>.<span class="title">js</span>:339:7</span></div><div class="line">  at done (<span class="regexp">/usr/local</span><span class="regexp">/lib/node</span>_modules/hexo/node_modules/async/<span class="class"><span class="keyword">lib</span>/<span class="title">async</span>.<span class="title">js</span>:135:19)</span></div><div class="line">  at /usr/local/<span class="class"><span class="keyword">lib</span>/<span class="title">node_modules</span>/<span class="title">hexo</span>/<span class="title">node_modules</span>/<span class="title">async</span>/<span class="title">lib</span>/<span class="title">async</span>.<span class="title">js</span>:32:16</span></div><div class="line">  at /usr/local/<span class="class"><span class="keyword">lib</span>/<span class="title">node_modules</span>/<span class="title">hexo</span>/<span class="title">lib</span>/<span class="title">util</span>/<span class="title">file2</span>.<span class="title">js</span>:335:11</span></div><div class="line">  at Object.oncomplete (evalmachine.&lt;anonymous&gt;:<span class="number">107</span>:<span class="number">15</span>)</div></pre></td></tr></table></figure>
<p>Theoretically, it is possible to put the <code>coffee-script</code> registration code in a <code>javascript</code> file and also put it under <code>/scripts</code> folder. SO <code>Hexo</code> will load it when start-up.</p>
<p>Well, this approach doesn’t really work. If you try it, it is very likely to get the exactly same error as before. The reason is related to <code>Hexo</code> implementation. <code>Hexo</code> uses <a href="https://github.com/hexojs/hexo/blob/master/lib/loaders/scripts.js" target="_blank" rel="external">Scripts Loader</a> to require files under <code>/scripts</code>. The loader doesn’t really provide an explicit way to specify which file is loaded before another. So the registration file is guaranteed to be loaded before any <code>.coffee</code>.</p>
<p>So far, it seems that there is no cure to this problem! But actually it does. There is undocumented feature will help to solve this issue.</p>
<p>Hexo uses [Script Loader] to load the scripts. In <a href="https://github.com/hexojs/hexo/blob/master/lib/loaders/scripts.js" target="_blank" rel="external">Scripts Loader</a> use <a href="https://github.com/hexojs/hexo/blob/master/lib/util/file2.js#L313" target="_blank" rel="external">hexo.util.file2</a> to populate the source files under <code>/scripts</code>. And <a href="https://github.com/hexojs/hexo/blob/master/lib/util/file2.js#L313" target="_blank" rel="external">hexo.util.file2</a> use <a href="http://nodejs.org/api/fs.html#fs_fs_readdir_path_callback" target="_blank" rel="external">fs.readdir</a> to actully populate the file system entries. For <a href="http://nodejs.org/api/fs.html#fs_fs_readdir_path_callback" target="_blank" rel="external">fs.readdir</a>, there is a undocumented feature, that the populated entries are actually sorted alphabetically, which means <code>a.js</code> is loaded before <code>b.coffee</code>.</p>
<p>With this feature, we can put our <code>coffee-script</code> registration in a file with lower alphabetic-order name. Personally, I’d like called <code>___register_coffeescript.js</code>, since <code>_</code> is smaller than any letter or number.</p>
<p>⚠️<strong>WARNING</strong>: <a href="http://nodejs.org/api/fs.html#fs_fs_readdir_path_callback" target="_blank" rel="external">fs.readdir</a> yielding sorted files is an undocumented behavior, which means it is not guaranteed either to work across platforms or not get changed in the future. So for, it works on Mac, and I expect it behaves similar on Linux. But not sure about Windows, since <code>fs</code> uses a different native binding on Windows.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2014/08/18/trick-to-use-coffeescript-in-hexo/" data-id="ciqg4g85000836nsi66813r60" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2014/08/18/trick-to-use-coffeescript-in-hexo/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/coffee/">coffee</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hack/">hack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/">hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/plug-in/">plug-in</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/script/">script</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trick/">trick</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-remove-bower-from-your-build-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2014/07/10/remove-bower-from-your-build-script/" class="article-date">
  <time datetime="2014-07-10T00:00:00.000Z" itemprop="datePublished">2014-07-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2014/07/10/remove-bower-from-your-build-script/">Remove Bower from your build script</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="The-mysterious-broken-build"><a href="#The-mysterious-broken-build" class="headerlink" title="The mysterious broken build"></a>The mysterious broken build</h3><p>This morning, our QA told us that <code>knockout</code>, a javascript library that we used in our web app is missing on staging environment. Then we checked the package she got from CI server, and the javascript library was indeed not included. But when we tried to generate the package on our local dev box, we found that <code>knockout</code> is included.</p>
<p>It is a big surprise to us, because we share the exact same build scripts and environment between dev-boxes and CI agents and because we manage the front-end dependencies with <code>bower</code>. In our <code>gulp</code> script, we ask <code>bower</code> to install the dependencies every time to make sure they are up to date.</p>
<h3 id="The-root-cause-of-the-broken-build"><a href="#The-root-cause-of-the-broken-build" class="headerlink" title="The root cause of the broken build"></a>The root cause of the broken build</h3><p>After spending hours on diagnosing the CI agents, we finally figure out the reason, a tricky story:</p>
<p>When the Knockout maintainer released the v3.1 bower package, they made a mistake in <code>bower.json</code> config file, which packaged the <code>spec</code> folder instead of the <code>dist</code> folder. So this package is actually broken, because the main javascript file <code>dist/knockout.js</code> , described in <code>bower.json</code> doesn’t exist.</p>
<p>Later, the engineers realized they made a mistake, and they fixed the issue by releasing a new package. Maybe they think they haven’t changed any script logic, so <strong>they release the new package under the same version number</strong>, which is the criminal who broke our builds.</p>
<p>We’re so unlucky that the broken package is downloaded on our CI server when our build script was executed there for the first time. And the broken package is stored in <code>bower</code> cache at that time.</p>
<p>Because of Bower’s cache mechanism, the broken package is used unless the version is bumped or cache is expired. This is the reason why our build is broken on the CI server.</p>
<p>But on our dev box, for some reason, we had run <code>bower cache clean</code>, which invalidated the cache. So we have a good build on our local dev box. This is the reason why we can generate good package on our dev box.</p>
<p>It is a very tricky issue when using bower to manage dependencies. Although it is not completely our fault, but it is kind of the worst case then we can face. The build broke silently, there were no error logs or messages that helped to figure out the reason. (Well, we haven’t got a chance to setup the smoke test for our app yet, so it could be kind of our fault.)</p>
<p>We thought we had been careful enough to clean the <code>bower_components</code> folder every time, but that prevented us from figuring out the real cause.</p>
<p>After fixing this issue, discussed with my pair Rafa and we came up some practices that could be helpful to avoid this kind of issue:</p>
<h3 id="Best-practices"><a href="#Best-practices" class="headerlink" title="Best practices"></a>Best practices</h3><ul>
<li>Avoid <code>bower install</code> or any equivalent step (such as <code>gulp-bower</code>, <code>grunt-bower</code>, etc.) in the build script</li>
<li>Check <code>bower_components</code> into the code repository or download the dependencies from our self managed repository for large projects.</li>
<li>When dependencies are changed, manually install them and make sure they’re good.</li>
</ul>
<p>After doing this, our build script runs even faster, because we don’t need to check all dependencies are up-to-date every time. This is a bonus from removing <code>bower install</code> from our build script.</p>
<h3 id="Some-thoughts-on-the-package-system"><a href="#Some-thoughts-on-the-package-system" class="headerlink" title="Some thoughts on the package system"></a>Some thoughts on the package system</h3><p>Bower components are maintained by the community, and there is no strict quality control to ensure the package is bug-free or being released in an appropriate way. So it could be safer if we can check them manually, and lock them down across environments.</p>
<p>This could be common issue for all kind of community managed package system. Not just Bower, it could be Maven, Ruby Gem, Node.js package, Python pip package, nuget package or even Docker containers!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2014/07/10/remove-bower-from-your-build-script/" data-id="ciqg4g84j00716nsi8iq8ik58" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2014/07/10/remove-bower-from-your-build-script/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/automation/">automation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bower/">bower</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/build/">build</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/continues-integration/">continues integration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/deployment/">deployment</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/environment/">environment</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pipeline/">pipeline</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-jade-as-client-side-template-engine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2014/05/26/use-jade-as-client-side-template-engine/" class="article-date">
  <time datetime="2014-05-26T00:00:00.000Z" itemprop="datePublished">2014-05-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2014/05/26/use-jade-as-client-side-template-engine/">Use Jade as client-side template engine</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://jade-lang.com/" target="_blank" rel="external">Jade</a> is a powerful JavaScript HTML template engine, which is concise and powerful. Due to its awesome syntax and powerful features, it almost become the default template engine for node.js web servers.</p>
<p>Jade is well known as a server-side HTML template, but actually it can also be used as a client-side template engine, which is barely known by people! To have a better understanding of this issue, firstly we should how Jade engine works.</p>
<p>When we’re translating a jade file into HTML, Jade engine actually does 2 separate tasks: <strong>Compiling</strong> and <strong>Rendering</strong>.</p>
<h3 id="Compiling"><a href="#Compiling" class="headerlink" title="Compiling"></a>Compiling</h3><p>Compiling is almost a transparent process when rendering jade files directly into HTML, including, rendering a jade file with <code>jade</code> cli tool. But it is actually the most important step while translating the jade template to HTML.<br>Compiling will be translate the jade file into a JavaScript function. During the process, all the static content has been translated.</p>
<p>Here is simple example:</p>
<figure class="highlight plain"><figcaption><span>Jade template</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html(lang=&quot;en&quot;)</div><div class="line">  head</div><div class="line">    title Title  </div><div class="line">  body</div><div class="line">    h1 Jade - node template engine</div><div class="line">    #container.col</div><div class="line">      p You are amazing</div><div class="line">      p.</div><div class="line">        Jade is a terse and simple</div><div class="line">        templating language with a</div><div class="line">        strong focus on performance</div><div class="line">        and powerful features.</div></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>Compiled template</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">template</span>(<span class="params">locals</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> buf = [];</div><div class="line">    <span class="keyword">var</span> jade_mixins = &#123;&#125;;</div><div class="line">    buf.push(<span class="string">'&lt;!DOCTYPE html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;title&gt;Title  &lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Jade - node template engine&lt;/h1&gt;&lt;div id="container"class="col"&gt;     &lt;p&gt;You are amazing&lt;/p&gt;&lt;p&gt;Jade is a terse and simple\ntemplating language with a\nstrong focus on performance\nand powerful features.&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;'</span>);</div><div class="line">    <span class="keyword">return</span> buf.join(<span class="string">""</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As you can see, the template is translated into a JavaScript function, which contains all the HTML data. In this case, since we didn’t introduce any interpolation, so the HTML content has been fully generated.</p>
<p>The case will become more complicated when interpolation, <code>each</code>, <code>if</code> statement is introduced.</p>
<figure class="highlight plain"><figcaption><span>Jade template with interpolation</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html(lang=&quot;en&quot;)</div><div class="line">  head</div><div class="line">    title =title  </div><div class="line">  body</div><div class="line">    h1 Jade - node template engine</div><div class="line">    #container.col</div><div class="line">    ul</div><div class="line">      each item in items</div><div class="line">        li= item</div><div class="line"></div><div class="line">    if usingJade</div><div class="line">      p You are amazing</div><div class="line">    else</div><div class="line">      p Get it!</div><div class="line"></div><div class="line">    p.</div><div class="line">      Jade is a terse and simple</div><div class="line">      templating language with a</div><div class="line">      strong focus on performance</div><div class="line">      and powerful features.</div></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>Compiled template with interpolation</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">template</span>(<span class="params">locals</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> buf = [];</div><div class="line">    <span class="keyword">var</span> jade_mixins = &#123;&#125;;</div><div class="line">    <span class="keyword">var</span> locals_ = locals || &#123;&#125;, items = locals_.items, usingJade = locals_.usingJade;</div><div class="line">    buf.push(<span class="string">'&lt;!DOCTYPE html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;title&gt;=title  &lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Jade - node template engine&lt;/h1&gt;&lt;div id="container"class="col"&gt;&lt;/div&gt;&lt;ul&gt;'</span>);</div><div class="line">    (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> $$obj = items;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"number"</span> == <span class="keyword">typeof</span> $$obj.length) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> $index = <span class="number">0</span>, $$l = $$obj.length; $index &lt; $$l; $index++) &#123;</div><div class="line">                <span class="keyword">var</span> item = $$obj[$index];</div><div class="line">                buf.push(<span class="string">"&lt;li&gt;"</span> + jade.escape(<span class="literal">null</span> == (jade.interp = item) ? <span class="string">""</span> : jade.interp) + <span class="string">"&lt;/li&gt;"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">var</span> $$l = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> $index <span class="keyword">in</span> $$obj) &#123;</div><div class="line">                $$l++;</div><div class="line">                <span class="keyword">var</span> item = $$obj[$index];</div><div class="line">                buf.push(<span class="string">"&lt;li&gt;"</span> + jade.escape(<span class="literal">null</span> == (jade.interp = item) ? <span class="string">""</span> : jade.interp) + <span class="string">"&lt;/li&gt;"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;).call(<span class="keyword">this</span>);</div><div class="line">    buf.push(<span class="string">"&lt;/ul&gt;"</span>);</div><div class="line">    <span class="keyword">if</span> (usingJade) &#123;</div><div class="line">        buf.push(<span class="string">"&lt;p&gt;You are amazing&lt;/p&gt;"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        buf.push(<span class="string">"&lt;p&gt;Get it!&lt;/p&gt;"</span>);</div><div class="line">    &#125;</div><div class="line">    buf.push(<span class="string">"&lt;p&gt;Jade is a terse and simple\ntemplating language with a\nstrong focus on performance\nand powerful features.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"</span>);</div><div class="line">    <span class="keyword">return</span> buf.join(<span class="string">""</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight json"><figcaption><span>Data for interpolation</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"title"</span>: <span class="string">"Jade Demo"</span>,</div><div class="line">  <span class="attr">"usingJade"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">"items"</span>:[</div><div class="line">    <span class="string">"item1"</span>,</div><div class="line">    <span class="string">"item2"</span>,</div><div class="line">    <span class="string">"item3"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>Output Html</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>=title  <span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Jade - node template engine<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span> <span class="attr">class</span>=<span class="string">"col"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>item1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>item2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>item3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>You are amazing<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">      Jade is a terse and simple</div><div class="line">      templating language with a</div><div class="line">      strong focus on performance</div><div class="line">      and powerful features.</div><div class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Well, as you can see, the function has become quite complicated than before. It could become more complicated when <code>extend</code>, <code>include</code> or <code>mixin</code> introduced, you can trial it on your own.</p>
<h3 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h3><p>After the compiling, the rendering process is quite simple. Just invoking the compiled function, the return string is rendered html. The only thing need to mentioned here is the interpolation data should be passed to the template function as <code>locals</code>.</p>
<h3 id="Using-Jade-as-front-end-template-engine"><a href="#Using-Jade-as-front-end-template-engine" class="headerlink" title="Using Jade as front-end template engine"></a>Using Jade as front-end template engine</h3><p>Still now, you probably have got my idea. To use jade a front-end template, we can compose the template in jade. Later compile it into JavaScript file. And then we can invoke the JavaScript function in front-end to achieve dynamic client-side rendering!</p>
<p>Since Jade template has been precompiled at server side, so there is very little runtime effort when rendering the template at client-side. So it is a cheaper solution when you have lots of templates.</p>
<p>To compile the jade files into JavaScript instead of HTML, you need to pass <code>-c</code> or <code>--client</code> option to <code>jade</code> cli tool. Or calling <code>jade.compile</code> instead of <code>jade.render</code> while using JavaScript API.</p>
<h3 id="Configure-Grunt"><a href="#Configure-Grunt" class="headerlink" title="Configure Grunt"></a>Configure Grunt</h3><p>Well, since <a href="http://gruntjs.com/" target="_blank" rel="external">Grunt</a> is popular in node.js world. So we can also use Grunt to do the stuff for us.<br>Basically, use grunt for jade is straightforward. But it is a little bit tricky when you want to compile the back-end template into HTML as well as to compile the front-end template into JavaScripts.</p>
<p>I used a little trick to solve the issue. I follow the convention in Rails, that prefix the front-end template files with underscore.<br>So</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/layouts/default.jade       -&gt; Layout file, extended <span class="built_in">by</span> back-<span class="keyword">end</span>/front-<span class="keyword">end</span> templates, should not be compiled.</div><div class="line">/views/settings/index.jade  -&gt; <span class="keyword">Back</span>-<span class="keyword">end</span> template, should be compiled into HTML</div><div class="line">/views/settings/_item.jade  -&gt; Front-<span class="keyword">end</span> template, should be compiled into JavaScript</div><div class="line"></div></pre></td></tr></table></figure>
<figure class="highlight coffeescript"><figcaption><span>Gruntfile.coffee</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">(grunt)</span> -&gt;</span></div><div class="line">  grunt.initConfig</div><div class="line">    pkg: grunt.file.readJSON(<span class="string">'package.json'</span>)</div><div class="line"></div><div class="line">    jade:</div><div class="line">      options:</div><div class="line">        pretty: <span class="literal">true</span></div><div class="line"></div><div class="line">      compile:</div><div class="line">        expand: <span class="literal">true</span></div><div class="line">        cwd: <span class="string">'views'</span></div><div class="line">        src: [<span class="string">'**/*.jade'</span>, <span class="string">'!**/_*.jade'</span>]</div><div class="line">        dest: <span class="string">'build/'</span></div><div class="line">        ext: <span class="string">'.html'</span></div><div class="line"></div><div class="line">      template:</div><div class="line">        options:</div><div class="line">          client: <span class="literal">true</span></div><div class="line">          namespace: <span class="string">'Templates'</span></div><div class="line"></div><div class="line">        expand: <span class="literal">true</span></div><div class="line">        cwd: <span class="string">'views'</span></div><div class="line">        src: [<span class="string">'**/_*.jade'</span>]</div><div class="line">        dest: <span class="string">'build/'</span></div><div class="line">        ext: <span class="string">'.js'</span></div><div class="line"></div><div class="line">  grunt.loadNpmTasks(<span class="string">'grunt-contrib-jade'</span>)  </div><div class="line"></div></pre></td></tr></table></figure>
<p>I distinguish the layouts and templates by file path. And distinguish the front-end/back-end templates by prefix. The filter <code>!**/_*.jade</code> excludes the front-end templates when compiling the back-end templates.</p>
<p>This approach should work fine in most cases, but if you are facing more complicated situation, and can’t be handled with this trick, try defining your own convention, and recognizing it with custom filter function to categorize them.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2014/05/26/use-jade-as-client-side-template-engine/" data-id="ciqg4g84f006r6nsirj5hb1b3" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2014/05/26/use-jade-as-client-side-template-engine/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/build/">build</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/client-side/">client side</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">front-end</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/grunt/">grunt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/html/">html</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jade/">jade</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pre-compile/">pre-compile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/template-engine/">template engine</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-node-over-express-autoload" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/04/27/node-over-express-autoload/" class="article-date">
  <time datetime="2013-04-27T00:00:00.000Z" itemprop="datePublished">2013-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/04/27/node-over-express-autoload/">Node over Express - Autoload</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>This is the 2nd post of the <a href="/blog/tags/#node over express-ref">Node over Express</a> series (the previous one is <a href="/blog/2013/04/25/node-over-express-configuration/">Configuration</a>). In this post, I’d like to discuss a famous pain point in Node.js.</p>
<h2 id="Pain-Point"><a href="#Pain-Point" class="headerlink" title="Pain Point"></a>Pain Point</h2><p>There is well known Lisp joke:</p>
<blockquote><p>A top hacker successfully stole the last 100 lines of a top secret program from the Pentagon. Because the program is written in Lisp, so the stolen code is just close brackets.</p>
</blockquote>
<p>It is a joke that there are too many brackets in Lisp. In Node.js there is a similar issue that there are too many <code>require</code>. Open any node.js file, usually one could find several lines of <code>require</code>.</p>
<p>Due to the node’s sandbox model, the developer has to require resources time and time again in every files. It is not so exciting to write or read lines of meaningless <code>require</code>. And the worst, it could be a nightmare once a developer wishes to replace some library with another.</p>
<h2 id="Rails-Approaches"><a href="#Rails-Approaches" class="headerlink" title="Rails Approaches"></a>Rails Approaches</h2><p>“Require hell” isn’t only for node.js, but also for Ruby apps. Rails has solved it gracefully, and the developer barely needs to require anything manually in Rails.</p>
<p>There are 2 kinds of dependencies in rails app, one is the external resource, another is the internal resource.</p>
<h3 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h3><p>External resources are classes encapsulated in ruby gems. In ruby application, developer describe the dependencies in <code>Gemfile</code>, and load them with <code>Bundler</code>. Some frameworks have already integrated with <code>Bundler</code>, such as Rails. When using them, developer doesn’t need to do anything manually, all the dependencies are required automatically. For others, use <code>bundle execute</code> to create the ruby runtime with all gems required.</p>
<h3 id="Internal-Resources"><a href="#Internal-Resources" class="headerlink" title="Internal Resources"></a>Internal Resources</h3><p>Internal Resources are the classes declared in the app, they could be models, the services or the controllers. Rails uses <code>Railtie</code> to require them automatically. The resource is loaded the first time it is used, the requiring process is “Lazy”. (In fact, this description isn’t that precise because Rails behaves differently in production environment. It loads all the classes during the launching for performance reason).</p>
<h2 id="Autoload-in-Node-js"><a href="#Autoload-in-Node-js" class="headerlink" title="Autoload in Node.js"></a>Autoload in Node.js</h2><p>Rails avoids the “require-hell” with two “autoload” mechanisms. Although there are still debates about whether autoload is good or not. But at least, autoload frees the developer from the dull dependency management and increases the productivity of developers. Developers love autoload in most cases.</p>
<p>So to avoid “require-hell” in Node.js, I prefers autoload mechanism. But because there are significant differences in type system between Node.js and Ruby, we cannot copy the mechanism from ruby to node as is. Therefore before diving into the solution, we need to understand the differences first.</p>
<h3 id="Node-js-Module-System"><a href="#Node-js-Module-System" class="headerlink" title="Node.js Module System"></a>Node.js Module System</h3><p>There are a number of similarities between Node.js and ruby; things in node.js usually have the equivalences in ruby. For example, <code>package</code> in node is similar to the <code>gem</code> in Ruby, <code>npm</code> equals to <code>Gem</code> and <code>Bundler</code>, <code>package.json</code> takes the responsibility of <code>Gemfile</code> and <code>Gemfile.lock</code>. The similarity enables porting autoload from ruby to node.</p>
<p>In some aspect, there are similarities between Node.js and Ruby, but there are also significant differences between them in some other aspects. One of the major differences is the type system and module sandbox in Node.js, which works in a quite different way to Ruby type system.</p>
<p>JavaScript isn’t a real OO language, so it doesn’t have real type system. All the types in JavaScript are actually functions, which are stored in local variables instead of in type system. Node.js loads files into different sandboxes, all the local variables are isolated between files to avoid “global leak”, a well-known deep-seated bad part of JavaScript. As a result, a Node.js developer needs to require used types again and again in every file.</p>
<p>In ruby, it is a lot better. With the help of the well designed type system, types are shared all over the runtime, a developer just needs to require the types not yet loaded.</p>
<p>So in node.js programs, there are many more <code>require</code> statements than in ruby. And due to the design of node.js and javascript, the issue is harder to be resolved.</p>
<h3 id="Global-Variable"><a href="#Global-Variable" class="headerlink" title="Global Variable"></a>Global Variable</h3><p>In the browser, the JavaScript runtime other than node, global variables are very common. Global variable could be abused easily, which brings global leak to bad written JavaScript programs, and drives thousands of developers up to the wall. The JavaScript developers are scared of global leak so much so that they designed such a strict isolation model in node.js. But to my understanding, the isolation avoided global leaks effectively. But at the same time, it brought tens of require statements to every files, which is also not acceptable.</p>
<p>In fact, with the help of JSLint, CoffeScript and some other tools, developers can avoid global leak easily. And global sharing isn’t the source of evil. If abuse is avoided, I believes a reasonable level of global sharing could be useful and helpful. Actually Node.js have built-in a global sharing mechanism.</p>
<p>To share values across file, a special variable <code>global</code> is needed, which could be accessed in every file, and the value of which is also shared across files.</p>
<p>Besides sharing value around, <code>global</code> has another important feature: node treats <code>global</code> as default context, whose child you can refer to without explicitly identifying. So <code>SomeType === global.SomeType</code>.</p>
<p>With the help of <code>global</code>, we find a way to share types across files naturally.</p>
<h3 id="JS-Property"><a href="#JS-Property" class="headerlink" title="JS Property"></a>JS Property</h3><p>Rails’ autoload mechanism loads the classes lazily. It only loads the class when it is used for first time. It is a neat feature, and Rails achieve it by tracking the exception of “Uninitialized Constant”. To implement similar feature in Node.js, tracking exception is hardly feasible, so I choose a different approach, I use Property.</p>
<p>Property (Attribute in Ruby) enables method (function) being invoked as the field of an object is accessed. Property is a common feature among OO languages, but is a “new” feature to JavaScript. Property is a feature declared in <a href="http://www.ecma-international.org/publications/standards/Ecma-262.htm" target="_blank" rel="external">ECMAScript 5 standard</a>, which enables the developers to declare property on object by using the API <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external">Object.defineProperty</a>. With the property, we’re able to hook the callback on the type variables, and require the types when the type is accessed. So the module won’t be required until it is used. On the other hand, node.js <code>require</code> function has built in the cache mechanism; it won’t load the file twice, instead it return the value from its cache.</p>
<p>With property, we make the autoload lazy!</p>
<h3 id="My-Implementation"><a href="#My-Implementation" class="headerlink" title="My Implementation"></a>My Implementation</h3><p>To make autoload work, we need to create a magic host object to hold the type variables. In my implementation, I call the magic object Autoloader<br>we need to require a bootstrap script when the app starts, which is used to describe which types and how they should be required.</p>
<figure class="highlight coffeescript"><figcaption><span>Bootstrap Script: initEnvironment.coffee</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">global</span>.createAutoLoader = <span class="built_in">require</span>(<span class="string">'./services/AutoLoader'</span>)</div><div class="line"><span class="built_in">global</span>.createPathHelper = <span class="built_in">require</span>(<span class="string">'./services/PathHelper'</span>)</div><div class="line"></div><div class="line"><span class="built_in">global</span>.rootPath = createPathHelper(__dirname, <span class="literal">true</span>)</div><div class="line"></div><div class="line"><span class="built_in">global</span>.Configuration = <span class="built_in">require</span>(rootPath.config(<span class="string">'configuration'</span>))</div><div class="line"></div><div class="line"><span class="built_in">global</span>.Services = createAutoLoader rootPath.services()</div><div class="line"><span class="built_in">global</span>.Routes = createAutoLoader rootPath.routes()</div><div class="line"><span class="built_in">global</span>.Records = createAutoLoader rootPath.records()</div><div class="line"><span class="built_in">global</span>.Models = createAutoLoader rootPath.models()</div><div class="line"></div><div class="line"><span class="built_in">global</span>.assets = &#123;&#125; <span class="comment"># initialize this context for connect-assets helpers</span></div></pre></td></tr></table></figure>
<p>The script sets-up the autoload hosts for all services, routes, records, models for my app. And we can reference the types as following:</p>
<figure class="highlight coffeescript"><figcaption><span>Sample Usage</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Records.User.findById uid, <span class="function"><span class="params">(err, user)</span> -&gt;</span></div><div class="line">  badge = <span class="keyword">new</span> Models.Badget(badgeInfo)</div><div class="line">  user.addBadge badge</div><div class="line">  user.save()</div></pre></td></tr></table></figure>
<p>In the <code>initEnvironment.coffee</code> script, there are 2 very important classes that are used:</p>
<ul>
<li>AutoLoader: The class that works as the type variable hosts. All the magic happens here.</li>
<li>PathHelper: The class used to handle the path combination issue.</li>
</ul>
<p>The detailed implementation is here:<br><figure class="highlight coffeescript"><figcaption><span>Autoload</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">_ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</div><div class="line">path = <span class="built_in">require</span>(<span class="string">'path'</span>)</div><div class="line">fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line">createPathHelper = <span class="built_in">require</span>(<span class="string">'./PathHelper'</span>)</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">createLoaderMethod</span> = <span class="params">(host, name, fullName)</span> -&gt;</div><div class="line">  host.__names.push name</div><div class="line">  Object.defineProperty host, name,</div><div class="line">                        get: <span class="function">-&gt;</span></div><div class="line">                          <span class="built_in">require</span>(fullName)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoLoader</span></span></div><div class="line">  constructor: <span class="function"><span class="params">(source)</span> -&gt;</span></div><div class="line">    @__names = []</div><div class="line">    <span class="keyword">for</span> name, fullName <span class="keyword">of</span> source</div><div class="line">      extName = path.extname fullName</div><div class="line">      createLoaderMethod(<span class="keyword">this</span>, name, fullName) <span class="keyword">if</span> <span class="built_in">require</span>.extensions[extName]? <span class="keyword">or</span> extName == <span class="string">''</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="title">expandPath</span> = <span class="params">(rootPath)</span> -&gt;</div><div class="line">  createPathHelper(rootPath).toPathObject()</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">buildSource</span> = <span class="params">(items)</span> -&gt;</div><div class="line">  result = &#123;&#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> item <span class="keyword">in</span> items</div><div class="line">    extName = path.extname(item)</div><div class="line">    name = path.basename(item, extName)</div><div class="line">    result[name] = item</div><div class="line"></div><div class="line">  result</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">createAutoLoader</span> = <span class="params">(option)</span> -&gt;</div><div class="line">  pathObj = <span class="keyword">switch</span> <span class="keyword">typeof</span>(option)</div><div class="line">    <span class="keyword">when</span> <span class="string">'string'</span></div><div class="line">      expandPath(option)</div><div class="line">    <span class="keyword">when</span> <span class="string">'object'</span></div><div class="line">      <span class="keyword">if</span> option <span class="keyword">instanceof</span> Array</div><div class="line">        buildSource(option)</div><div class="line">      <span class="keyword">else</span></div><div class="line">        option</div><div class="line"></div><div class="line">  <span class="keyword">new</span> AutoLoader(pathObj)</div><div class="line"></div><div class="line">createAutoLoader.AutoLoader = AutoLoader</div><div class="line"></div><div class="line">exports = <span class="built_in">module</span>.exports = createAutoLoader</div></pre></td></tr></table></figure></p>
<figure class="highlight coffeescript"><figcaption><span>PathHelper</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">_ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</div><div class="line">fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line">path = <span class="built_in">require</span>(<span class="string">'path'</span>)</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">createPathHelper</span> = <span class="params">(rootPath, isConsolidated)</span> -&gt;</div><div class="line">  rootPath = path.normalize rootPath</div><div class="line"><span class="function">  <span class="title">result</span> = <span class="params">(args...)</span> -&gt;</span></div><div class="line">    <span class="keyword">return</span> rootPath <span class="keyword">if</span> args.length == <span class="number">0</span></div><div class="line">    parts = _.flatten [rootPath, args]</div><div class="line">    path.join.apply(<span class="keyword">this</span>, parts)</div><div class="line"></div><div class="line">  result.toPathObject = <span class="function">-&gt;</span></div><div class="line">    self = result()</div><div class="line">    files = fs.readdirSync(self)</div><div class="line">    pathObj = &#123;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files</div><div class="line">      fullName = path.join(self, file)</div><div class="line">      extName =  path.extname(file)</div><div class="line">      name = path.basename(file, extName)</div><div class="line">      pathObj[name] = fullName</div><div class="line"></div><div class="line">    pathObj</div><div class="line"></div><div class="line">  result.consolidate = <span class="function">-&gt;</span></div><div class="line">    pathObj = result.toPathObject()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> name, fullName <span class="keyword">of</span> pathObj</div><div class="line">      stats = fs.statSync(fullName)</div><div class="line">      result[name] = createPathHelper(fullName) <span class="keyword">if</span> stats.isDirectory()</div><div class="line"></div><div class="line">    result</div><div class="line"></div><div class="line">  <span class="keyword">if</span> isConsolidated</div><div class="line">    result.consolidate()</div><div class="line">  <span class="keyword">else</span></div><div class="line">    result</div><div class="line"></div><div class="line">exports = <span class="built_in">module</span>.exports = createPathHelper</div></pre></td></tr></table></figure>
<p>The code above are part of the <a href="https://github.com/timnew/ExpressOverNode" target="_blank" rel="external">Express over Node</a>, to access the complete codebase, please check out the <a href="https://github.com/timnew/ExpressOverNode" target="_blank" rel="external">repo</a> on github.</p>
<hr>

<p>Besides of the content, I want to say thank you to my English teacher Marina Sarg, who helped me on this series of blog a lot. Without her, there won’t be this series of blogs. Marina, thank you very much.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2013/04/27/node-over-express-autoload/" data-id="ciqg4g83s005j6nsioj03f5i4" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2013/04/27/node-over-express-autoload/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/autoload/">autoload</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-over-express/">node over express</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-node-over-express-configuration" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/04/25/node-over-express-configuration/" class="article-date">
  <time datetime="2013-04-25T00:00:00.000Z" itemprop="datePublished">2013-04-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/04/25/node-over-express-configuration/">Node over Express - Configuration</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>I have been working on Node.js related projects for quite a while, and have built apps with node both for the clients or personal projects, such as <a href="https://live-hall.herokuapp.com" target="_blank" rel="external">LiveHall</a>, <a href="https://github.com/timnew/CiMonitor" target="_blank" rel="external">CiMonitor</a>, etc. I have promised some one to share my experience on node. Today I’ll begin to work on this. This will be the first blog of the series.</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In this blog, I would like to talk about the configuration in node, which is common problem we need to solve in apps.</p>
<p>Problems related to configuration aren’t new, and there have been a dozens of mature solutions, but for Node.js apps, there is still something worth to be discussed.</p>
<p>Perhaps configuration could be treated as a kind of special data. Usually developers prefer to use data language to describe their configurations. Here are some examples:</p>
<ul>
<li>.net and Java developer usually uses Xml to describe their configuration</li>
<li>Ruby developer prefers Yaml as the configuration language</li>
<li>JavaScript developer tend to use Json</li>
</ul>
<p>Data languages are convenient, because developers can easily build DSL on it, then they describe the configuration with the DSL. But is the data language the best option available? Is it really suitable to be used in all scnearios?</p>
<p>Before we answer the questions, I would like to say something about the problem we’re facing. There is one common requirement to all kinds of configuration solutions, which is default values and overriding.</p>
<p>For example, as a Web app default, we use port 80; but in development environment, we prefer to use a port number over 1024, 3000 is a popular choice. That means we need to provide 80 as the default value of the port, but we wish to override the value with 3000 in the development environment.</p>
<p>For the languages I mentioned above, except for Yaml, Xml and Json, doesn’t provide native support of inheritance and overriding. It means we need to implement the mechanism by our own. Take Json as example, we might write the configuration in this way:</p>
<figure class="highlight json"><figcaption><span>Sample Json configuration</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"default"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">80</span>,</div><div class="line">    <span class="attr">"serveAssets"</span>: <span class="literal">true</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"development"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">3000</span>,</div><div class="line">    <span class="attr">"database"</span>: <span class="string">"mongodb://localhost/development"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"test"</span>: &#123;</div><div class="line">    <span class="attr">"database"</span>: <span class="string">"mongodb://localhost/test"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"production"</span>: &#123;</div><div class="line">    <span class="attr">"serveAssets"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"database"</span>: <span class="string">"mongodb://ds0123456.mongolab.com:43487/my_sample_app"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The previous Json snippet is a typical example of web app configuration; it has a default section to provide the default values for all environments. Three sections for specific environments. To apply it corecctly to our app, we need to load and parse the Json file to get all data first, then load the values of the default section, then override the value with the values from specific environment.  In addition, we might wish to have the validation that yields error when the provided environment doesn’t exist.</p>
<p>This solution looks simple and seems to work, but when you try to apply this approach to your app in real life, you need to watch out some pitfalls.</p>
<h2 id="Issue-1-Confidential-Values"><a href="#Issue-1-Confidential-Values" class="headerlink" title="Issue 1: Confidential Values"></a>Issue 1: Confidential Values</h2><p>In the real world, values in configuration sometimes could be sensitive and need to be kept confidential. It could contain the credential to access your database, Or it could contain the key to decrypt the cookies. It may also contain private certificate that identifies and authenticates the app to other services. In these scenarios, you need to protect your configuration in order to avoid big trouble!</p>
<p>To solve the issue, you might think about adding new feature that enable you to to encrypt confidential values or to load it from a different safe source.  To achieve it, you might need to add another layer of DSL which add more complexities to your app and make your code harder to debug or to maintain.</p>
<h2 id="Issue-2-Dynamic-Data"><a href="#Issue-2-Dynamic-Data" class="headerlink" title="Issue 2: Dynamic Data"></a>Issue 2: Dynamic Data</h2><p>A solution to first issue,  one could store the environment related but sensitive data in the environment variables. The solution is simple and works perfectly, so I highly recommend it. However, to do this means you need the capability to load the value not only from Json directly but also from the environment variables.</p>
<p>Sometimes, such as deploying your app to Heroku/Nojitsu, might give rise that make the case trickier. After deployed the app to Heroku/Nojitsu, the default values are provided in Json directly, and some of which need to be overrode with the values from environment variables or you need to do it vice versa. These tricky requirements might blow your mind and your code away easily. It causes complicated DSL design and hundreds lines of implementation, but just to load your configuration properly. Obviously it is not a good idea.</p>
<h2 id="Issue-3-Complicated-Inheritance-Relationship"><a href="#Issue-3-Complicated-Inheritance-Relationship" class="headerlink" title="Issue 3: Complicated Inheritance Relationship"></a>Issue 3: Complicated Inheritance Relationship</h2><p>Scared about above cases? No, then how about complicated inheritance relationship between environments?</p>
<p>In some big and complicated web apps, there might be more than 3 basic environments, such as:</p>
<ul>
<li>Development: for developers to develop the app locally</li>
<li>Test: for developers to run unit or function test locally, such as mocha tests</li>
<li>Regression: for developers or QAs to run regression tests, such as cucumber tests</li>
<li>Integration: for QAs or Ops to test the integration with other apps</li>
<li>Staging: for ops and QAs to test the app in production like environment before it really goes live</li>
<li>Production: the environment serves your real users</li>
<li>…</li>
</ul>
<p>When try to write configurations for these environments, one might find there are only a few differences between environments. To make life easier,  to avoid the redundancy, introducing the inheritance between configurations might be a good idea.</p>
<p>As the consequence, the whole configuration becomes environments with complex inheritance relationship. And to support this kind of configuration inheritance,  a more complex DSL and hundreds lines of codes are needed.</p>
<h2 id="Some-Comments"><a href="#Some-Comments" class="headerlink" title="Some Comments"></a>Some Comments</h2><p>My assumption above seems to be a little too complex.  From some people, it might be the “WORST CASE SCENERIO” and hard to come by. But according to my experience, it is very common when building real web app with node. So if to solve it isn’t too hard, it could be better to consider it seriously and solve it gracefully.</p>
<p>Ruby developer might think they’re lucky because Yaml supports inheritance natively. But confidential data and dynamic data still troubles.  </p>
<h2 id="My-Solution"><a href="#My-Solution" class="headerlink" title="My Solution"></a>My Solution</h2><p>After learnt a number of painful lessons, I figured out a simple but working solution: Configuration as Code - describe the configuration with the same language that the business logic is described!</p>
<p>Configuration as code isn’t a new concept, but it is extremely handy when you use it in node applications! Let me explain why and how it works:</p>
<p>To protect the confidential configuration values, one should store them with environment variables, which are only accessible in the specific server.<br>Then one can load these values from the environment variables as dynamically values.</p>
<p>To do it in a data language such as Xml, Json or Yaml could be hard, but it will become as easy as taking a candy from a baby if it is done in the programming language that application applied/used, such as ruby or javascript.</p>
<p>To the configuration inheritance, OO languages have already provided very handy inheritance mechanism. Why do we need to invent one? Why not just use it? To the value overriding, OO programming tells us that it is called polymorphism. The only difference here from the typical scenario is that we override the values instead of the behaviors. But it isn’t an issue, because the value could be the result of the behavior, right?</p>
<p>Now I assume that everyone got a pretty good idea of what I am saying. If that is the case, then the below code should be able to be understood quite clearly,  which is a standard Node.js file written in <code>coffee script</code>:</p>
<figure class="highlight coffeescript"><figcaption><span>Configuration as Code Example</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ? <span class="string">'development'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span></span></div><div class="line">  port: <span class="number">80</span></div><div class="line">  cookieSecret: <span class="string">'!J@IOH$!BFBEI#KLjfelajf792fjdksi23989HKHD&amp;&amp;#^@'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">development</span> <span class="keyword">extends</span> <span class="title">Config</span></span></div><div class="line">  port: <span class="number">3009</span></div><div class="line">  redis:</div><div class="line">    uri: <span class="string">'redis://localhost:6379'</span></div><div class="line">  mongo:</div><div class="line">    uri: <span class="string">'mongodb://localhost'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">test</span> <span class="keyword">extends</span> <span class="title">Config</span>.<span class="title">development</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">heroku</span> <span class="keyword">extends</span> <span class="title">Config</span></span></div><div class="line">  cookieSecret: process.env.COOKIE_SECRET</div><div class="line">  redis:</div><div class="line">    uri: process.env.REDISCLOUD_URL</div><div class="line">  mongo:</div><div class="line">    uri: process.env.MONGOLAB_URI</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> Config[process.env.NODE_ENV]()</div></pre></td></tr></table></figure>
<p>See, with the approach, one can describe the configuration easily and clearly in a few lines of code, but with built-in loading dynamical values capability and configuration inheritance and overriding capability.</p>
<p>In fact, with my suggestions, it might work better than expected! Here are the additional free benefits:</p>
<ol>
<li>Only one configuration is needed when  the app deployed to the cloud. Because all the host specific configurations are usually provided via the environment variables in Paas.</li>
<li>Have some simple and straightforward logic in the configuration, which could be very useful, especially if there is some naming convention in the configuration. But complicated or tricky logic should be strictly avoided, because it is hurts the readability and maintainability.</li>
<li>Easy to write tests for configurations, to ensure the values are properly set. It could be very handy when there are complicated inheritance relationships between configurations, or have some simple logic in your configuration.</li>
<li>Avoid to instantiate and execute the code that isn’t related to the current environment, which could be helpful to avoid overhead to instantiate unused expensive resources or to avoid errors caused because of incompatibility between environments.</li>
<li>Get runtime error when the configuration for the environment doesn’t exist.</li>
</ol>
<hr>

<p>Besides of the content, I want to say thank you to my English teacher Marina Sarg, who helped me on this series of blog a lot. Without her, there won’t be this series of blogs. Marina, thank you very much.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2013/04/25/node-over-express-configuration/" data-id="ciqg4g83m00556nsieui8fr5d" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2013/04/25/node-over-express-configuration/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/configuration/">configuration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-over-express/">node over express</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-manage-configuration-in-rails-way-on-node-js-by-using-inheritance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/" class="article-date">
  <time datetime="2013-02-22T00:00:00.000Z" itemprop="datePublished">2013-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/">Manage configuration in Rails way on node.js by using inheritance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Application is usually required to run in different environments. To manage the differences between the environments, we usually introduce the concept of Environment Specific Configuration.<br>In Rails application, by default, Rails have provided 3 different environments, they are the well known, <code>development</code>, <code>test</code> and <code>production</code>.<br>And we can use the environment variable <code>RAILS_ENV</code> to tell Rails which environment to be loaded, if the <code>RAILS_ENV</code> is not provided, Rails will load the app in <code>development</code> env by default.</p>
<p>This approach is very convenient, so we want to apply it to anywhere. But in node.js, Express doesn’t provide any configuration management. So we need to built the feature by ourselves.</p>
<p>The environment management usually provide the following functionalities:</p>
<ul>
<li>Allow us to provide some configuration values as the default, which will be loaded in all environments, usually we call it <code>common</code>.</li>
<li>Specific configuration will be loaded according to the environment variable, and will override some values in the <code>common</code> if necessary.</li>
</ul>
<p>Rails uses <code>YAML</code> to hold these configurations, which is concise but powerful enough for this purpose. And YAML provided inheritance mechanism by default, so you can reduce the duplication by using inheritance.</p>
<figure class="highlight yaml"><figcaption><span>Inheritance in Rails YAML Configuration</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attr">development:</span> <span class="meta">&amp;defaults</span></div><div class="line"><span class="attr">  adapter:</span> mysql</div><div class="line"><span class="attr">  encoding:</span> utf8</div><div class="line"><span class="attr">  database:</span> sample_app_development</div><div class="line"><span class="attr">  username:</span> root</div><div class="line"></div><div class="line"><span class="attr">test:</span></div><div class="line">  &lt;&lt;: <span class="meta">*defaults</span></div><div class="line"><span class="attr">  database:</span> sample_app_test</div><div class="line"></div><div class="line"><span class="attr">cucumber:</span></div><div class="line">  &lt;&lt;: <span class="meta">*defaults</span></div><div class="line"><span class="attr">  database:</span> sample_app_cucumber</div><div class="line"></div><div class="line"><span class="attr">production:</span></div><div class="line">  &lt;&lt;: <span class="meta">*defaults</span></div><div class="line"><span class="attr">  database:</span> sample_app_production</div><div class="line"><span class="attr">  username:</span> sample_app</div><div class="line"><span class="attr">  password:</span> secret_word</div><div class="line"><span class="attr">  host:</span> ec2<span class="bullet">-10</span><span class="bullet">-18</span><span class="bullet">-1</span><span class="bullet">-115.</span>us-west<span class="bullet">-2.</span>compute.amazonaws.com</div><div class="line"></div></pre></td></tr></table></figure>
<p>In <code>express</code> and <code>node.js</code>, if we follow the same approach, comparing to <code>YAML</code>, we prefer <code>JSON</code>, which is supported natively by <code>Javascript</code>.<br>But to me, <code>JSON</code> isn’t the best option, there are some disadvantages of <code>JSON</code>:</p>
<ul>
<li>JSON Syntax is not concise enough</li>
<li>Matching the brackets and appending commas to the line end are distractions</li>
<li>Lack of flexility</li>
</ul>
<p>As an answer to these issues, I chose <code>coffee-script</code> instead of <code>JSON</code>.<br><code>Coffee</code> is concise. And similar to <code>YAML</code>, <code>coffee</code> uses indention to indicate the nested level. And <code>coffee</code> is executable, which provides a lot of flexibilities to the configuration. So we can implement a Domain Specific Language form</p>
<p>To do it, we need to solve 4 problems:</p>
<ol>
<li>Allow dev to declare default configuration.</li>
<li>Load specific configuration besides of default one.</li>
<li>Specific configuration can overrides the values in the default one.</li>
<li>Code is concise, clean and reading-friendly.</li>
</ol>
<p>Inspired by the YAML solution, I work out my first solution:</p>
<figure class="highlight coffeescript"><figcaption><span>Configuration in coffee script</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">_ = <span class="built_in">require</span>(<span class="string">'underscore'</span>)</div><div class="line"></div><div class="line">config = &#123;&#125;</div><div class="line"></div><div class="line">config[<span class="string">'common'</span>] =</div><div class="line">  adapter: <span class="string">"mysql"</span></div><div class="line">  encoding: <span class="string">"utf8"</span></div><div class="line">  database: <span class="string">"sample_app_development"</span></div><div class="line">  username: <span class="string">"root"</span></div><div class="line"></div><div class="line">config[<span class="string">'development'</span>] = &#123;&#125;</div><div class="line"></div><div class="line">config[<span class="string">'test] =</span></div><div class="line">  database:"sample_app_test"</div><div class="line"></div><div class="line">config['cucumber<span class="string">'] =</span></div><div class="line">  database:"sample_app_cucumber"</div><div class="line"></div><div class="line">config['production<span class="string">'] =</span></div><div class="line">  database:"sample_app_production"</div><div class="line">  username:"sample_app"</div><div class="line">  password:"secret_word"</div><div class="line">  host:"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</div><div class="line"></div><div class="line">_.extend exports, config.common</div><div class="line"></div><div class="line">specificConfig = config[process.env.NODE_ENV ?'development<span class="string">']</span></div><div class="line"></div><div class="line">if specificConfig?</div><div class="line">  _.extend exports, specificConfig</div><div class="line"></div></pre></td></tr></table></figure>
<p><code>YAML</code> is data centric language, so its inheritance is more like “mixin” another piece of data. So I uses <code>underscore</code> to help me to mixin the specific configuration over the default one, which overrides the overlapped values.</p>
<p>But if we jump out of the YAML’s box, let us think about the <code>Javascript</code> itself, Javascript is a prototype language, which means it had already provide an overriding mechanism natively. Each object inherits and overrides the value from its prototype.<br>So I worked out the 2nd solution:</p>
<figure class="highlight coffeescript"><figcaption><span>Prototype based Configuration</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">config = &#123;&#125;</div><div class="line"></div><div class="line">config[<span class="string">'common'</span>] =</div><div class="line">  adapter: <span class="string">"mysql"</span></div><div class="line">  encoding: <span class="string">"utf8"</span></div><div class="line">  database: <span class="string">"sample_app_development"</span></div><div class="line">  username: <span class="string">"root"</span></div><div class="line"></div><div class="line">config[<span class="string">'development'</span>] = &#123;&#125;</div><div class="line">config[<span class="string">'development'</span>].__proto__ = config[<span class="string">'common'</span>]</div><div class="line"></div><div class="line">config[<span class="string">'test] =</span></div><div class="line">  __proto__: config['common<span class="string">']</span></div><div class="line">  database:"sample_app_test"</div><div class="line"></div><div class="line">config['cucumber<span class="string">'] =</span></div><div class="line">  __proto__: config['test<span class="string">']</span></div><div class="line">  database:"sample_app_cucumber"</div><div class="line"></div><div class="line">config['production<span class="string">'] =</span></div><div class="line">  __proto__: config['common<span class="string">']</span></div><div class="line">  database:"sample_app_production"</div><div class="line">  username:"sample_app"</div><div class="line">  password:"secret_word"</div><div class="line">  host:"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</div><div class="line"></div><div class="line">process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ?'development<span class="string">'</span></div><div class="line"></div><div class="line">module.exports = config[process.env.NODE_ENV]</div><div class="line"></div></pre></td></tr></table></figure>
<p>This approach works, but looks kind of ugly. Since we’re using <code>coffee</code>, which provides the syntax sugar for class and class inheritance.<br>So we have the 3rd version:</p>
<figure class="highlight coffeescript"><figcaption><span>Class based configuration</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ? <span class="string">'development'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span></span></div><div class="line">  adapter: <span class="string">"mysql"</span></div><div class="line">  encoding: <span class="string">"utf8"</span></div><div class="line">  database: <span class="string">"sample_app_development"</span></div><div class="line">  username: <span class="string">"root"</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">development</span> <span class="keyword">extends</span> <span class="title">Config</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">test</span> <span class="keyword">extends</span> <span class="title">Config</span></span></div><div class="line">  database: <span class="string">"sample_app_test"</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">cucumber</span> <span class="keyword">extends</span> <span class="title">Config</span></span></div><div class="line">  database: <span class="string">"sample_app_cucumber"</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>.<span class="title">common</span> <span class="keyword">extends</span> <span class="title">Config</span></span></div><div class="line">  database: <span class="string">"sample_app_production"</span></div><div class="line">  username: <span class="string">"sample_app"</span></div><div class="line">  password: <span class="string">"secret_word"</span></div><div class="line">  host: <span class="string">"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> Config[process.env.NODE_ENV]()</div><div class="line"></div></pre></td></tr></table></figure>
<p>Now the code looks clean, and we can improve it a step further if necessary. We can try to separate the configurations into files, and required by the file name:</p>
<figure class="highlight coffeescript"><figcaption><span>Class based configuration</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># config/config.coffee</span></div><div class="line">configName = process.env.NODE_ENV = process.env.NODE_ENV?.toLowerCase() ? <span class="string">'development'</span></div><div class="line"></div><div class="line">SpecificConfig  = requrie(<span class="string">"./envs/<span class="subst">#&#123;configName&#125;</span>"</span>)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> SpecificConfig()</div><div class="line"></div><div class="line"><span class="comment"># config/envs/commmon.coffee</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Common</span></span></div><div class="line">  adapter: <span class="string">"mysql"</span></div><div class="line">  encoding: <span class="string">"utf8"</span></div><div class="line">  database: <span class="string">"sample_app_development"</span></div><div class="line">  username: <span class="string">"root"</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Common</div><div class="line"></div><div class="line"><span class="comment"># config/envs/development.coffee</span></div><div class="line">Common = <span class="built_in">require</span>(<span class="string">'./common'</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Development</span> <span class="keyword">extends</span> <span class="title">Common</span></span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Development</div><div class="line"></div><div class="line"><span class="comment"># config/envs/test.coffee</span></div><div class="line">Common = <span class="built_in">require</span>(<span class="string">'./common'</span>)  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">Common</span></span></div><div class="line">  database: <span class="string">"sample_app_test"</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Test</div><div class="line"></div><div class="line"><span class="comment"># config/envs/cucumber.coffee</span></div><div class="line">Test = <span class="built_in">require</span>(<span class="string">'./common'</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cucumber</span> <span class="keyword">extends</span> <span class="title">Test</span></span></div><div class="line">  database: <span class="string">"sample_app_cucumber"</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Cucumber</div><div class="line"></div><div class="line"><span class="comment"># config/envs/production.coffee</span></div><div class="line">Common = <span class="built_in">require</span>(<span class="string">'./common'</span>)  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Production</span> <span class="keyword">extends</span> <span class="title">Common</span></span></div><div class="line">  database: <span class="string">"sample_app_production"</span></div><div class="line">  username: <span class="string">"sample_app"</span></div><div class="line">  password: <span class="string">"secret_word"</span></div><div class="line">  host: <span class="string">"ec2-10-18-1-115.us-west-2.compute.amazonaws.com"</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Production</div><div class="line"></div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/" data-id="ciqg4g83d004e6nsij0bvucv0" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2013/02/22/manage-configuration-in-rails-way-on-node-js-by-using-inheritance/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/configuration/">configuration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/environment/">environment</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inheritance/">inheritance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/">rails</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scheme/">scheme</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pitfall-in-node-crypto-and-base64-encoding" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2013/01/30/pitfall-in-node-crypto-and-base64-encoding/" class="article-date">
  <time datetime="2013-01-30T00:00:00.000Z" itemprop="datePublished">2013-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2013/01/30/pitfall-in-node-crypto-and-base64-encoding/">Pitfall in node crypto and base64 encoding</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today, we found there is a huge pitfall in node.js crypto module! Decipher has potential problem when processing Base64 encoding.</p>
<p>We’re building RESTful web service based on Node.js, which talks to some other services implemented with Ruby.</p>
<h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p>In ruby, we use the default <code>Base64</code> class to handle Base64 encoding.</p>
<p><code>Base64#encode64</code> has a very interesting feature:<br>It add <code>line break (\n)</code> to output every 60 characters. This format make the output look pretty and be friendly for human reading:</p>
<figure class="highlight nginx"><figcaption><span>Ruby Base64 Block</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">MSwyLDMsNCw1LDYsNyw4LDksMTAsMTEsMTIsMTMsMTQsMTUsMTYsMTcsMTgs</span></div><div class="line">MTksMjAsMjEsMjIsMjMsMjQsMjUsMjYsMjcsMjgsMjksMzAsMzEsMzIsMzMs</div><div class="line">MzQsMzUsMzYsMzcsMzgsMzksNDAsNDEsNDIsNDMsNDQsNDUsNDYsNDcsNDgs</div><div class="line">NDksNTAsNTEsNTIsNTMsNTQsNTUsNTYsNTcsNTgsNTksNjAsNjEsNjIsNjMs</div><div class="line">NjQsNjUsNjYsNjcsNjgsNjksNzAsNzEsNzIsNzMsNzQsNzUsNzYsNzcsNzgs</div><div class="line">NzksODAsODEsODIsODMsODQsODUsODYsODcsODgsODksOTAsOTEsOTIsOTMs</div><div class="line">OTQsOTUsOTYsOTcsOTgsOTksMTAw</div></pre></td></tr></table></figure>
<p>The <code>Base64#decode64</code> class ignores the <code>line break (\n)</code> when parsing the base64 encoded data, so the <code>line break</code> won’t pollute the data.</p>
<h3 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h3><p>Node.js take <code>Base64</code> as one of the 5 standard encodings (<code>ascii</code>, <code>utf8</code>, <code>base64</code>, <code>binary</code>, <code>hex</code>). Ideally the data or string can be transcoded between these 4 encodings without data loss.</p>
<p>The <code>Buffer</code> class is the simplest way to transcode the data:</p>
<figure class="highlight coffeescript"><figcaption><span>Base64 Encoder in Node.js</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Base64 =</div><div class="line">  encode64: <span class="function"><span class="params">(text)</span> -&gt;</span></div><div class="line">    <span class="keyword">new</span> Buffer(text, <span class="string">'utf8'</span>).toString(<span class="string">'base64'</span>)</div><div class="line"></div><div class="line">  decode64: <span class="function"><span class="params">(base64)</span> -&gt;</span></div><div class="line">    <span class="keyword">new</span> Buffer(base64. <span class="string">'base64'</span>).toString(<span class="string">'utf8'</span>)</div><div class="line"></div></pre></td></tr></table></figure>
<p>Although <code>encode64</code> function in node.js won’t add <code>line break</code> to the output, but the <code>decode64</code> function does ignore the <code>line break</code> when parsing the data. It keeps the consistent behavior with ruby <code>Base64</code> class, so we can use this <code>decode64</code> function to decode the data from ruby.</p>
<p>Since <code>base64</code> is one of the standard encodings, and some of the node.js API does allow set encoding for input and output. So ideally, we can complete the base64 encoding and decoding during processing the data.<br>It seems Node.js is more convenient comparing to Ruby when dealing with <code>Base64</code>.</p>
<p>e.g. We can combine reading file and base64 encoding the content into one operation by setting the encoding to readFileSync API.</p>
<figure class="highlight coffeescript"><figcaption><span>Write and Read string as Base64</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line"></div><div class="line">fileName = <span class="string">'./binary.dat'</span> <span class="comment"># this file contains binary data</span></div><div class="line">base64 = fs.readFileSync(fileName, <span class="string">'base64'</span>) <span class="comment"># file content has been base64 encoded</span></div><div class="line"></div></pre></td></tr></table></figure>
<p>It looks like we can always use this trick to avoid manually base64 encoding and decoding when the API has encoding parameter! But actually it is not true! There is a BIG pitfall here!</p>
<p>In our real case, we uses <code>crypto</code> module to decrypt the the JSON document that encrypted and base64 encoded by Ruby:</p>
<figure class="highlight coffeescript"><figcaption><span>Base64 Deocde and Decrypt</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>)</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">parse</span> = <span class="params">(data, algorithm, key, iv)</span> -&gt;</div><div class="line">  decipher = crypto.createDecipheriv(algorithm, key, iv)</div><div class="line"></div><div class="line">  decrypted = decipher.update(data, <span class="string">'base64'</span>, <span class="string">'utf8'</span>) <span class="comment"># Set input encoding to 'base64' to ask API to base64 decode the input before decryption</span></div><div class="line">  decrypted += dechiper.final(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line">  JSON.parse(decrypted)</div><div class="line"></div></pre></td></tr></table></figure>
<figure class="highlight coffeescript"><figcaption><span>Manually Base64 Decoding</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>)</div><div class="line"><span class="function"></span></div><div class="line"><span class="title">parse</span> = <span class="params">(data, algorithm, key, iv)</span> -&gt;</div><div class="line">  decipher = crypto.createDecipheriv(algorithm, key, iv)</div><div class="line"></div><div class="line">  binary = <span class="keyword">new</span> Buffer(data,<span class="string">'base64'</span>) <span class="comment"># Manually Base64 Decode</span></div><div class="line"></div><div class="line">  decrypted = decipher.update(binary, <span class="string">'binary'</span>, <span class="string">'utf8'</span>) <span class="comment"># Set input encoding to 'binary'</span></div><div class="line">  decrypted += dechiper.final(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line">  JSON.parse(decrypted)</div><div class="line"></div></pre></td></tr></table></figure>
<p>The previous 2 implementations are very similar except the second one base64 decoded the data manually by using <code>Buffer</code>. Ideally they should be equivalent in behavior. But in fact, they are <strong>NOT</strong> equivalent!</p>
<p>The previous implementation throws “TypeError: DecipherFinal fail”.<br>And the reason is that the shortcut way doesn’t ignore the <code>line break</code>, but <code>Buffer</code> does!!! So in the previous implementation, the data is polluted by the <code>line break</code>!</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Be careful, when you try to ask the API to base64 decode the data by setting the encoding argument to ‘base64’. It has inconsistent behavior comparing to <code>Buffer</code> class.</p>
<p>I’m not sure whether it is a node.js bug, or it is as is by design. But it is indeed a pitfall that hides so deep. And usually is extremely hard to figure out. Since encrypted binary is hard to human to read, and debugging between 2 languages are also kind of hard!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2013/01/30/pitfall-in-node-crypto-and-base64-encoding/" data-id="ciqg4g83800456nsixvgqpez1" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2013/01/30/pitfall-in-node-crypto-and-base64-encoding/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/base64/">base64</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/buffer/">buffer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/crypto/">crypto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/decipher/">decipher</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/encoding/">encoding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pitfall/">pitfall</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/" class="article-date">
  <time datetime="2012-11-15T00:00:00.000Z" itemprop="datePublished">2012-11-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/">Pitfall in fs.watch: fs.watch fails when switch from TextMate to RubyMine</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m writing a cake script that helps me to build the growlStyle bundle.<br>And I wish to my script can watch the change of the source file, and rebuild when file changed.<br>So I wrote the code as following:</p>
<figure class="highlight coffeescript"><figcaption><span>Watching code change</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">files = fs.readdirSync getLocalPath(<span class="string">'source'</span>)</div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files</div><div class="line">  fs.watch file, <span class="function">-&gt;</span></div><div class="line">    <span class="built_in">console</span>.log <span class="string">"File changed, rebuilding..."</span></div><div class="line">    build()</div></pre></td></tr></table></figure>
<p>The code works when I edits the code with TextMate, but fails when I uses RubyMine!</p>
<p>Super weird!</p>
<p>After half an hour debugging, I found the following interesting phenomena:</p>
<ul>
<li><p>Given I’m using TextMate<br>When I changed the file 1st time<br>Then a ‘change’ event is captured<br>When I changed the file 2nd time<br>Then a ‘change’ event is captured<br>When I changed the file 3rd time<br>Then a ‘change’ event is captured</p>
</li>
<li><p>Given I’m using RubyMine<br>When I change the file 1st time<br>Then a ‘rename’ event is captured<br>When I changed the file 2nd time<br>Then no event is captured<br>When I changed the file 3rd time<br>Then no event is captured</p>
</li>
</ul>
<p>From the result, we can easily find out that the script fails is because “change” event is not triggered as expected when using RubyMine.<br>And the reason of RubyMine’s “wried” behavior might be that RubyMine what to keep the file integrity so they “write” the file in an atomic way as following:</p>
<ol>
<li>RubyMine write the file content to a temp file</li>
<li>RubyMine remove the original file</li>
<li>RubyMine rename the temp file to original file</li>
</ol>
<p>This workflow ensures that the content is fully written or not written. So in a word, RubyMine does not actually write the file, it actually replace the original file with another one, and the original one is removed or stored to some special location.</p>
<p>And on the other hand, according to Node.js document of <code>fs.watch</code>, node uses <code>kqueue</code> on Mac to implement this behavior.<br>And according to <code>kqueue</code> document, it uses <code>file descriptor</code> as identifier, and <code>file descriptor</code> is bound to the file itself rather than its path. So when the file is renamed, we will keep to track the file with new name. That’s why we lost the status of the file after the first ‘rename’ event.<br>And in our case, we actually wish to identify the file by file path rather than by ‘file descriptor’.</p>
<p>To solve this issue, we have 2 potential solutions:</p>
<ol>
<li><p>Also apply <code>fs.watch</code> to the directory that holds the source file besides of the source file itself.<br>When the file is directly updated as TextMate does, the watcher on the file will raise the “change” event.<br>When the file is atomically updated as RubyMine does, the watcher on the directory will raise 2 “rename” events.<br>So theoretically, we could track the change of the file no matter how it is updated.</p>
</li>
<li><p>Use the old fashioned <code>fs.watchFile</code> function, which tracks the change the with <code>fs.stat</code>.<br>Comparing to <code>fs.watch</code>, <code>fs.watchFile</code> is less efficient because its polling mechanism, but it does track the file with file name rather than <code>file descriptor</code>. So it won’t be charmed by the fancy atomic writing.</p>
</li>
</ol>
<p>Obviously, the 1st solution looks better than the 2nd one, because its uses the <code>event</code> rather than old-fashioned <code>polling</code>. Even document of <code>fs.watchFile</code> also says that try to use <code>fs.watch</code> instead of <code>fs.watchFile</code> when possible.</p>
<p>But actually it is kind of painful to write such code, since ‘rename’ event on the directory is not only triggered by the file update, it also can be triggered by adding file and removing file.</p>
<p>And the ‘rename’ event will be triggered twice when updating the file. Obviously we cannot rebuild the code when the first ‘rename’ event fired, or the build might fail because of the absence of the file. And we will trigger the build twice in a really short period of time.</p>
<p>So in fact, to solve our problem, the polling <code>fs.watchFile</code> is more useful, its old-fashion protected itself being charmed by the ‘fancy’ atomic file writing.</p>
<p>So finally, we got the following code:<br><figure class="highlight coffeescript"><figcaption><span>fs.watchFile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">runInWatch</span> = <span class="params">(options, task)</span> -&gt;</span></div><div class="line">  action(options) <span class="keyword">unless</span> options.watch</div><div class="line">  <span class="built_in">console</span>.info <span class="string">"INFO: Watching..."</span></div><div class="line">  files = fs.readdirSync getLocalPath(<span class="string">'source'</span>)</div><div class="line">  <span class="built_in">console</span>.log <span class="string">'"Tracking files:'</span></div><div class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> files</div><div class="line">    <span class="built_in">console</span>.log <span class="string">"<span class="subst">#&#123;file&#125;</span>"</span></div><div class="line">    fs.watchFile getLocalPath(<span class="string">'source'</span>, file), <span class="function"><span class="params">(current, previous)</span> -&gt;</span></div><div class="line">      <span class="keyword">unless</span> current.mtime == previous.mtime</div><div class="line">        <span class="built_in">console</span>.log <span class="string">"<span class="subst">#&#123;file&#125;</span> Changed..."</span></div><div class="line">        task(options)</div></pre></td></tr></table></figure></p>
<p><strong>HINT:</strong> Be careful about the differens of fs.watch and fs.watchFile:</p>
<ul>
<li>The meaning of <code>filename</code> parameter<br><strong> The <code>filename</code> parameter of <code>fs.watch</code> is path sensitive, which accept ‘source.jade’ or ‘/path/to/source.jade’
</strong> The <code>filename</code> parameter of <code>fs.watchFile</code> isn’t path sensitive, which only accept ‘/path/to/source.jade’</li>
<li>Callback is invocation condition<br><strong> <code>fs.watch</code> invokes callback when the file is renamed or changed
</strong> <code>fs.watchFile</code> invokes callback when the file is accessed, including write and read.<br>So you need to compare the mtime of the <code>fstat</code>, file is changed when mtime changed.</li>
<li>Response time<br><strong> <code>fs.watch</code> uses <code>event</code>, which captures the “change” almost in realtime.
</strong> <code>fs.watchFile</code> uses ‘polling’, which might differed for a period of time. By default, the maximum could be 5s.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/" data-id="ciqg4g833003p6nsiavqg0rvl" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/11/15/pitfall-in-fs-watch-fs-watch-fails-when-switch-from-textmate-to-rubymine/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fswatcher/">FSWatcher</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/change/">change</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/editor/">editor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fs-watch/">fs.watch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby-mine/">ruby mine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/watch/">watch</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-exports-vs-module-exports-in-node-js" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/04/20/exports-vs-module-exports-in-node-js/" class="article-date">
  <time datetime="2012-04-20T00:00:00.000Z" itemprop="datePublished">2012-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/04/20/exports-vs-module-exports-in-node-js/">exports vs module.exports in node.js</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I was confused about how require function works in node.js for a long time. I found when I require a module, sometimes I can get the object I want, but sometimes, I don’t I just got an empty object, which give an <a href="/blog/2012/03/21/a-way-to-expose-singleton-object-and-its-constructor-in-nodejs">imagination</a> that we cannot export the object by assigning it to exports, but it seems somehow we can export a function by assignment.</p>
<p>Today, I re-read the <a href="http://docs.nodejs.org/api/modules.html#modules_the_module_object" target="_blank" rel="external">document</a> again, and I finally make clear that I misunderstood the “require” mechanism and how I did that.</p>
<p>I clearly remember this sentence in the <a href="http://docs.nodejs.org/api/modules.html#modules_the_module_object" target="_blank" rel="external">doc</a></p>
<blockquote>
<p> In particular <strong>module.exports</strong> is the <strong>same</strong> as the <strong>exports</strong> object.</p>
</blockquote>
<p>So I believed that the exports is just a shortcut alias to module.exports, we can use one instead of another without worrying about the differences between them two.<br>But this understanding is proved to be wrong. exports and module.exports are different.</p>
<p>Today I found this in the <a href="http://docs.nodejs.org/api/modules.html#modules_module_exports" target="_blank" rel="external">doc</a>:</p>
<blockquote>
<p>The <strong>exports</strong> object is <strong>created by</strong> the <strong>Module system</strong>. Sometimes this is <strong>not acceptable</strong>, many want their module to be an instance of some class. <strong>To do this assign the desired export object to module.exports.</strong></p>
</blockquote>
<p>So it says that module.exports is different from exports. And it you exports something by assignment, you need to assign it to module.exports.</p>
<p>Let’s try to understand these sentences deeper by code examples.</p>
<p>In the saying</p>
<blockquote>
<p>The <strong>exports</strong> object is <strong>created by</strong> the <strong>Module system</strong>.</p>
</blockquote>
<p>The word “created by” actually means when node.js try to load a javascript file, before executing any line of code in your file, the module system executes the following code first for you:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> exports = <span class="built_in">module</span>.exports</div></pre></td></tr></table></figure>
<p>So the actual interface in node.js’s module system is module object. the actual exported object is <code>module.exports</code> not <code>exports</code>.<br>And the <code>exports</code> is just a normal variable, and there is not “magic” in it. So if you assign something to it, it is replaced absolutely.</p>
<p>That’s why I failed to get the exported object I want when I assign the it to exports variable.</p>
<p>So to export some variable as a whole, we should always assign it to <code>module.exports</code>.<br>And at same time, if there is no good excuse, we’d better to keep the convention that <code>exports</code> is the shortcut alias to <code>module.exports</code>. So we should also assign the module.exports to exports.</p>
<p>As a conclusion, to export something in node.js by assignment, we should always follow the following pattern:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">exports = <span class="built_in">module</span>.exports = &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/04/20/exports-vs-module-exports-in-node-js/" data-id="ciqg4g81z001p6nsizbfhn3pu" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/04/20/exports-vs-module-exports-in-node-js/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exports/">exports</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/module/">module</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-way-to-expose-singleton-object-and-its-constructor-in-node-js" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2012/03/21/a-way-to-expose-singleton-object-and-its-constructor-in-node-js/" class="article-date">
  <time datetime="2012-03-21T00:00:00.000Z" itemprop="datePublished">2012-03-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">Programming</a>►<a class="article-category-link" href="/categories/programming/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
  
  <div class="ribbon-wrapper relative right">
    <div class="ribbon "  style="background-color: #40A;"  >
      <a href="http://timnew.me/categories/programming/">Programming</a>
    </div>
  </div>


    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2012/03/21/a-way-to-expose-singleton-object-and-its-constructor-in-node-js/">A way to expose singleton object and its constructor in node.js</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In <a href="nodejs.org">Node.js</a> world, we usually encapsulate a service into a module, which means the module need to export the façade of the service. In most case the service could be a singleton, all apps use the same service.</p>
<p>But in some rare cases, people might would like to create several instances of the service ,which means the module also need to also export the service constructor.</p>
<p>A very natural idea is to export the default service, and expose the constructor as a method of the default instance. So we could consume the service in this way:</p>
<figure class="highlight js"><figcaption><span>Ideal Usage</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defaultService = <span class="built_in">require</span>(<span class="string">'service'</span>);</div><div class="line"><span class="keyword">var</span> anotherService = service.newService();</div></pre></td></tr></table></figure>
<p>So we need to write the module in this way:</p>
<figure class="highlight js"><figcaption><span>Ideal Export</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Service</span>(<span class="params"></span>) </span>&#123; &#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> Service();</div><div class="line">moudle.exports.newService = Service;</div><div class="line"></div></pre></td></tr></table></figure>
<p><del>But for some reason, node.js doesn’t allow module to expose object by assigning the a object to module.exports.<br>To export a whole object, it is required to copy all the members of the object to <code>moudle.exports</code>, which drives out all kinds of tricky code.</del><br><ins>I misunderstood how node.js require works, and <a href="/blog/2012/04/20/exports_vs_module_exports_in_node_js">HERE</a> is the right understanding. Even I misunderstood the mechanism, but the conclusion of this post is still correct. To export function is still a more convenient way to export both default instance and the constructor.</ins></p>
<p>And things can become much worse when there are backward reference from the object property to itself.<br>So to solve this problem gracefully, we need to change our mind.<br>Since it is proved that it is tricky to export a object, can we try to expose the constructor instead?</p>
<p>Then answer is yes. And Node.js does allow we to assign a function to the module.exports to exports the function.<br>So we got this code.</p>
<figure class="highlight js"><figcaption><span>Export Constructor</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Service</span>(<span class="params"></span>) </span>&#123; &#125;</div><div class="line"><span class="built_in">module</span>.exports = Service;</div></pre></td></tr></table></figure>
<p>So we can use create service instance in this way:</p>
<figure class="highlight js"><figcaption><span>Create Service</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Service = <span class="built_in">require</span>(<span class="string">'service'</span>);</div><div class="line"><span class="keyword">var</span> aService = <span class="keyword">new</span> Service();</div></pre></td></tr></table></figure>
<p>As you see, since the one we exported is constructor so we need to create a instance manually before we can use it. Another problem is that we lost the shared instance between module users, and it is a common requirement to share the same service instance between users.</p>
<p>How to solve this problem? Since as we know, function is also kind of object in javascript, so we can kind of add a member to the constructor called default, which holds the shared instance of the service.</p>
<p>This solution works but not in a graceful way! A crazy but fancy idea is that can we transform the constructor itself into kind of singleton instance??!! Which means you can do this:</p>
<figure class="highlight js"><figcaption><span>Export Singleton</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defaultService = <span class="built_in">require</span>(<span class="string">'service'</span>);</div><div class="line">defaultService.foo();</div><div class="line"><span class="keyword">var</span> anotherService = service();</div><div class="line">anotherService.foo();</div></pre></td></tr></table></figure>
<p>The code style looks familiar? Yes, jQuery, and many other well-designed js libraries are designed to work in this way.<br>So our idea is kind of feasible but how?</p>
<p>Great thank to Javascript’s prototype system (or maybe SELF’s prototype system is more accurate.), we can simply make a service instance to be the constructor’s prototype.</p>
<figure class="highlight js"><figcaption><span>Actual Export</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Service</span>(<span class="params"></span>) </span>&#123; &#125;</div><div class="line"><span class="built_in">module</span>.exports = Service;</div><div class="line">Service.__proto__ = <span class="keyword">new</span> Serivce;</div></pre></td></tr></table></figure>
<p>Sounds crazy, but works, and gracefully! That’s the beauty of Javascript.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://timnew.me/blog/2012/03/21/a-way-to-expose-singleton-object-and-its-constructor-in-node-js/" data-id="ciqg4g81h00106nsiazq479e7" class="article-share-link">Share</a>
      
        <a href="http://timnew.me/blog/2012/03/21/a-way-to-expose-singleton-object-and-its-constructor-in-node-js/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exports/">exports</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js-hack/">js hack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/module/">module</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node-js/">node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pattern/">pattern</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/singleton/">singleton</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap"><h3 class="widget-title">About Me</h3><div class="widget self-intro"><img src="/images/avatar.png"/><p>Tim is</p><ul class="description"><li>a<span>geek</span></li><li>an spare-time<span>web developer</span></li><li>a part-time<span>mobile developer</span></li><li>a night-time<span>photographer</span></li><li>an early-time<span>pcb solderer</span></li></ul><ul class="social-links"><li><a href="https://linkedin.com/in/timwen" target="_blank" class="linked-in"></a></li><li><a href="https://twitter.com/timnew" target="_blank" class="twitter"></a></li><li><a href="https://github.com/timnew" target="_blank" class="github"></a></li></ul></div></div>
  
    
  <div class="widget-wrap">
    <a href="/posts">
      <h3 class="widget-title">Recent Posts</h3>
    </a>
    <div class="widget recent-posts">
      <ul>
        
          <li>
            <a href="/blog/2016/04/23/collection-filtering-algorithm-with-bit-operation-part-1/">Collection Filtering Algorithm with Bit Operation - Part.1</a>
          </li>
        
          <li>
            <a href="/blog/2015/08/14/a-clean-way-to-test-rejected-promise/">A clean way to test rejected promise</a>
          </li>
        
          <li>
            <a href="/blog/2014/12/06/typical-eventbus-design-patterns/">Typical EventBus Design Patterns</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/09/understand-styles-in-android-part-1-what-it-is-for-and-how-to-used-it/">Understand Styles in Android - Part 1. What it is for and how to used it</a>
          </li>
        
          <li>
            <a href="/blog/2014/11/07/walkthrough-untrusted-the-continuing-adventures-of-dr-eval/">Walkthrough: Untrusted - the Continuing Adventures of Dr. Eval</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/tags">
      <h3 class="widget-title">Tag Cloud</h3>
    </a>
    <div class="widget tagcloud">
      <a href="/tags/net/" style="font-size: 10px;">.net</a> <a href="/tags/alfred/" style="font-size: 10px;">Alfred</a> <a href="/tags/algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/android-studio/" style="font-size: 10px;">Android Studio</a> <a href="/tags/automation/" style="font-size: 10px;">Automation</a> <a href="/tags/binary/" style="font-size: 10px;">Binary</a> <a href="/tags/bit-operation/" style="font-size: 10px;">Bit Operation</a> <a href="/tags/bit-slicer/" style="font-size: 10px;">Bit Slicer</a> <a href="/tags/bloom-filter/" style="font-size: 10px;">Bloom Filter</a> <a href="/tags/boilerplate/" style="font-size: 10px;">Boilerplate</a> <a href="/tags/c/" style="font-size: 20px;">C#</a> <a href="/tags/ci/" style="font-size: 15px;">CI</a> <a href="/tags/css/" style="font-size: 10px;">CSS</a> <a href="/tags/cheat/" style="font-size: 10px;">Cheat</a> <a href="/tags/cheat-engine/" style="font-size: 10px;">Cheat Engine</a> <a href="/tags/class/" style="font-size: 10px;">Class</a> <a href="/tags/cocoa/" style="font-size: 10px;">Cocoa</a> <a href="/tags/collection/" style="font-size: 10px;">Collection</a> <a href="/tags/command/" style="font-size: 10px;">Command</a> <a href="/tags/continues-delivery/" style="font-size: 10px;">Continues Delivery</a> <a href="/tags/continues-integration/" style="font-size: 10px;">Continues Integration</a> <a href="/tags/crack/" style="font-size: 10px;">Crack</a> <a href="/tags/d/" style="font-size: 10px;">D</a> <a href="/tags/debugger/" style="font-size: 10px;">Debugger</a> <a href="/tags/deploy/" style="font-size: 10px;">Deploy</a> <a href="/tags/deployment/" style="font-size: 10px;">Deployment</a> <a href="/tags/design/" style="font-size: 10px;">Design</a> <a href="/tags/design-pattern/" style="font-size: 10px;">Design Pattern</a> <a href="/tags/event/" style="font-size: 10px;">Event</a>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/categories">
      <h3 class="widget-title">Categories</h3>
    </a>
    <div class="widget category-list">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/">Cracking</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cracking/game/">Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/">Design</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/design/visual/">Visual</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design/web/">Web</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/game/">Game</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/game/programming-game/">Programming Game</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/geek-toy/">Geek Toy</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/">Package</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/package/chrome-extension/">Chrome Extension</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/package/hexo/">Hexo</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/">Practice</a><span class="category-list-count">22</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/practice/atom/">Atom</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/continues-integration/">Continues Integration</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/devops/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/mac/">Mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/textmate/">TextMate</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/windows/">Windows</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/practice/git/">git</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">Programming</a><span class="category-list-count">73</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/algorithm/">Algorithm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/android/">Android</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/arduino/">Arduino</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/c/">C#</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/design-patterns/">Design Patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/">JavaScript</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/coffeescript/">CoffeeScript</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/postgressql/">PostgresSql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/powershell/">PowerShell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/regular-expression/">Regular Expression</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/ruby/">Ruby</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/shell/">Shell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/wpf/">WPF</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/web/">Web</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/node-js/">node.js</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/thinking/">Thinking</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <a href="/archives">
      <h3 class="widget-title">Archives</h3>
    </a>
    <div class="widget archive-list">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09/">September 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 TimNew<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/#main" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/photos/500px.html" class="mobile-nav-link">Photos</a>
  
</nav>
    
<script>
  var disqus_shortname = 'timnew-github';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>